C51 COMPILER V9.59.0.0   DQIOT_DRV_AUDIO                                                   02/19/2021 17:34:39 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE DQIOT_DRV_AUDIO
OBJECT MODULE PLACED IN .\output\dqiot_drv_audio.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE source\dqiot_drv_audio.c LARGE OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\in
                    -clude;.\Library\byd_standard_peripheral\include;.\byd_api\byd_key\include;.\byd_api\byd_mifare\include;.\byd_tool_comm;.
                    -\byd_rfid;.\mmi_inc) DEBUG PRINT(.\list\dqiot_drv_audio.lst) TABS(2) OBJECT(.\output\dqiot_drv_audio.obj)

line level    source

   1          #ifndef __DQIOT_DRV_AUDIO_C__
   2          #define __DQIOT_DRV_AUDIO_C__
   3          
   4          #include "dqiot_drv.h"
   5          #include "dqiot_drv_audio.h"
   6          #include "delay.h"
   7          
   8          #define AUDIO_IN_BUSY           gpio_bit_get(AUD_BUSY_PORT,AUD_BUSY_PIN)
   9          
  10          #define AUDIO_OUT_RST_LO        gpio_bit_reset(AUD_RST_PORT,AUD_RST_PIN)
  11          #define AUDIO_OUT_RST_HI        gpio_bit_set(AUD_RST_PORT,AUD_RST_PIN)
  12          
  13          #define AUDIO_OUT_DATA_LO       gpio_bit_reset(AUD_DATA_PORT,AUD_DATA_PIN)
  14          #define AUDIO_OUT_DATA_HI       gpio_bit_set(AUD_DATA_PORT,AUD_DATA_PIN)
  15          #define AUDIO_OUT_DATA_Toggle   gpio_bit_get(AUD_DATA_PORT,AUD_DATA_PIN) ? gpio_bit_reset(AUD_DATA_PORT,AU
             -D_DATA_PIN) : gpio_bit_set(AUD_DATA_PORT,AUD_DATA_PIN)
  16          
  17          uint8_t audio_flag=0; // 
  18          uint8_t audio_section=0,audio_time_count=0;
  19          #define AUDIO_MAX_CACHE_NUM   20
  20          static uint8_t audio_cache[AUDIO_MAX_CACHE_NUM] = {0};
  21          
  22          static uint8_t audio_play_end_flag = 0;
  23          /*
  24          parameter: 
  25            none
  26          return :
  27            none
  28          */
  29          void dqiot_drv_audio_gpio_init(void)
  30          {
  31   1        gpio_init(AUD_BUSY_PORT,AUD_BUSY_PIN,GPIO_MODE_IPU);
  32   1      
  33   1        gpio_init(AUD_DATA_PORT,AUD_DATA_PIN,GPIO_MODE_OUT);
  34   1        gpio_bit_reset(AUD_DATA_PORT,AUD_DATA_PIN);
  35   1      
  36   1        gpio_init(AUD_RST_PORT,AUD_RST_PIN,GPIO_MODE_OUT);
  37   1        gpio_bit_set(AUD_RST_PORT,AUD_RST_PIN);
  38   1        
  39   1        return;
  40   1      }
  41          
  42          /*
  43          parameter: 
  44            none
  45          return :
  46            none
  47          */
  48          void dqiot_drv_audio_gpio_deinit(void)
  49          {
  50   1        gpio_init(AUD_BUSY_PORT,AUD_BUSY_PIN,GPIO_MODE_IN_FLOATING);
  51   1        gpio_bit_reset(AUD_BUSY_PORT,AUD_BUSY_PIN);
  52   1        
C51 COMPILER V9.59.0.0   DQIOT_DRV_AUDIO                                                   02/19/2021 17:34:39 PAGE 2   

  53   1        gpio_init(AUD_DATA_PORT,AUD_DATA_PIN,GPIO_MODE_IN_FLOATING);
  54   1        gpio_bit_reset(AUD_DATA_PORT,AUD_DATA_PIN);
  55   1      
  56   1        gpio_init(AUD_RST_PORT,AUD_RST_PIN,GPIO_MODE_IN_FLOATING);
  57   1        gpio_bit_reset(AUD_RST_PORT,AUD_RST_PIN);
  58   1        
  59   1        return;
  60   1      }
  61          
  62          
  63          /*
  64          parameter: 
  65            none
  66          return :
  67            none
  68          */
  69          void dqiot_drv_audio_init(void)
  70          {
  71   1        dqiot_drv_timer0_init(200);
  72   1        return;
  73   1      }
  74          
  75          
  76          /*
  77          parameter: 
  78            none
  79          return :
  80            none
  81          */
  82          uint8_t dqiot_drv_audio_play(uint8_t play_setion)
  83          {
  84   1        unsigned char i = 0;
  85   1        if(audio_flag == 0 && AUDIO_IN_BUSY == 1)
  86   1        { 
  87   2          audio_flag = 1;
  88   2          audio_section = play_setion;
  89   2          audio_time_count = 0;
  90   2          dqiot_drv_timer0_start();
  91   2        }
  92   1        else
  93   1        {
  94   2          char i = 0;
  95   2          for(i=0;i<AUDIO_MAX_CACHE_NUM;i++)
  96   2          {
  97   3            if(audio_cache[i]==0)
  98   3              break;
  99   3          }
 100   2          if(i<AUDIO_MAX_CACHE_NUM)
 101   2            audio_cache[i]=play_setion;
 102   2        }
 103   1          
 104   1        return 1;
 105   1      }
 106          
 107          /*
 108          parameter: 
 109            none
 110          return :
 111            none
 112          */
 113          void dqiot_drv_audio_stop(void)
 114          {
C51 COMPILER V9.59.0.0   DQIOT_DRV_AUDIO                                                   02/19/2021 17:34:39 PAGE 3   

 115   1        char i = 0;
 116   1      
 117   1        if( audio_flag == 0&&AUDIO_IN_BUSY == 1)
 118   1          return;
 119   1      
 120   1        dqiot_drv_timer0_stop();
 121   1      
 122   1        for(i=0;i<AUDIO_MAX_CACHE_NUM;i++)
 123   1        {
 124   2          audio_cache[i]=0;
 125   2        }
 126   1      
 127   1        if(audio_time_count>=4)
 128   1        {
 129   2          audio_section = 0;
 130   2          audio_flag = 3;
 131   2          audio_time_count = 0;
 132   2        }
 133   1        else
 134   1        {
 135   2          audio_section = 0;
 136   2          audio_flag = 3;
 137   2        }
 138   1          
 139   1          dqiot_drv_timer0_start();
 140   1        return;
 141   1      }
 142          
 143          /*
 144          parameter: 
 145            none
 146          return :
 147            none
 148          */
 149          uint8_t dqiot_drv_audio_check_busy(void)
 150          {
 151   1        return AUDIO_IN_BUSY;
 152   1      }
 153          
 154          /*
 155          parameter: 
 156            none
 157          return :
 158            none
 159          */
 160          uint8_t dqiot_drv_audio_get_state(void)
 161          {
 162   1        return audio_flag;
 163   1      }
 164          
 165          /*
 166          parameter: 
 167            none
 168          return :
 169            none
 170          */
 171          uint8_t dqiot_drv_audio_get_section(void)
 172          {
 173   1        return audio_section;
 174   1      }
 175          
 176          /*
C51 COMPILER V9.59.0.0   DQIOT_DRV_AUDIO                                                   02/19/2021 17:34:39 PAGE 4   

 177          parameter: 
 178            none
 179          return :
 180            none
 181          */
 182          uint8_t dqiot_drv_audio_get_end_flag(void)
 183          {
 184   1        if(audio_play_end_flag == 1)
 185   1        {
 186   2          audio_play_end_flag = 0;
 187   2          return 1;
 188   2        }
 189   1        return 0;
 190   1      } 
 191          
 192          
 193          /*
 194          parameter: 
 195            none
 196          return :
 197            none
 198          */
 199          void Audio_Select_Handle_in_Timer(void)
 200          {
 201   1        if(audio_flag == 1)
 202   1        {
 203   2          if(audio_time_count == 0)
 204   2          {
 205   3            AUDIO_OUT_RST_HI;
 206   3            AUDIO_OUT_DATA_LO;
 207   3          }
 208   2          else if(audio_time_count == 2)
 209   2          {
 210   3            AUDIO_OUT_RST_LO;
 211   3          }
 212   2          else if(audio_time_count >= 4)
 213   2          {
 214   3            //if(audio_time_count%2 == 0)
 215   3            //  AUDIO_OUT_DATA_HI;
 216   3            //else
 217   3            //  AUDIO_OUT_DATA_LO;
 218   3            PA0 = ~PA0;
 219   3          }
 220   2          audio_time_count ++;
 221   2      
 222   2          if(audio_time_count >= (audio_section + 1) * 2 + 4)
 223   2          {
 224   3            audio_time_count = 0;
 225   3            AUDIO_OUT_RST_LO;
 226   3            AUDIO_OUT_DATA_LO;
 227   3            audio_flag = 2;
 228   3          }
 229   2        }
 230   1        else if(audio_flag == 3)
 231   1        {
 232   2          if(audio_time_count == 0)
 233   2          {
 234   3            AUDIO_OUT_DATA_LO;
 235   3          } 
 236   2          else if(audio_time_count == 1)
 237   2          {
 238   3            AUDIO_OUT_RST_HI;
C51 COMPILER V9.59.0.0   DQIOT_DRV_AUDIO                                                   02/19/2021 17:34:39 PAGE 5   

 239   3          }
 240   2          else if(audio_time_count == 3)
 241   2          {
 242   3            AUDIO_OUT_RST_LO;
 243   3          }
 244   2          audio_time_count ++;
 245   2          if(audio_time_count >= 4)
 246   2          {
 247   3            audio_time_count = 0;
 248   3            AUDIO_OUT_RST_LO;
 249   3            AUDIO_OUT_DATA_LO;
 250   3            audio_flag = 2;
 251   3          }
 252   2          
 253   2        }
 254   1      
 255   1      }
 256          
 257          /*
 258          parameter: 
 259            none
 260          return :
 261            none
 262          */
 263          void timer0_event_handler(void)
 264          {
 265   1        if((audio_flag == 2)&&(AUDIO_IN_BUSY == 1))
 266   1        {
 267   2          //extern void mmi_dq_sys_aud_end(void);
 268   2          if(audio_cache[0]==0)
 269   2          {
 270   3            audio_section = 0;
 271   3            dqiot_drv_timer0_stop();
 272   3            //mmi_dq_sys_aud_end();
 273   3            audio_play_end_flag = 1;
 274   3            audio_flag = 0;
 275   3          }
 276   2          else
 277   2          {
 278   3            char i = 0;
 279   3            audio_flag = 1;
 280   3            audio_section = audio_cache[0];
 281   3            for(i=0;i<AUDIO_MAX_CACHE_NUM-1;i++)
 282   3            {
 283   4              if(audio_cache[i+1]!=0)
 284   4              {
 285   5                audio_cache[i]=audio_cache[i+1];
 286   5              }
 287   4              else
 288   4                break;
 289   4            }
 290   3            audio_cache[i]=0;
 291   3            audio_time_count = 0;
 292   3          }
 293   2        }
 294   1        else
 295   1          Audio_Select_Handle_in_Timer();
 296   1      }
 297          
 298          
 299          #endif//__DQIOT_DRV_AUDIO_C__
 300          
C51 COMPILER V9.59.0.0   DQIOT_DRV_AUDIO                                                   02/19/2021 17:34:39 PAGE 6   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    740    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     28       5
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
