C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE MMI_MS
OBJECT MODULE PLACED IN .\output\mmi_ms.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE mmi_src\mmi_ms.c LARGE OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\include;.\
                    -Library\byd_standard_peripheral\include;.\byd_api\byd_key\include;.\byd_api\byd_mifare\include;.\byd_tool_comm;.\byd_rfi
                    -d;.\mmi_inc) DEBUG PRINT(.\list\mmi_ms.lst) TABS(2) OBJECT(.\output\mmi_ms.obj)

line level    source

   1          #ifndef __MMI_MS_C__
   2          #define __MMI_MS_C__
   3          
   4          #include "string.h"
   5          #include "mmi_ms.h"
   6          #include "mmi_key.h"
   7          #include "mmi_sys.h"
   8          #include "mmi_audio.h"
   9          #include "mmi_fps.h"
  10          #include "mmi_rfid.h"
  11          #include "mmi_com.h"
  12          #include "mmi_fs.h"
  13          #include "mmi_rst.h"
  14          #include "dqiot_drv.h"
  15          #include "delay.h"
  16          #include "mmi_fs.h"
  17          #include "mmi_fm.h"
  18          #include "mmi_wifi.h"
  19          #include "dqiot_drv_wifi.h"
  20          #include <stdio.h>
  21          
  22          unsigned char input_key_1[KEY_INPUT_MAX_LEN];
  23          unsigned char input_key_2[KEY_INPUT_MAX_LEN];
  24          unsigned char key_len = 0;
  25          OPERATE_TIME opt_time = OPT_TIME_INVALID;
  26          static SYS_BASE_STATUS data sys_state = SYS_STATUS_INVALID;
  27          
  28          static unsigned char data key_last_value = KEY_INVALID;
  29          #ifdef __LOCK_RFID_CARD_SUPPORT__
  30          static unsigned char rfid_last_flag = 0;
  31          #endif
  32          #ifdef __LOCK_BUS_SUPPORT__
  33          static unsigned char admin_check_type = 0;
  34          #endif
  35          
  36          // extern void printfS(char *show, char *status);
  37          // extern void printfV(char *show, int value);
  38          
  39          /*
  40          parameter: 
  41            none
  42          return :
  43            none
  44          */
  45          void mmi_task_proc(void)
  46          {
  47   1        unsigned char touch_value = 0xFF;
  48   1        unsigned char key_value = KEY_INVALID;
  49   1      
  50   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
  51   1        if (mmi_dq_sys_get_rfid_flag() == 1)
  52   1        {
  53   2          //check rfid press
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 2   

  54   2          if (mmi_dq_rfid_check() == RET_SUCESS)
  55   2          {
  56   3            if (mmi_dq_rfid_work() == RET_SUCESS)
  57   3            {
  58   4              if (rfid_last_flag == 0)
  59   4              {
  60   5                rfid_last_flag = 1;
  61   5                mmi_dq_ms_set_msg_que(QUE_EVENT_RFID, QUE_PRO_LOW, 0);
  62   5              }
  63   4            }
  64   3            else
  65   3            {
  66   4              rfid_last_flag = 0;
  67   4            }
  68   3          }
  69   2        }
  70   1      #endif
  71   1        //check key press
  72   1        touch_value = mmi_dq_key_work();
  73   1        if (touch_value != 0xFF)
  74   1        {
  75   2          key_value = mmi_dq_get_key_map(touch_value);
  76   2          if (key_value != KEY_INVALID)
  77   2          {
  78   3            if (key_last_value != key_value)
  79   3            {
  80   4              key_last_value = key_value;
  81   4              mmi_dq_ms_set_msg_que(QUE_EVENT_KEY, QUE_PRO_LOW, key_value);
  82   4            }
  83   3          }
  84   2          else
  85   2            key_last_value = KEY_INVALID;
  86   2        }
  87   1        else
  88   1          key_last_value = KEY_INVALID;
  89   1      
  90   1        if (mmi_dq_aud_get_end_flag() != 0)
  91   1          mmi_dq_ms_set_msg_que(QUE_EVENT_AUDIO_END, QUE_PRO_LOW, 0);
  92   1      
  93   1        if (mmi_dq_rst_get_state() != 0)
  94   1          mmi_dq_ms_set_msg_que(QUE_EVENT_RST, QUE_PRO_LOW, 0);
  95   1      
  96   1        if (mmi_dq_sys_get_timer2_flag() != 0)
  97   1          mmi_dq_ms_set_msg_que(QUE_EVENT_TIMER_END, QUE_PRO_LOW, 0);
  98   1      
  99   1      #ifdef __LOCK_FP_SUPPORT__
                  //check fp press
                  // if (mmi_dq_fp_work() != 0)
                  //  mmi_dq_ms_set_msg_que(QUE_EVENT_FP, QUE_PRO_LOW, 0);
              #endif
 104   1      
 105   1        if (mmi_dq_sys_get_wifi_check_flag() != 0)
 106   1          mmi_dq_ms_set_msg_que(QUE_EVENT_WIFI_CHECK, QUE_PRO_LOW, 0);
 107   1      
 108   1        return;
 109   1      }
 110          
 111          /*
 112          parameter: 
 113            none
 114          return :
 115            none
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 3   

 116          */
 117          void mmi_sleep_task_proc(void)
 118          {
 119   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 120   1        unsigned char ret = 0xFF;
 121   1        static unsigned char time_count = 0;
 122   1      
 123   1        time_count++;
 124   1        if (time_count > 4)
 125   1        {
 126   2          time_count = 0;
 127   2          ret = mmi_dq_rfid_check();
 128   2        }
 129   1      #endif
 130   1      
 131   1        if (
 132   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 133   1          (ret == RET_SUCESS) ||
 134   1      #endif
 135   1          (mmi_dq_key_check() != 0) || (mmi_dq_rst_get_pin() != 0)
 136   1      #ifdef __LOCK_FP_SUPPORT__
                  || (mmi_dq_fp_get_pin() == 1)
              #endif
 139   1        )
 140   1        {
 141   2          key_last_value = mmi_dq_get_key_map(dqiot_drv_get_touch_value());
 142   2          mmi_dq_sys_wake_up();
 143   2        }
 144   1      
 145   1        //if(mmi_dq_sys_get_wifi_check_flag() != 0)
 146   1        //  mmi_dq_ms_set_msg_que(QUE_EVENT_WIFI_CHECK,QUE_PRO_LOW,0);
 147   1        return;
 148   1      }
 149          
 150          /*
 151          parameter: 
 152            none
 153          return :
 154            none
 155          */
 156          void mmi_wait_sleep_task_proc(void)
 157          {
 158   1        //unsigned int timer1_count = 0;
 159   1        if (mmi_dq_wifi_get_running_flag() == 1)
 160   1          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 161   1        //if((mmi_dq_rfid_check() == RET_SUCESS) || (mmi_dq_key_check() != 0) || (mmi_dq_rst_get_pin() == 0))
 162   1        else if (mmi_dq_ms_get_run_flag() == 0)
 163   1        {
 164   2          mmi_dq_sys_enter_sleep();
 165   2        }
 166   1      
 167   1        return;
 168   1      }
 169          
 170          /*
 171          parameter: 
 172            none
 173          return :
 174            none
 175          */
 176          unsigned char mmi_dq_ms_get_run_flag(void)
 177          {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 4   

 178   1        if ((key_last_value == KEY_INVALID) && (mmi_dq_aud_get_state() == 0) && (mmi_dq_rst_get_pin() == 0)
 179   1      #ifdef __LOCK_FP_SUPPORT__
                  && (mmi_dq_fp_get_pin() != 1)
              #endif
 182   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 183   1          && rfid_last_flag == 0
 184   1      #endif
 185   1        )
 186   1          return 0;
 187   1      
 188   1        return 1;
 189   1      }
 190          
 191          /*
 192          parameter: 
 193            none
 194          return :
 195            none
 196          */
 197          void mmi_dq_ms_sys_msg_handle(void)
 198          {
 199   1        Sys_MSG_Queue_M sys_msg_que;
 200   1        if (mmi_OutQueue(&sys_msg_que))
 201   1        {
 202   2          mmi_dq_sys_sleep_timer_reset();
 203   2          switch (sys_msg_que.que_event)
 204   2          {
 205   3          case QUE_EVENT_KEY:
 206   3            mmi_ms_pwd_opt_fun(sys_msg_que.que_data);
 207   3            break;
 208   3      #ifdef __LOCK_FP_SUPPORT__
                  case QUE_EVENT_FP:
                    mmi_ms_fps_opt_fun(sys_msg_que.que_data);
                    break;
              #endif
 213   3      #ifdef __LOCK_RFID_CARD_SUPPORT__
 214   3          case QUE_EVENT_RFID:
 215   3            mmi_ms_rfid_opt_fun(sys_msg_que.que_data);
 216   3            break;
 217   3      #endif
 218   3          case QUE_EVENT_RST:
 219   3            mmi_ms_reset_opt_fun();
 220   3            break;
 221   3          case QUE_EVENT_AUDIO_END:
 222   3      
 223   3            break;
 224   3          case QUE_EVENT_TIMER_END:
 225   3            mmi_dq_sys_delay_event_pro();
 226   3            break;
 227   3          case QUE_EVENT_WIFI_CHECK:
 228   3            mmi_ms_wifi_opt_fun();
 229   3            break;
 230   3          default:
 231   3            break;
 232   3          }
 233   2        }
 234   1      }
 235          
 236          /*
 237          parameter: 
 238            none
 239          return :
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 5   

 240            none
 241          */
 242          void mmi_dq_ms_set_msg_que(SYS_QUEUE_EVENT q_event, SYS_QUEUE_PRO q_pro, unsigned char q_data)
 243          {
 244   1        Sys_MSG_Queue_M que;
 245   1        que.que_event = q_event;
 246   1        que.que_pro = q_pro;
 247   1        que.que_data = q_data;
 248   1        //printf("mmi_dq_ms_set_msg_que  event : %d",q_event);
 249   1        mmi_InQueue(que);
 250   1        return;
 251   1      }
 252          
 253          /*
 254          parameter: 
 255            none
 256          return :
 257            none
 258          */
 259          void mmi_dq_ms_set_sys_state(SYS_BASE_STATUS state)
 260          {
 261   1        sys_state = state;
 262   1        return;
 263   1      }
 264          
 265          /*
 266          parameter: 
 267            none
 268          return :
 269            none
 270          */
 271          SYS_BASE_STATUS mmi_dq_ms_get_sys_state(void)
 272          {
 273   1        return sys_state;
 274   1      }
 275          
 276          /*
 277          parameter: 
 278            none
 279          return :
 280            none
 281          */
 282          void mmi_ms_pwd_init_var(void)
 283          {
 284   1        key_len = 0;
 285   1        opt_time = OPT_ONE_TIME;
 286   1        memset(input_key_1, 0xFF, sizeof(input_key_1));
 287   1        memset(input_key_2, 0xFF, sizeof(input_key_2));
 288   1      }
 289          
 290          /*
 291          parameter: 
 292            none
 293          return :
 294            none
 295          */
 296          void mmi_ms_opt_time_init(void)
 297          {
 298   1        opt_time = OPT_ONE_TIME;
 299   1      }
 300          
 301          /*
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 6   

 302          parameter: 
 303            none
 304          return :
 305            none
 306          */
 307          void mmi_ms_pwd_opt_fun(unsigned char key_val)
 308          {
 309   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
 310   1        //printf("mmi_ms_pwd_opt_fun status: 0x%x  key: %d",status,key_val);
 311   1        switch (status)
 312   1        {
 313   2        case SYS_STATUS_WAIT_FOR_ENTER_SLEEP:
 314   2          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 315   2          status = SYS_STATUS_IDLE;
 316   2        case SYS_STATUS_INPUT_PWD:
 317   2        case SYS_STATUS_INPUT_ADMIN_PWD:
 318   2        case SYS_STATUS_ADD_PWD:
 319   2        case SYS_STATUS_DEL_PWD:
 320   2        case SYS_STATUS_ADD_ADMIN_PWD:
 321   2        case SYS_STATUS_CHG_ADMIN_PWD:
 322   2      #ifdef __LOCK_110_SUPPORT__
 323   2        case SYS_STATUS_ADD_110_PWD:
 324   2      #endif
 325   2          if (mmi_dq_sys_door_state_check() == 1)
 326   2          {
 327   3            mmi_dq_aud_stop();
 328   3            mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
 329   3            mmi_dq_wifi_pw_alarm();
 330   3            return;
 331   3          }
 332   2          if (key_len == 0)
 333   2          {
 334   3            if (key_val == KEY_S)
 335   3            {
 336   4              if (SYS_STATUS_ADD_ADMIN_PWD != status)
 337   4              {
 338   5                mmi_dq_aud_play_key_tone();
 339   5                if (status == SYS_STATUS_INPUT_PWD)
 340   5                  //mmi_dq_sys_enter_sleep();
 341   5                  mmi_dq_ms_set_sys_state(SYS_STATUS_WAIT_FOR_ENTER_SLEEP);
 342   5                else if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 343   5                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 344   5                else if (wifi_add_flag != 0)
 345   5                {
 346   6                  wifi_add_flag = 0;
 347   6                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 348   6                }
 349   5                else
 350   5                  mmi_dq_sys_show_cur_menu_list();
 351   5              }
 352   4              break;
 353   4            }
 354   3            else if (key_val == KEY_H)
 355   3            {
 356   4              if (status == SYS_STATUS_INPUT_PWD)
 357   4              {
 358   5                mmi_dq_aud_play_key_tone();
 359   5                admin_check_type = 0;
 360   5                mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD);
 361   5                mmi_dq_ms_set_sys_state(SYS_STATUS_INPUT_ADMIN_PWD);
 362   5              }
 363   4              break;
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 7   

 364   4            }
 365   3          }
 366   2      
 367   2          // mmi_dq_aud_play_key_num(key_val);
 368   2          mmi_dq_aud_play_key_tone();
 369   2          //input pwd
 370   2          if ((key_val >= KEY_0 && key_val <= KEY_9) && key_len < KEY_INPUT_MAX_LEN)
 371   2          {
 372   3            if ((status == SYS_STATUS_INPUT_PWD) || (status == SYS_STATUS_INPUT_ADMIN_PWD))
 373   3              input_key_1[key_len++] = key_val;
 374   3            else // if((status == SYS_STATUS_ADD_PWD)||(status == SYS_STATUS_ADD_110_PWD)||(status == SYS_STATUS_AD
             -D_ADMIN_PWD))
 375   3            {
 376   4              if (opt_time == OPT_ONE_TIME)
 377   4              {
 378   5                input_key_1[key_len++] = key_val;
 379   5              }
 380   4              else if (opt_time == OPT_TWO_TIME)
 381   4              {
 382   5                input_key_2[key_len++] = key_val;
 383   5              }
 384   4            }
 385   3          }
 386   2      
 387   2          if (key_val == KEY_S)
 388   2          {
 389   3            if (opt_time == OPT_ONE_TIME)
 390   3              input_key_1[key_len--] = 0xFF;
 391   3            else if (opt_time == OPT_TWO_TIME)
 392   3              input_key_2[key_len--] = 0xFF;
 393   3      
 394   3            if (key_len == 0)
 395   3            {
 396   4              if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 397   4                mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD);
 398   4              else if (opt_time == OPT_ONE_TIME)
 399   4              {
 400   5                if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 401   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_68_PWD);
 402   5                else if (status == SYS_STATUS_DEL_PWD)
 403   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_NUM);
 404   5                else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 405   5                  mmi_dq_aud_play_with_id(AUD_ID_ADD_ADMIN_PWD_FIRST);
 406   5                else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 407   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD);
 408   5              }
 409   4              else if (opt_time == OPT_TWO_TIME)
 410   4              {
 411   5                if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 412   5                  mmi_dq_aud_play_with_id(AUD_ID_PWD_INPUT_AGAIN);
 413   5                else if (status == SYS_STATUS_DEL_PWD)
 414   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_PWD_AGAIN);
 415   5                else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 416   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD_INIT_AGAIN);
 417   5                else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 418   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD_AGAIN);
 419   5              }
 420   4            }
 421   3          }
 422   2          else if ((key_val == KEY_H) || (key_len == PWD_INPUT_MAX_LEN))
 423   2          {
 424   3            if (key_len < PWD_INPUT_MIN_LEN)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 8   

 425   3            {
 426   4              if (status == SYS_STATUS_INPUT_PWD)
 427   4              {
 428   5                if (key_len == 1 && input_key_1[0] == KEY_5) //5 æ·»åŠ åˆ é™¤å¯†ç /æŒ‡çº¹/RFå¡
 429   5                  mmi_dq_wifi_cmd_add_del();
 430   5                else if (key_len == 1 && input_key_1[0] == KEY_6) //6 è®¾ç½®æ‹ç…§/å½•åƒå¼€å…³
 431   5                  mmi_dq_wifi_pv_switch();
 432   5                else if (key_len == 2 && input_key_1[0] == KEY_0 && input_key_1[1] == KEY_0) //00 è¿œç¨‹å¼€é—¨
 433   5                  mmi_dq_sys_wifi_open();
 434   5                else if (key_len == 2 && input_key_1[0] == KEY_1 && input_key_1[1] == KEY_8) //18 åº”æ€¥é’¥åŒ™å¼€é—¨æ
             -ˆåŠŸ
 435   5                  mmi_dq_wifi_open_by_key();
 436   5                else if (key_len == 2 && input_key_1[0] == KEY_1 && input_key_1[1] == KEY_9) //19 é—¨æœªå…³
 437   5                  mmi_dq_wifi_close_over_time();
 438   5                else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_0) //20 éœ‡åŠ¨æŠ¥è­¦
 439   5                  mmi_dq_wifi_via_alarm();
 440   5                else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_5) //25 ç¡çœ 
 441   5                  mmi_dq_wifi_sleep();
 442   5                else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_6) //26 å”¤é†’
 443   5                  mmi_dq_wifi_wakeup();
 444   5                // else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_7) //27 æ‹ç…§
 445   5                //  mmi_dq_wifi_take_photos();
 446   5                else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_8) //28 å½•åƒ
 447   5                  mmi_dq_wifi_take_videos();
 448   5                else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_0) //30 æŸ¥è¯¢ç½‘ç»œçŠ¶æ€
 449   5                  mmi_dq_wifi_check_net();
 450   5                  // else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_1) //31 Airkissé…ç½‘(a
             -dmin 8)
 451   5                  //  mmi_dq_wifi_arikiss_con();
 452   5                  // else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_2) //32 äºŒç»´ç é…ç½‘
             -(admin 9)
 453   5                  //  mmi_dq_wifi_code_con();
 454   5      
 455   5      #ifdef __LOCK_BUS_SUPPORT__
 456   5                else if (key_len == 2 && input_key_1[0] == KEY_0 && input_key_1[1] == KEY_1) //01
 457   5                {
 458   6                  if (mmi_dq_fs_get_business_flag() == 1)
 459   6                  {
 460   7                    admin_check_type = 1;
 461   7                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD);
 462   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_INPUT_ADMIN_PWD);
 463   7                  }
 464   6                  else
 465   6                  {
 466   7                    mmi_dq_fs_set_business_flag(1);
 467   7                    mmi_dq_aud_play_with_id(AUD_ID_OUT_OPEN);
 468   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 469   7                  }
 470   6                }
 471   5      #endif
 472   5                else
 473   5                {
 474   6                  mmi_dq_sys_door_open_fail(SYS_OPEN_BY_PASSWORD);
 475   6                }
 476   5                key_len = 0;
 477   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 478   5              }
 479   4              else
 480   4              {
 481   5                mmi_dq_aud_play_with_id(AUD_ID_PWD_68_LEN);
 482   5                key_len = 0;
 483   5                if (opt_time == OPT_ONE_TIME)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 9   

 484   5                  memset(input_key_1, 0xFF, sizeof(input_key_1));
 485   5                else if (opt_time == OPT_TWO_TIME)
 486   5                  memset(input_key_2, 0xFF, sizeof(input_key_2));
 487   5              }
 488   4            }
 489   3            else
 490   3            {
 491   4              if (status == SYS_STATUS_INPUT_PWD)
 492   4              {
 493   5                //if(mmi_dq_fs_check_input_pwd(input_key_1,key_len,FDS_USE_TYPE_ALL) == 0xFF)
 494   5                unsigned char ret = 0;
 495   5                ret = mmi_dq_fs_check_input_pwd_for_open(input_key_1, key_len);
 496   5                //printf("check input ret: %d",(unsigned int)ret);
 497   5                if (ret == 0xFF)
 498   5                  mmi_dq_sys_door_open_fail(SYS_OPEN_BY_PASSWORD);
 499   5      #ifdef __LOCK_BUS_SUPPORT__
 500   5                else if (ret == 0xFE && mmi_dq_fs_get_business_flag() == 1)
 501   5                {
 502   6                  mmi_dq_fs_set_business_flag(0);
 503   6                  mmi_dq_aud_play_with_id(AUD_ID_OUT_CLOSED);
 504   6                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 505   6                }
 506   5      #endif
 507   5      #ifdef __LOCK_110_SUPPORT__
 508   5                else if (ret == 1)
 509   5                  mmi_dq_sys_door_open(SYS_OPEN_BY_110_PASSWORD);
 510   5      #endif
 511   5                else
 512   5                  mmi_dq_sys_door_open(SYS_OPEN_BY_PASSWORD);
 513   5                key_len = 0;
 514   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 515   5              }
 516   4              else if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 517   4              {
 518   5                if (mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == 0xFF)
 519   5                  mmi_dq_aud_play_with_id(AUD_ID_PWD_WRONG_TRY);
 520   5                else
 521   5                {
 522   6      #ifdef __LOCK_BUS_SUPPORT__
 523   6                  if (admin_check_type == 1)
 524   6                  {
 525   7                    mmi_dq_fs_set_business_flag(0);
 526   7                    mmi_dq_aud_play_with_id(AUD_ID_OUT_CLOSED);
 527   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 528   7                  }
 529   6                  else
 530   6      #endif
 531   6                  {
 532   7                    mmi_dq_sys_set_menu_father_id(STR_ID_SYSTEM);
 533   7                    mmi_dq_sys_show_cur_menu_list();
 534   7                  }
 535   6                }
 536   5                key_len = 0;
 537   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 538   5              }
 539   4              else // if((status == SYS_STATUS_ADD_PWD)||(status == SYS_STATUS_DEL_PWD)||(status == SYS_STATUS_ADD_A
             -DMIN_PWD)||(status == SYS_STATUS_CHG_ADMIN_PWD)||(status == SYS_STATUS_ADD_110_PWD))
 540   4              {
 541   5                if (opt_time == OPT_ONE_TIME)
 542   5                {
 543   6                  if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 544   6                    mmi_dq_aud_play_with_id(AUD_ID_PWD_INPUT_AGAIN);
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 10  

 545   6                  else if (status == SYS_STATUS_DEL_PWD)
 546   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_PWD_AGAIN);
 547   6                  else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 548   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD_INIT_AGAIN);
 549   6                  else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 550   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD_AGAIN);
 551   6      
 552   6                  opt_time = OPT_TWO_TIME;
 553   6                  key_len = 0;
 554   6                  memset(input_key_2, 0xFF, sizeof(input_key_2));
 555   6                }
 556   5                else if (opt_time == OPT_TWO_TIME)
 557   5                {
 558   6                  if (0 == memcmp(input_key_1, input_key_2, PWD_INPUT_MAX_LEN))
 559   6                  {
 560   7                    if (status == SYS_STATUS_DEL_PWD)
 561   7                    {
 562   8                      unsigned char del_index = mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_USER);
 563   8                      if (del_index == 0xFF)
 564   8                        mmi_dq_aud_play_with_id(AUD_ID_PWD_NOT_EXIST);
 565   8                      else
 566   8                      {
 567   9                        if (mmi_dq_fs_del_pwd(del_index, FDS_USE_TYPE_USER) == RET_SUCESS)
 568   9                        {
 569  10                          get_index = del_index;
 570  10                          mmi_dq_aud_play_with_id(AUD_ID_DEL_PWD_SUCESS);
 571  10                          mmi_dq_wifi_del_password(get_index);
 572  10                          // printfV("get_index", (int)get_index);
 573  10                        }
 574   9                        else
 575   9                          mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL);
 576   9                        mmi_dq_sys_del_pwd_con();
 577   9                      }
 578   8                    }
 579   7                    else if (mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_ALL) != 0xFF)
 580   7                      mmi_dq_aud_play_with_id(AUD_ID_PWD_EXIST);
 581   7                    else
 582   7                    {
 583   8                      if (status == SYS_STATUS_ADD_PWD)
 584   8                      {
 585   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_USER) == RET_FAIL)
 586   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
 587   9                        else
 588   9                        {
 589  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_PWD_SUCESS);
 590  10                          mmi_dq_wifi_add_password(get_index);
 591  10                          // printfV("get_index", (int)get_index);
 592  10                        }
 593   9                        if (wifi_add_flag == 0)
 594   9                          mmi_dq_sys_add_pwd_con();
 595   9                        else
 596   9                        {
 597  10                          wifi_add_flag = 0;
 598  10                          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 599  10                        }
 600   9                      }
 601   8                      else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 602   8                      {
 603   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == RET_FAIL)
 604   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
 605   9                        else
 606   9                        {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 11  

 607  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_ADMIN_PWD_INIT_SUCESS);
 608  10                          mmi_dq_wifi_add_password(get_index);
 609  10                          // printfV("get_index", (int)get_index);
 610  10                        }
 611   9      #ifdef __LOCK_FP_SUPPORT__
                                mmi_dq_sys_chg_admin_fp_No1();
              #else
 614   9                        if (0 == mmi_dq_fs_get_admin_status())
 615   9                          mmi_dq_sys_lock_add_admin_suc();
 616   9                        else
 617   9                          mmi_dq_sys_show_cur_menu_list();
 618   9      #endif
 619   9                      }
 620   8                      else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 621   8                      {
 622   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == RET_FAIL)
 623   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
 624   9                        else
 625   9                        {
 626  10                          mmi_dq_aud_play_with_id(AUD_ID_CHG_ADMIN_PWD_SUCESS);
 627  10                          mmi_dq_wifi_add_password(get_index);
 628  10                          // printfV("get_index", (int)get_index);
 629  10                        }
 630   9                        mmi_dq_sys_show_cur_menu_list();
 631   9                      }
 632   8      #ifdef __LOCK_110_SUPPORT__
 633   8                      else if (status == SYS_STATUS_ADD_110_PWD)
 634   8                      {
 635   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_110) == RET_FAIL)
 636   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
 637   9                        else
 638   9                        {
 639  10      #ifdef __LOCK_WIFI_SUPPORT__
 640  10                          mmi_dq_wifi_set_110();
 641  10      #endif
 642  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_PWD_SUCESS);
 643  10                          mmi_dq_wifi_add_password(get_index);
 644  10                          // printfV("get_index", (int)get_index);
 645  10                        }
 646   9                        mmi_dq_sys_show_cur_menu_list();
 647   9                      }
 648   8      #endif
 649   8                    }
 650   7                  }
 651   6                  else
 652   6                  {
 653   7                    mmi_dq_aud_play_with_id(AUD_ID_PWD_NOT_SAME_RETRY);
 654   7                  }
 655   6                  mmi_ms_pwd_init_var();
 656   6                }
 657   5              }
 658   4            }
 659   3            return;
 660   3          }
 661   2          break;
 662   2      #ifdef __LOCK_FP_SUPPORT__
                case SYS_STATUS_ADD_FP:
                case SYS_STATUS_DEL_FP:
              #ifdef __LOCK_110_SUPPORT__
                case SYS_STATUS_ADD_110_FP:
                case SYS_STATUS_DEL_110_FP:
              #endif
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 12  

              #endif
 670   2      #ifdef __LOCK_RFID_CARD_SUPPORT__
 671   2        case SYS_STATUS_ADD_RFID:
 672   2        case SYS_STATUS_DEL_RFID:
 673   2      #endif
 674   2          if (key_val == KEY_S)
 675   2          {
 676   3            mmi_dq_aud_play_key_tone();
 677   3            if (wifi_add_flag != 0)
 678   3            {
 679   4              wifi_add_flag = 0;
 680   4              mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 681   4            }
 682   3            else
 683   3              mmi_dq_sys_show_cur_menu_list();
 684   3          }
 685   2          break;
 686   2      #ifdef __LOCK_FP_SUPPORT__
                case SYS_STATUS_ADD_ADMIN_FP1:
                case SYS_STATUS_ADD_ADMIN_FP2:
                  if (key_val == KEY_S)
                  {
                    mmi_dq_aud_play_key_tone();
                    if (0 == mmi_dq_fs_get_admin_status())
                      mmi_dq_sys_lock_add_admin_suc();
                    else
                      mmi_dq_sys_show_cur_menu_list();
                  }
                  break;
              #endif
 699   2        case SYS_STATUS_CLR_PWD:
 700   2        case SYS_STATUS_ADD_PWD_CON:
 701   2        case SYS_STATUS_DEL_PWD_CON:
 702   2      #ifdef __LOCK_FP_SUPPORT__
                case SYS_STATUS_CLR_FP:
                case SYS_STATUS_ADD_FP_CON:
                case SYS_STATUS_DEL_FP_CON:
              #endif
 707   2      #ifdef __LOCK_RFID_CARD_SUPPORT__
 708   2        case SYS_STATUS_CLR_RFID:
 709   2        case SYS_STATUS_ADD_RFID_CON:
 710   2        case SYS_STATUS_DEL_RFID_CON:
 711   2      #endif
 712   2        case SYS_STATUS_RESTORE_LOCK_CON:
 713   2          if (key_val == KEY_H)
 714   2          {
 715   3            mmi_dq_aud_play_key_tone();
 716   3            switch (status)
 717   3            {
 718   4            case SYS_STATUS_CLR_PWD:
 719   4              if (RET_SUCESS == mmi_dq_fs_clr_pwd())
 720   4              {
 721   5                mmi_dq_aud_play_with_id(AUD_ID_CLR_PWD_SUCESS);
 722   5                mmi_dq_wifi_clr_pwd_suc();
 723   5              }
 724   4              else
 725   4                mmi_dq_aud_play_with_id(AUD_ID_CLR_PWD_FAIL);
 726   4              mmi_dq_sys_show_cur_menu_list();
 727   4              break;
 728   4      #ifdef __LOCK_FP_SUPPORT__
                    case SYS_STATUS_CLR_FP:
                      if (RET_SUCESS == mmi_dq_fs_clr_fp())
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 13  

                      {
                        mmi_dq_aud_play_with_id(AUD_ID_CLR_FP_SUCESS);
                        mmi_dq_wifi_clr_fps_suc();
                      }
                      else
                        mmi_dq_aud_play_with_id(AUD_ID_CLR_FP_FAIL);
                      mmi_dq_sys_show_cur_menu_list();
                      break;
              #endif
 740   4      #ifdef __LOCK_RFID_CARD_SUPPORT__
 741   4            case SYS_STATUS_CLR_RFID:
 742   4              if (RET_SUCESS == mmi_dq_fs_clr_rfid())
 743   4              {
 744   5                mmi_dq_aud_play_with_id(AUD_ID_CLR_RFCARD_SUCESS);
 745   5                mmi_dq_wifi_clr_rfid_suc();
 746   5              }
 747   4              else
 748   4                mmi_dq_aud_play_with_id(AUD_ID_CLR_RFCARD_FAIL);
 749   4              mmi_dq_sys_show_cur_menu_list();
 750   4              break;
 751   4      #endif
 752   4            case SYS_STATUS_ADD_PWD_CON:
 753   4              mmi_dq_sys_add_pwd();
 754   4              break;
 755   4            case SYS_STATUS_DEL_PWD_CON:
 756   4              mmi_dq_sys_del_pwd();
 757   4              break;
 758   4      #ifdef __LOCK_FP_SUPPORT__
                    case SYS_STATUS_ADD_FP_CON:
                      mmi_dq_sys_add_fp();
                      break;
                    case SYS_STATUS_DEL_FP_CON:
                      mmi_dq_sys_del_fp();
                      break;
              #endif
 766   4      #ifdef __LOCK_RFID_CARD_SUPPORT__
 767   4            case SYS_STATUS_ADD_RFID_CON:
 768   4              mmi_dq_sys_add_rf();
 769   4              break;
 770   4            case SYS_STATUS_DEL_RFID_CON:
 771   4              mmi_dq_sys_del_rf();
 772   4              break;
 773   4      #endif
 774   4            case SYS_STATUS_RESTORE_LOCK_CON:
 775   4              mmi_dq_sys_restore_lock();
 776   4              break;
 777   4            }
 778   3          }
 779   2          else if (key_val == KEY_S)
 780   2          {
 781   3            mmi_dq_aud_play_key_tone();
 782   3            mmi_dq_sys_show_cur_menu_list();
 783   3          }
 784   2          break;
 785   2        case SYS_STATUS_SYS_MENU:
 786   2          if (key_val == KEY_S)
 787   2          {
 788   3            mmi_dq_aud_play_key_tone();
 789   3            mmi_dq_sys_get_pre_menu_list();
 790   3          }
 791   2          else if (key_val != KEY_0 && key_val <= mmi_dq_sys_get_menu_count())
 792   2          {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 14  

 793   3            mmi_dq_aud_play_key_tone();
 794   3            mmi_dq_sys_exe_menu_fun(key_val - 1);
 795   3          }
 796   2          break;
 797   2      #ifdef __FACTORY_TEST_SUPPORT__
 798   2        case SYS_STATUS_FM_MODE:
 799   2        {
 800   3          unsigned char str = mmi_dq_factory_mode_get_test_project();
 801   3          if (str == STR_ID_KEY)
 802   3          {
 803   4            // mmi_dq_aud_play_key_num(key_val);
 804   4            mmi_dq_aud_play_key_tone();
 805   4            mmi_dq_factory_mode_key_test(key_val);
 806   4          }
 807   3          else if (str == STR_ID_MOTO)
 808   3          {
 809   4            if (key_val == KEY_S)
 810   4            {
 811   5              mmi_dq_aud_play_key_tone();
 812   5              mmi_dq_factory_mode_motor_test_back();
 813   5              if (mmi_dq_fs_get_factory_flag() != 0)
 814   5                mmi_dq_factory_mode_test_stop();
 815   5              else
 816   5              {
 817   6                delay_ms(600);
 818   6                mmi_dq_factory_mode_motor_test();
 819   6              }
 820   5            }
 821   4            else if (key_val == KEY_H)
 822   4            {
 823   5              mmi_dq_aud_play_key_tone();
 824   5              mmi_dq_factory_mode_motor_test_back();
 825   5              mmi_dq_factory_mode_test_item_result(STR_ID_MOTO, 1);
 826   5            }
 827   4          }
 828   3          else if (mmi_dq_fs_get_factory_flag() != 0)
 829   3          {
 830   4            mmi_dq_aud_play_key_tone();
 831   4            mmi_dq_factory_mode_test_stop();
 832   4          }
 833   3        }
 834   2        break;
 835   2      #endif
 836   2        case SYS_STATUS_WIFI_MODE:
 837   2          //if(key_val == KEY_S)
 838   2          //{
 839   2          mmi_dq_aud_stop();
 840   2          mmi_dq_aud_play_with_id(AUD_ID_WIFI_CONNECTING);
 841   2          //  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 842   2          //}
 843   2          break;
 844   2        case SYS_STATUS_LOW_POWER:
 845   2          mmi_dq_aud_stop();
 846   2          mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
 847   2          mmi_dq_wifi_lowpower_alarm();
 848   2          break;
 849   2        default:
 850   2          break;
 851   2        }
 852   1        return;
 853   1      }
 854          
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 15  

 855          #ifdef __LOCK_FP_SUPPORT__
              /*
              parameter: 
                none
              return :
                none
              */
              void mmi_ms_fps_opt_fun(unsigned char fps_val)
              {
                RET_VAL retval = 0;
                unsigned short index = 0;
                SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
                if (status == SYS_STATUS_LOW_POWER)
                {
                  mmi_dq_aud_stop();
                  mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
                  mmi_dq_wifi_lowpower_alarm();
                  return;
                }
                else if (status == SYS_STATUS_WAIT_FOR_ENTER_SLEEP)
                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
              
                if ((status != SYS_STATUS_INPUT_FP && status != SYS_STATUS_ADD_FP && status != SYS_STATUS_DEL_FP && statu
             -s != SYS_STATUS_ADD_ADMIN_FP1 && status != SYS_STATUS_ADD_ADMIN_FP2 && status != SYS_STATUS_ADD_110_FP && status != SYS_
             -STATUS_DEL_110_FP)
              #ifdef __FACTORY_TEST_SUPPORT__
                  || (status == SYS_STATUS_FM_MODE && STR_ID_FINGERPRINT != mmi_dq_factory_mode_get_test_project())
              #endif
                )
                  return;
              
              #ifdef __LOCK_AUDIO_SUPPORT__
                mmi_dq_aud_stop();
              #endif
                if (mmi_dq_sys_door_state_check() == 1)
                {
                  mmi_dq_aud_stop();
                  mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
                  mmi_dq_wifi_fp_alarm();
                  return;
                }
              
                retval = mmi_dq_fp_get_image();
              
                if (retval == 0)
                {
                  // printfS("mmi_dq_fp_get_image", "ok");
                  // if (opt_time != 0)
                  //  retval = mmi_dq_fp_gen_char(0);
                  // if (retval == 0)
                  retval = mmi_dq_fp_gen_char(opt_time);
                  if (retval == 0)
                  {
                    // printfS("mmi_dq_fp_gen_char", "ok");
                    retval = mmi_dq_fp_high_speed_search(opt_time, &index);
                    if (retval == 0)
                    {
                      // printfS("mmi_dq_fp_high_speed_search", "ok");
                      if (status == SYS_STATUS_INPUT_FP)
                      {
                        retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_ALL);
                        if (retval == RET_SUCESS)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 16  

                        {
                          get_index = index;
                          mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_110_SUPPORT__
                          if (mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_110) == RET_SUCESS)
                          {
                            mmi_dq_sys_door_open(SYS_OPEN_BY_110_FP);
                          }
                          else
              #endif
                            mmi_dq_sys_door_open(SYS_OPEN_BY_FP);
                        }
                        else
                        {
                          mmi_dq_fp_light(FP_RED);
                          mmi_dq_sys_door_open_fail(SYS_OPEN_BY_FP);
                        }
                      }
                      else if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_ADMIN_FP1 || status == SYS_STATUS_ADD
             -_ADMIN_FP2 || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
                      {
                        mmi_dq_fp_light(FP_RED);
                        mmi_dq_aud_play_with_id(AUD_ID_FP_EXIST);
                      }
                      else if (status == SYS_STATUS_DEL_FP || status == SYS_STATUS_DEL_110_FP)
                      {
              #ifdef __LOCK_110_SUPPORT__
                        if (status == SYS_STATUS_DEL_FP)
                          retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_USER);
                        else if (status == SYS_STATUS_DEL_110_FP)
                          retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_110);
              #else
                        retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_USER);
              #endif
                        if (retval == RET_SUCESS)
                        {
                          static unsigned char del_num = 0;
                          if (opt_time == OPT_ONE_TIME)
                          {
                            opt_time = OPT_TWO_TIME;
                            del_num = index;
                            mmi_dq_fp_light(FP_GREEN);
                            mmi_dq_aud_play_with_id(AUD_ID_PRESS_DEL_FP_AGAIN);
                          }
                          else
                          {
                            //retval = mmi_dq_fp_match();
                            if (del_num == index)
                              retval = 0;
                            else
                              retval = 255;
                            if (retval == 0) //|| retval == 255)
                            {
              #ifdef __LOCK_110_SUPPORT__
                              if (status == SYS_STATUS_DEL_FP)
                                retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_USER);
                              else if (status == SYS_STATUS_DEL_110_FP)
                                retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_110);
              #else
                              retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_USER);
              #endif
                              if (retval == RET_SUCESS)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 17  

                              {
                                retval = mmi_dq_fp_delete(index);
                              }
                              if (retval == 0)
                              {
                                mmi_dq_fp_light(FP_GREEN);
                                mmi_dq_aud_play_with_id(AUD_ID_DEL_FP_SUCESS);
                                mmi_dq_wifi_del_fp(index);
                              }
                              else
                              {
                                mmi_dq_fp_light(FP_RED);
                                mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL);
                              }
              #ifdef __LOCK_110_SUPPORT__
                              if (status == SYS_STATUS_DEL_FP)
                                mmi_dq_sys_del_fp_con();
                              else if (status == SYS_STATUS_DEL_110_FP)
                                mmi_dq_sys_show_cur_menu_list();
              #else
                              mmi_dq_sys_del_fp_con();
              #endif
                            }
                            else
                            {
                              mmi_dq_fp_light(FP_RED);
                              mmi_dq_aud_play_with_id(AUD_ID_FP_TWICE_NOT_SAME_RETRY);
                            }
                            opt_time = OPT_ONE_TIME;
                          }
                        }
                        else
                        {
                          mmi_dq_fp_light(FP_RED);
                          mmi_dq_aud_play_with_id(AUD_ID_FP_NOT_EXIST);
                        }
                      }
                    }
                    else
                    {
                      // printfS("mmi_dq_fp_high_speed_search", "error");
                      if (status == SYS_STATUS_INPUT_FP)
                      {
                        mmi_dq_fp_light(FP_RED);
                        //mmi_dq_aud_play_with_id(AUD_ID_FP_WRONG_TRY);
                        mmi_dq_sys_door_open_fail(SYS_OPEN_BY_FP);
                      }
                      else if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_ADMIN_FP1 || status == SYS_STATUS_ADD
             -_ADMIN_FP2 || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
                      {
                        if (opt_time == FPS_MAX_INPUT_TIME)
                        {
                          retval = mmi_dq_fp_reg_module();
                          if (retval == 0)
                          {
                            // printfS("mmi_dq_fp_reg_module", "ok");
                            if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
                            {
              #ifdef __LOCK_110_SUPPORT__
                              if (status == SYS_STATUS_ADD_110_FP)
                                index = mmi_dq_fs_get_fp_110_unuse_index();
                              else
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 18  

              #endif
                                index = mmi_dq_fs_get_fp_unuse_index();
                              if (index == 0xFF)
                              {
                                // printfS("mmi_dq_fs_get_fp_unuse_index", "error");
                                mmi_dq_fp_light(FP_RED);
                                mmi_dq_aud_play_with_id(AUD_ID_FP_FULL);
                                mmi_dq_sys_show_cur_menu_list();
                              }
                              else
                              {
                                // printfS("mmi_dq_fs_get_fp_unuse_index", "ok");
                                // printfV("index", (int)index);
                                retval = mmi_dq_fp_store_char(0, index);
                                if (status == SYS_STATUS_ADD_FP)
                                {
                                  if (retval == 0)
                                  {
                                    // printfS("mmi_dq_fp_store_char", "ok");
                                    retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_USER);
                                    if (retval != 0)
                                      mmi_dq_fp_delete(index);
                                  }
                                  if (retval == 0)
                                  {
                                    // printfS("mmi_dq_fs_set_fp", "ok");
                                    mmi_dq_fp_light(FP_GREEN);
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
                                    mmi_dq_wifi_add_fp(index);
                                  }
                                  else
                                  {
                                    // printfS("mmi_dq_fp_store_char", "error");
                                    mmi_dq_fp_light(FP_RED);
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
                                  }
                                  if (wifi_add_flag == 0)
                                    mmi_dq_sys_add_fp_con();
                                  else
                                  {
                                    wifi_add_flag = 0;
                                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
                                  }
                                }
              #ifdef __LOCK_110_SUPPORT__
                                else if (status == SYS_STATUS_ADD_110_FP)
                                {
                                  if (retval == 0)
                                  {
                                    retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_110);
                                    if (retval != 0)
                                      mmi_dq_fp_delete(index);
                                  }
                                  if (retval == 0)
                                  {
                                    mmi_dq_fp_light(FP_GREEN);
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
                                    mmi_dq_wifi_set_110();
                                    mmi_dq_wifi_add_fp(index);
                                  }
                                  else
                                  {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 19  

                                    mmi_dq_fp_light(FP_RED);
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
                                  }
                                  mmi_dq_sys_show_cur_menu_list();
                                }
              #endif
              #ifdef __FACTORY_TEST_SUPPORT__
                                else
                                {
                                  if (retval == 0)
                                  {
                                    retval = mmi_dq_fp_delete(index);
                                  }
                                  if (retval == 0)
                                  {
                                    mmi_dq_fp_light(FP_GREEN);
                                    mmi_dq_factory_mode_test_item_result(STR_ID_FINGERPRINT, 1);
                                  }
                                  else
                                  {
                                    mmi_dq_fp_light(FP_RED);
                                    mmi_dq_factory_mode_test_item_result(STR_ID_FINGERPRINT, 0);
                                  }
                                }
              #endif
                              }
                            }
                            else
                            {
                              if (status == SYS_STATUS_ADD_ADMIN_FP1)
                                index = 0;
                              else if (status == SYS_STATUS_ADD_ADMIN_FP2)
                                index = 1;
                              retval = mmi_dq_fp_delete(index);
                              if (retval == 0)
                                retval = mmi_dq_fp_store_char(0, index);
                              if (retval == 0)
                                retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_ADMIN);
                              if (retval == 0)
                              {
                                mmi_dq_fp_light(FP_GREEN);
                                mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
                                mmi_dq_wifi_add_fp(index);
                              }
                              else
                              {
                                mmi_dq_fp_light(FP_RED);
                                mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
                              }
                              if (0 == mmi_dq_fs_get_admin_status())
                              {
                                if (status == SYS_STATUS_ADD_ADMIN_FP1)
                                  mmi_dq_sys_chg_admin_fp_No2();
                                else
                                  mmi_dq_sys_lock_add_admin_suc();
                              }
                              else
                                mmi_dq_sys_show_cur_menu_list();
                            }
                          }
                          else
                          {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 20  

                            mmi_dq_fp_light(FP_RED);
                            mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL_RETRY);
                          }
                          opt_time = OPT_ONE_TIME;
                        }
                        else
                        {
                          opt_time++;
                          mmi_dq_fp_light(FP_GREEN);
                          mmi_dq_aud_play_with_id(AUD_ID_PRESS_FP_AGAIN);
                        }
                      }
                      else if (status == SYS_STATUS_DEL_FP)
                      {
                        mmi_dq_fp_light(FP_RED);
                        mmi_dq_aud_play_with_id(AUD_ID_FP_NOT_EXIST);
                      }
                    }
                    return;
                  }
                }
                // printfS("mmi_dq_fp_get_image", "error");
              
                mmi_dq_fp_light(FP_RED);
                mmi_dq_aud_play_with_id(AUD_ID_PRESS_FP_AGAIN);
                return;
              }
              #endif
1189          
1190          #ifdef __LOCK_RFID_CARD_SUPPORT__
1191          /*
1192          parameter: 
1193            none
1194          return :
1195            none
1196          */
1197          void mmi_ms_rfid_opt_fun(unsigned char rfid_val)
1198          {
1199   1        RET_VAL retval = RET_SUCESS;
1200   1        unsigned char index = 0;
1201   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
1202   1      
1203   1        if (status == SYS_STATUS_LOW_POWER)
1204   1        {
1205   2          mmi_dq_aud_stop();
1206   2          mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
1207   2          mmi_dq_wifi_lowpower_alarm();
1208   2          return;
1209   2        }
1210   1        else if (status == SYS_STATUS_WAIT_FOR_ENTER_SLEEP)
1211   1          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1212   1      
1213   1        if ((status != SYS_STATUS_INPUT_RFID && status != SYS_STATUS_ADD_RFID && status != SYS_STATUS_DEL_RFID)
1214   1      #ifdef __FACTORY_TEST_SUPPORT__
1215   1          || (status == SYS_STATUS_FM_MODE && STR_ID_RF_CARD != mmi_dq_factory_mode_get_test_project())
1216   1      #endif
1217   1        )
1218   1          return;
1219   1      
1220   1      #ifdef __LOCK_AUDIO_SUPPORT__
1221   1        mmi_dq_aud_stop();
1222   1      #endif
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 21  

1223   1      
1224   1        if (mmi_dq_sys_door_state_check() == 1)
1225   1        {
1226   2          mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
1227   2          mmi_dq_wifi_rfid_alarm();
1228   2          return;
1229   2        }
1230   1      #ifdef __FACTORY_TEST_SUPPORT__
1231   1        if (status == SYS_STATUS_FM_MODE)
1232   1        {
1233   2          retval = mmi_dq_rfid_gen_char(opt_time);
1234   2          if (retval == RET_SUCESS)
1235   2          {
1236   3            if (opt_time == OPT_ONE_TIME)
1237   3            {
1238   4              mmi_dq_aud_play_with_id(AUD_ID_PRESS_RFCARD_AGAIN);
1239   4              opt_time = OPT_TWO_TIME;
1240   4            }
1241   3            else
1242   3            {
1243   4              retval = mmi_dq_rfid_match();
1244   4              if (retval == RET_SUCESS)
1245   4      
1246   4                mmi_dq_factory_mode_test_item_result(STR_ID_RF_CARD, 1);
1247   4              else
1248   4                mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY);
1249   4              opt_time = OPT_ONE_TIME;
1250   4            }
1251   3          }
1252   2          return;
1253   2        }
1254   1      #endif
1255   1        retval = mmi_dq_rfid_search_by_temp(&index);
1256   1        if (retval == RET_SUCESS)
1257   1        {
1258   2          if (status == SYS_STATUS_INPUT_RFID)
1259   2          {
1260   3            mmi_dq_sys_door_open(SYS_OPEN_BY_RFID);
1261   3          }
1262   2          else if (status == SYS_STATUS_ADD_RFID)
1263   2          {
1264   3            mmi_dq_aud_play_with_id(AUD_ID_RFCARD_EXIST);
1265   3          }
1266   2          else if (status == SYS_STATUS_DEL_RFID)
1267   2          {
1268   3            retval = mmi_dq_rfid_gen_char(opt_time);
1269   3            if (retval == RET_SUCESS)
1270   3            {
1271   4              if (opt_time == OPT_ONE_TIME)
1272   4              {
1273   5                mmi_dq_aud_play_with_id(AUD_ID_PRESS_DEL_RFCARD_AGAIN);
1274   5                opt_time = OPT_TWO_TIME;
1275   5              }
1276   4              else
1277   4              {
1278   5                retval = mmi_dq_rfid_match();
1279   5                if (retval == RET_SUCESS)
1280   5                {
1281   6                  retval = mmi_dq_fs_del_rfid(index);
1282   6                  if (retval == RET_SUCESS)
1283   6                  {
1284   7                    get_index = index;
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 22  

1285   7                    mmi_dq_aud_play_with_id(AUD_ID_DEL_RFCARD_SUCESS);
1286   7                    mmi_dq_wifi_del_rfid_suc(get_index);
1287   7                    // printfV("get_index", (int)get_index);
1288   7                  }
1289   6                  else
1290   6                    mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL);
1291   6                  mmi_dq_sys_del_rf_con();
1292   6                }
1293   5                else
1294   5                  mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY);
1295   5                opt_time = OPT_ONE_TIME;
1296   5              }
1297   4            }
1298   3            else
1299   3              mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL_RETRY);
1300   3          }
1301   2        }
1302   1        else
1303   1        {
1304   2          if (status == SYS_STATUS_ADD_RFID)
1305   2          {
1306   3            retval = mmi_dq_rfid_gen_char(opt_time);
1307   3            if (retval == RET_SUCESS)
1308   3            {
1309   4              if (opt_time == OPT_ONE_TIME)
1310   4              {
1311   5                mmi_dq_aud_play_with_id(AUD_ID_PRESS_RFCARD_AGAIN);
1312   5                opt_time = OPT_TWO_TIME;
1313   5              }
1314   4              else
1315   4              {
1316   5                retval = mmi_dq_rfid_match();
1317   5                if (retval == RET_SUCESS)
1318   5                {
1319   6                  retval = mmi_dq_rfid_store(0);
1320   6                  if (retval == RET_SUCESS)
1321   6                  {
1322   7                    mmi_dq_aud_play_with_id(AUD_ID_ADD_RFCARD_SUCESS);
1323   7                    mmi_dq_wifi_add_rfid_suc(get_index);
1324   7                    // printfV("get_index", (int)get_index);
1325   7                  }
1326   6                  else
1327   6                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
1328   6                  if (wifi_add_flag == 0)
1329   6                    mmi_dq_sys_add_rf_con();
1330   6                  else
1331   6                  {
1332   7                    wifi_add_flag = 0;
1333   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1334   7                  }
1335   6                }
1336   5                else
1337   5                  mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY);
1338   5                opt_time = OPT_ONE_TIME;
1339   5              }
1340   4            }
1341   3            else
1342   3              mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL_RETRY);
1343   3          }
1344   2          else if (status == SYS_STATUS_INPUT_RFID)
1345   2            mmi_dq_sys_door_open_fail(SYS_OPEN_BY_RFID);
1346   2          else
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 23  

1347   2            mmi_dq_aud_play_with_id(AUD_ID_RFCARD_NOT_EXIST);
1348   2        }
1349   1      
1350   1        return;
1351   1      }
*** WARNING C280 IN LINE 1197 OF mmi_src\mmi_ms.c: 'rfid_val': unreferenced local variable
1352          #endif
1353          
1354          /*
1355          parameter: 
1356            none
1357          return :
1358            none
1359          */
1360          void mmi_ms_reset_opt_fun(void)
1361          {
1362   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
1363   1      
1364   1        if (status == SYS_STATUS_FM_MODE && STR_ID_RESET == mmi_dq_factory_mode_get_test_project())
1365   1        {
1366   2          mmi_dq_factory_mode_reset_test();
1367   2          return;
1368   2        }
1369   1        else
1370   1        {
1371   2          if (RET_SUCESS == mmi_dq_fs_reset())
1372   2          {
1373   3            mmi_dq_aud_play_with_id(AUD_ID_RESTORE_SUCESS);
1374   3            mmi_dq_wifi_clr_pwd_suc();
1375   3            mmi_dq_wifi_clr_fps_suc();
1376   3            mmi_dq_wifi_clr_rfid_suc();
1377   3          }
1378   2          else
1379   2            mmi_dq_aud_play_with_id(AUD_BASE_ID_FAIL);
1380   2      
1381   2          mmi_dq_sys_add_admin_pwd();
1382   2        }
1383   1      }
1384          
1385          /*
1386          parameter: 
1387            none
1388          return :
1389            none
1390          */
1391          void mmi_ms_wifi_opt_fun(void)
1392          {
1393   1        unsigned char type = mmi_dq_sys_get_wifi_check_type();
1394   1        if (type == 0)
1395   1          mmi_dq_wifi_check_connect();
1396   1        else if (type == 1)
1397   1          mmi_dq_wifi_check_open();
1398   1      }
1399          
1400          #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2877    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     69      16
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/15/2021 10:13:26 PAGE 24  

   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
