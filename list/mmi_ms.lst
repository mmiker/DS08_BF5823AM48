C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE MMI_MS
OBJECT MODULE PLACED IN .\output\mmi_ms.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE mmi_src\mmi_ms.c LARGE OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\include;.\
                    -Library\byd_standard_peripheral\include;.\byd_api\byd_key\include;.\byd_api\byd_mifare\include;.\byd_tool_comm;.\byd_rfi
                    -d;.\mmi_inc) DEBUG PRINT(.\list\mmi_ms.lst) TABS(2) OBJECT(.\output\mmi_ms.obj)

line level    source

   1          #ifndef __MMI_MS_C__
   2          #define __MMI_MS_C__
   3          
   4          #include "string.h"
   5          #include "mmi_ms.h"
   6          #include "mmi_key.h"
   7          #include "mmi_sys.h"
   8          #include "mmi_audio.h"
   9          #include "mmi_fps.h"
  10          #include "mmi_rfid.h"
  11          #include "mmi_com.h"
  12          #include "mmi_fs.h"
  13          #include "mmi_rst.h"
  14          #include "dqiot_drv.h"
  15          #include "delay.h"
  16          #include "mmi_fs.h"
  17          #include "mmi_fm.h"
  18          #include "mmi_wifi.h"
  19          #include "dqiot_drv_wifi.h"
  20          // #include <stdio.h>
  21          #ifdef __LOCK_VIRTUAL_PASSWORD__
              #include "dq_sdk_main.h"
              #include "mmi_ms.h"
              #endif
  25          #ifdef __LOCK_DECODE_SUPPORT__
  26          #include "mmi_decode.h"
  27          #endif
  28          
  29          unsigned char input_key_1[KEY_INPUT_MAX_LEN];
  30          unsigned char input_key_2[KEY_INPUT_MAX_LEN];
  31          unsigned char key_len = 0;
  32          OPERATE_TIME opt_time = OPT_TIME_INVALID;
  33          static SYS_BASE_STATUS data sys_state = SYS_STATUS_INVALID;
  34          
  35          static unsigned char data key_last_value = KEY_INVALID;
  36          #ifdef __LOCK_RFID_CARD_SUPPORT__
  37          static unsigned char rfid_last_flag = 0;
  38          #endif
  39          #ifdef __LOCK_BUS_SUPPORT__
  40          static unsigned char admin_check_type = 0;
  41          #endif
  42          
  43          static unsigned char g_dbl_open_mode_pwd_flag = 0;
  44          static unsigned char g_dbl_open_mode_fp_flag = 0;
  45          static unsigned char g_dbl_open_mode_rf_flag = 0;
  46          
  47          // extern void printfS(char *show, char *status);
  48          // extern void printfV(char *show, int value);
  49          
  50          /*
  51          parameter: 
  52            none
  53          return :
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 2   

  54            none
  55          */
  56          void mmi_task_proc(void)
  57          {
  58   1        unsigned char touch_value = 0xFF;
  59   1        unsigned char key_value = KEY_INVALID;
  60   1      
  61   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
  62   1        if (mmi_dq_sys_get_rfid_flag() == 1)
  63   1        {
  64   2          //check rfid press
  65   2          if (mmi_dq_rfid_check() == RET_SUCESS)
  66   2          {
  67   3            if (mmi_dq_rfid_work() == RET_SUCESS)
  68   3            {
  69   4              if (rfid_last_flag == 0)
  70   4              {
  71   5                rfid_last_flag = 1;
  72   5                mmi_dq_ms_set_msg_que(QUE_EVENT_RFID, QUE_PRO_LOW, 0);
  73   5              }
  74   4            }
  75   3            else
  76   3            {
  77   4              rfid_last_flag = 0;
  78   4            }
  79   3          }
  80   2        }
  81   1      #endif
  82   1        //check key press
  83   1        touch_value = mmi_dq_key_work();
  84   1        if (touch_value != 0xFF)
  85   1        {
  86   2          key_value = mmi_dq_get_key_map(touch_value);
  87   2          if (key_value != KEY_INVALID)
  88   2          {
  89   3            if (key_last_value != key_value)
  90   3            {
  91   4              key_last_value = key_value;
  92   4              mmi_dq_ms_set_msg_que(QUE_EVENT_KEY, QUE_PRO_LOW, key_value);
  93   4            }
  94   3          }
  95   2          else
  96   2            key_last_value = KEY_INVALID;
  97   2        }
  98   1        else
  99   1          key_last_value = KEY_INVALID;
 100   1      
 101   1      #ifdef __LOCK_AUDIO_SUPPORT__
 102   1        if (mmi_dq_aud_get_end_flag() != 0)
 103   1          mmi_dq_ms_set_msg_que(QUE_EVENT_AUDIO_END, QUE_PRO_LOW, 0);
 104   1      #endif
 105   1      
 106   1        if (mmi_dq_rst_get_state() != 0)
 107   1          mmi_dq_ms_set_msg_que(QUE_EVENT_RST, QUE_PRO_LOW, 0);
 108   1      
 109   1        if (mmi_dq_sys_get_timer2_flag() != 0)
 110   1          mmi_dq_ms_set_msg_que(QUE_EVENT_TIMER_END, QUE_PRO_LOW, 0);
 111   1      
 112   1      #ifdef __LOCK_FP_SUPPORT__
                  //check fp press
                  // if (mmi_dq_fp_work() != 0)
                  //  mmi_dq_ms_set_msg_que(QUE_EVENT_FP, QUE_PRO_LOW, 0);
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 3   

              #endif
 117   1      
 118   1      #ifdef __LOCK_WIFI_SUPPORT__
 119   1        if (mmi_dq_sys_get_wifi_check_flag() != 0)
 120   1          mmi_dq_ms_set_msg_que(QUE_EVENT_WIFI_CHECK, QUE_PRO_LOW, 0);
 121   1      #endif
 122   1      
 123   1        return;
 124   1      }
 125          
 126          /*
 127          parameter: 
 128            none
 129          return :
 130            none
 131          */
 132          void mmi_sleep_task_proc(void)
 133          {
 134   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 135   1        unsigned char ret = 0xFF;
 136   1        static unsigned char time_count = 0;
 137   1      
 138   1        time_count++;
 139   1        if (time_count > 4)
 140   1        {
 141   2          time_count = 0;
 142   2          ret = mmi_dq_rfid_check();
 143   2        }
 144   1      #endif
 145   1      
 146   1        if (
 147   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 148   1          (ret == RET_SUCESS) ||
 149   1      #endif
 150   1          (mmi_dq_key_check() != 0) || (mmi_dq_rst_get_pin() != 0)
 151   1      #ifdef __LOCK_FP_SUPPORT__
                  || (mmi_dq_fp_get_pin() == 1)
              #endif
 154   1        )
 155   1        {
 156   2          key_last_value = mmi_dq_get_key_map(dqiot_drv_get_touch_value());
 157   2          mmi_dq_sys_wake_up();
 158   2        }
 159   1      
 160   1      #ifdef __LOCK_WIFI_SUPPORT__
 161   1        //if(mmi_dq_sys_get_wifi_check_flag() != 0)
 162   1        //  mmi_dq_ms_set_msg_que(QUE_EVENT_WIFI_CHECK,QUE_PRO_LOW,0);
 163   1      #endif
 164   1      
 165   1        return;
 166   1      }
 167          
 168          /*
 169          parameter: 
 170            none
 171          return :
 172            none
 173          */
 174          void mmi_wait_sleep_task_proc(void)
 175          {
 176   1      //unsigned int timer1_count = 0;
 177   1      #ifdef __LOCK_WIFI_SUPPORT__
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 4   

 178   1        if (mmi_dq_wifi_get_running_flag() == 1)
 179   1          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 180   1        //if((mmi_dq_rfid_check() == RET_SUCESS) || (mmi_dq_key_check() != 0) || (mmi_dq_rst_get_pin() == 0))
 181   1        else
 182   1      #endif
 183   1          if (mmi_dq_ms_get_run_flag() == 0)
 184   1        {
 185   2          mmi_dq_sys_enter_sleep();
 186   2        }
 187   1      
 188   1        return;
 189   1      }
 190          
 191          /*
 192          parameter: 
 193            none
 194          return :
 195            none
 196          */
 197          unsigned char mmi_dq_ms_get_run_flag(void)
 198          {
 199   1        if ((key_last_value == KEY_INVALID)
 200   1      #ifdef __LOCK_AUDIO_SUPPORT__
 201   1          && (mmi_dq_aud_get_state() == 0)
 202   1      #endif
 203   1          && (mmi_dq_rst_get_pin() == 0)
 204   1      #ifdef __LOCK_FP_SUPPORT__
                  && (mmi_dq_fp_get_pin() != 1)
              #endif
 207   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 208   1          && rfid_last_flag == 0
 209   1      #endif
 210   1        )
 211   1          return 0;
 212   1      
 213   1        return 1;
 214   1      }
 215          
 216          /*
 217          parameter: 
 218            none
 219          return :
 220            none
 221          */
 222          void mmi_dq_ms_sys_msg_handle(void)
 223          {
 224   1        Sys_MSG_Queue_M sys_msg_que;
 225   1        if (mmi_OutQueue(&sys_msg_que))
 226   1        {
 227   2          mmi_dq_sys_sleep_timer_reset();
 228   2          switch (sys_msg_que.que_event)
 229   2          {
 230   3          case QUE_EVENT_KEY:
 231   3            mmi_ms_pwd_opt_fun(sys_msg_que.que_data);
 232   3            break;
 233   3      #ifdef __LOCK_FP_SUPPORT__
                  case QUE_EVENT_FP:
                    mmi_ms_fps_opt_fun(sys_msg_que.que_data);
                    break;
              #endif
 238   3      #ifdef __LOCK_RFID_CARD_SUPPORT__
 239   3          case QUE_EVENT_RFID:
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 5   

 240   3            mmi_ms_rfid_opt_fun(sys_msg_que.que_data);
 241   3            break;
 242   3      #endif
 243   3          case QUE_EVENT_RST:
 244   3            mmi_ms_reset_opt_fun();
 245   3            break;
 246   3          case QUE_EVENT_AUDIO_END:
 247   3      
 248   3            break;
 249   3          case QUE_EVENT_TIMER_END:
 250   3            mmi_dq_sys_delay_event_pro();
 251   3            break;
 252   3      #ifdef __LOCK_WIFI_SUPPORT__
 253   3          case QUE_EVENT_WIFI_CHECK:
 254   3            mmi_ms_wifi_opt_fun();
 255   3            break;
 256   3      #endif
 257   3          default:
 258   3            break;
 259   3          }
 260   2        }
 261   1      }
 262          
 263          /*
 264          parameter: 
 265            none
 266          return :
 267            none
 268          */
 269          void mmi_dq_ms_set_msg_que(SYS_QUEUE_EVENT q_event, SYS_QUEUE_PRO q_pro, unsigned char q_data)
 270          {
 271   1        Sys_MSG_Queue_M que;
 272   1        que.que_event = q_event;
 273   1        que.que_pro = q_pro;
 274   1        que.que_data = q_data;
 275   1        //printf("mmi_dq_ms_set_msg_que  event : %d",q_event);
 276   1        mmi_InQueue(que);
 277   1        return;
 278   1      }
 279          
 280          /*
 281          parameter: 
 282            none
 283          return :
 284            none
 285          */
 286          void mmi_dq_ms_set_sys_state(SYS_BASE_STATUS state)
 287          {
 288   1        sys_state = state;
 289   1        return;
 290   1      }
 291          
 292          /*
 293          parameter: 
 294            none
 295          return :
 296            none
 297          */
 298          SYS_BASE_STATUS mmi_dq_ms_get_sys_state(void)
 299          {
 300   1        return sys_state;
 301   1      }
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 6   

 302          
 303          /*
 304          parameter: 
 305            none
 306          return :
 307            none
 308          */
 309          void mmi_ms_pwd_init_var(void)
 310          {
 311   1        key_len = 0;
 312   1        opt_time = OPT_ONE_TIME;
 313   1        memset(input_key_1, 0xFF, sizeof(input_key_1));
 314   1        memset(input_key_2, 0xFF, sizeof(input_key_2));
 315   1      }
 316          
 317          /*
 318          parameter: 
 319            none
 320          return :
 321            none
 322          */
 323          void mmi_ms_opt_time_init(void)
 324          {
 325   1        opt_time = OPT_ONE_TIME;
 326   1      }
 327          
 328          /*
 329          parameter: 
 330            none
 331          return :
 332            none
 333          */
 334          void mmi_ms_pwd_opt_fun(unsigned char key_val)
 335          {
 336   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
 337   1        //printf("mmi_ms_pwd_opt_fun status: 0x%x  key: %d",status,key_val);
 338   1        switch (status)
 339   1        {
 340   2        case SYS_STATUS_WAIT_FOR_ENTER_SLEEP:
 341   2          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 342   2          status = SYS_STATUS_IDLE;
 343   2        case SYS_STATUS_INPUT_PWD:
 344   2        case SYS_STATUS_INPUT_ADMIN_PWD:
 345   2        case SYS_STATUS_ADD_PWD:
 346   2        case SYS_STATUS_DEL_PWD:
 347   2        case SYS_STATUS_ADD_ADMIN_PWD:
 348   2        case SYS_STATUS_CHG_ADMIN_PWD:
 349   2      #ifdef __LOCK_110_SUPPORT__
 350   2        case SYS_STATUS_ADD_110_PWD:
 351   2      #endif
 352   2          if (mmi_dq_sys_door_state_check() == 1)
 353   2          {
 354   3      #ifdef __LOCK_AUDIO_SUPPORT__
 355   3            mmi_dq_aud_stop();
 356   3            mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
 357   3      #endif
 358   3      #ifdef __LOCK_WIFI_SUPPORT__
 359   3            mmi_dq_wifi_pw_alarm();
 360   3      #endif
 361   3            return;
 362   3          }
 363   2          if (key_len == 0)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 7   

 364   2          {
 365   3            if (key_val == KEY_S)
 366   3            {
 367   4              if (SYS_STATUS_ADD_ADMIN_PWD != status)
 368   4              {
 369   5      #ifdef __LOCK_AUDIO_SUPPORT__
 370   5                mmi_dq_aud_play_key_tone();
 371   5      #endif
 372   5                if (status == SYS_STATUS_INPUT_PWD)
 373   5                  //mmi_dq_sys_enter_sleep();
 374   5                  mmi_dq_ms_set_sys_state(SYS_STATUS_WAIT_FOR_ENTER_SLEEP);
 375   5                else if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 376   5                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 377   5      #ifdef __LOCK_WIFI_SUPPORT__
 378   5                else if (wifi_add_flag == 1)
 379   5                {
 380   6                  wifi_add_flag = 0xff;
 381   6                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 382   6                }
 383   5                else
 384   5      #endif
 385   5                  mmi_dq_sys_show_cur_menu_list();
 386   5              }
 387   4              break;
 388   4            }
 389   3            else if (key_val == KEY_H)
 390   3            {
 391   4              if (status == SYS_STATUS_INPUT_PWD)
 392   4              {
 393   5      #ifdef __LOCK_AUDIO_SUPPORT__
 394   5                mmi_dq_aud_play_key_tone();
 395   5      #endif
 396   5      #ifdef __LOCK_BUS_SUPPORT__
 397   5                admin_check_type = 0;
 398   5      #endif
 399   5      #ifdef __LOCK_AUDIO_SUPPORT__
 400   5                mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD);
 401   5      #endif
 402   5                mmi_dq_ms_set_sys_state(SYS_STATUS_INPUT_ADMIN_PWD);
 403   5              }
 404   4              break;
 405   4            }
 406   3          }
 407   2      
 408   2      // mmi_dq_aud_play_key_num(key_val);
 409   2      #ifdef __LOCK_AUDIO_SUPPORT__
 410   2          mmi_dq_aud_play_key_tone();
 411   2      #endif
 412   2          //input pwd
 413   2          if ((key_val >= KEY_0 && key_val <= KEY_9) && key_len < KEY_INPUT_MAX_LEN)
 414   2          {
 415   3            if ((status == SYS_STATUS_INPUT_PWD) || (status == SYS_STATUS_INPUT_ADMIN_PWD))
 416   3              input_key_1[key_len++] = key_val;
 417   3            else // if((status == SYS_STATUS_ADD_PWD)||(status == SYS_STATUS_ADD_110_PWD)||(status == SYS_STATUS_AD
             -D_ADMIN_PWD))
 418   3            {
 419   4              if (opt_time == OPT_ONE_TIME)
 420   4              {
 421   5                input_key_1[key_len++] = key_val;
 422   5              }
 423   4              else if (opt_time == OPT_TWO_TIME)
 424   4              {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 8   

 425   5                input_key_2[key_len++] = key_val;
 426   5              }
 427   4            }
 428   3          }
 429   2      
 430   2          if (key_val == KEY_S)
 431   2          {
 432   3            if (opt_time == OPT_ONE_TIME)
 433   3              input_key_1[key_len--] = 0xFF;
 434   3            else if (opt_time == OPT_TWO_TIME)
 435   3              input_key_2[key_len--] = 0xFF;
 436   3      
 437   3            if (key_len == 0)
 438   3            {
 439   4              if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 440   4      #ifdef __LOCK_AUDIO_SUPPORT__
 441   4                mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD)
 442   4      #endif
 443   4                  ;
 444   4              else if (opt_time == OPT_ONE_TIME)
 445   4              {
 446   5      #ifdef __LOCK_AUDIO_SUPPORT__
 447   5                if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 448   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_68_PWD);
 449   5                else if (status == SYS_STATUS_DEL_PWD)
 450   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_NUM);
 451   5                else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 452   5                  mmi_dq_aud_play_with_id(AUD_ID_ADD_ADMIN_PWD_FIRST);
 453   5                else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 454   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD);
 455   5      #endif
 456   5              }
 457   4              else if (opt_time == OPT_TWO_TIME)
 458   4              {
 459   5      #ifdef __LOCK_AUDIO_SUPPORT__
 460   5                if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 461   5                  mmi_dq_aud_play_with_id(AUD_ID_PWD_INPUT_AGAIN);
 462   5                else if (status == SYS_STATUS_DEL_PWD)
 463   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_PWD_AGAIN);
 464   5                else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 465   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD_INIT_AGAIN);
 466   5                else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 467   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD_AGAIN);
 468   5      #endif
 469   5              }
 470   4            }
 471   3          }
 472   2          else if ((key_val == KEY_H) || (key_len == PWD_INPUT_MAX_LEN))
 473   2          {
 474   3            if (key_len < PWD_INPUT_MIN_LEN)
 475   3            {
 476   4              if (status == SYS_STATUS_INPUT_PWD)
 477   4              {
 478   5                if (key_len == 2 && input_key_1[0] == KEY_0 && input_key_1[1] == KEY_0) //00 è¿œç¨‹å¼€é—¨
 479   5                  mmi_dq_sys_wifi_open();
 480   5      #ifdef __LOCK_WIFI_SUPPORT__
 481   5                else if (key_len == 1 && input_key_1[0] == KEY_5) //5 æ·»åŠ åˆ é™¤å¯†ç /æŒ‡çº¹/RFå¡
 482   5                  mmi_dq_wifi_cmd_add_del();
 483   5                else if (key_len == 1 && input_key_1[0] == KEY_6) //6 è®¾ç½®æ‹ç…§/å½•åƒå¼€å…³
 484   5                  mmi_dq_wifi_pv_switch();
 485   5                else if (key_len == 2 && input_key_1[0] == KEY_1 && input_key_1[1] == KEY_8) //18 åº”æ€¥é’¥åŒ™å¼€é—¨æ
             -ˆåŠŸ
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 9   

 486   5                {
 487   6      #ifdef __LOCK_DECODE_SUPPORT__
 488   6                  unsigned char i;
 489   6                  unsigned char random_code[15] = {5, 6, 4, 8, 0, 4, 7, 5, 7, 7, 9, 8, 0, 1, 8};
 490   6                  mmi_dq_decode_app_random_code(&random_code);
 491   6      #endif
 492   6                }
 493   5      
 494   5                //  mmi_dq_wifi_open_by_key();
 495   5                // else if (key_len == 2 && input_key_1[0] == KEY_1 && input_key_1[1] == KEY_9) //19 é—¨æœªå…³
 496   5                //  mmi_dq_wifi_close_over_time();
 497   5                // else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_0) //20 éœ‡åŠ¨æŠ¥è­¦
 498   5                //  mmi_dq_wifi_via_alarm();
 499   5                // else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_5) //25 ç¡çœ 
 500   5                //  mmi_dq_wifi_sleep();
 501   5                // else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_6) //26 å”¤é†’
 502   5                //  mmi_dq_wifi_wakeup();
 503   5                // else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_7) //27 æ‹ç…§
 504   5                //  mmi_dq_wifi_take_photos();
 505   5                // else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_8) //28 å½•åƒ
 506   5                //  mmi_dq_wifi_take_videos();
 507   5                // else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_0) //30 æŸ¥è¯¢ç½‘ç»œçŠ¶æ
             -€
 508   5                //  mmi_dq_wifi_check_net();
 509   5                // else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_1) //31 Airkissé…ç½‘(ad
             -min 8)
 510   5                //  mmi_dq_wifi_arikiss_con();
 511   5                // else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_2) //32 äºŒç»´ç é…ç½‘(
             -admin 9)
 512   5                //  mmi_dq_wifi_code_con();
 513   5      #endif
 514   5      #ifdef __LOCK_BUS_SUPPORT__
 515   5                else if (key_len == 2 && input_key_1[0] == KEY_0 && input_key_1[1] == KEY_1) //01
 516   5                {
 517   6      
 518   6                  if (mmi_dq_fs_get_business_flag() == 1)
 519   6                  {
 520   7                    admin_check_type = 1;
 521   7      #ifdef __LOCK_AUDIO_SUPPORT__
 522   7                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD);
 523   7      #endif
 524   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_INPUT_ADMIN_PWD);
 525   7                  }
 526   6                  else
 527   6                  {
 528   7                    mmi_dq_fs_set_business_flag(1);
 529   7      #ifdef __LOCK_AUDIO_SUPPORT__
 530   7                    mmi_dq_aud_play_with_id(AUD_ID_OUT_OPEN);
 531   7      #endif
 532   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 533   7                  }
 534   6                }
 535   5      #endif
 536   5                else
 537   5                {
 538   6                  mmi_dq_sys_door_open_fail(SYS_OPEN_BY_PASSWORD);
 539   6                }
 540   5                key_len = 0;
 541   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 542   5              }
 543   4              else
 544   4              {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 10  

 545   5      #ifdef __LOCK_AUDIO_SUPPORT__
 546   5                mmi_dq_aud_play_with_id(AUD_ID_PWD_68_LEN);
 547   5      #endif
 548   5                key_len = 0;
 549   5                if (opt_time == OPT_ONE_TIME)
 550   5                  memset(input_key_1, 0xFF, sizeof(input_key_1));
 551   5                else if (opt_time == OPT_TWO_TIME)
 552   5                  memset(input_key_2, 0xFF, sizeof(input_key_2));
 553   5              }
 554   4            }
 555   3            else
 556   3            {
 557   4      #ifdef __LOCK_VIRTUAL_PASSWORD__
                      if (1) //æµ‹è¯•ä¸ŽAPPæ˜¯å¦è¿žæŽ¥æˆåŠŸ
                      {
              
                        mmi_dq_fs_check_input_pwd_from_app(input_key_1, key_len);
                        key_len = 0;
                        // return SUCESS;
                      }
                      else
              #endif //__LOCK_VIRTUAL_PASSWORD__
 567   4                if (status == SYS_STATUS_INPUT_PWD)
 568   4              {
 569   5                //if(mmi_dq_fs_check_input_pwd(input_key_1,key_len,FDS_USE_TYPE_ALL) == 0xFF)
 570   5                unsigned char ret = 0;
 571   5                ret = mmi_dq_fs_check_input_pwd_for_open(input_key_1, key_len);
 572   5                //printf("check input ret: %d",(unsigned int)ret);
 573   5                if (ret == 0xFF)
 574   5                  mmi_dq_sys_door_open_fail(SYS_OPEN_BY_PASSWORD);
 575   5      #ifdef __LOCK_BUS_SUPPORT__
 576   5                else if (ret == 0xFE && mmi_dq_fs_get_business_flag() == 1)
 577   5                {
 578   6                  mmi_dq_fs_set_business_flag(0);
 579   6      #ifdef __LOCK_AUDIO_SUPPORT__
 580   6                  mmi_dq_aud_play_with_id(AUD_ID_OUT_CLOSED);
 581   6      #endif
 582   6                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 583   6                }
 584   5      #endif
 585   5      #ifdef __LOCK_110_SUPPORT__
 586   5                else if (ret == 1)
 587   5                  mmi_dq_sys_door_open(SYS_OPEN_BY_110_PASSWORD);
 588   5      #endif
 589   5                else
 590   5                  mmi_dq_sys_door_open(SYS_OPEN_BY_PASSWORD);
 591   5                key_len = 0;
 592   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 593   5              }
 594   4              else if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 595   4              {
 596   5                if (mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == 0xFF)
 597   5      #ifdef __LOCK_AUDIO_SUPPORT__
 598   5                  mmi_dq_aud_play_with_id(AUD_ID_PWD_WRONG_TRY)
 599   5      #endif
 600   5                    ;
 601   5                else
 602   5                {
 603   6      #ifdef __LOCK_BUS_SUPPORT__
 604   6                  if (admin_check_type == 1)
 605   6                  {
 606   7                    mmi_dq_fs_set_business_flag(0);
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 11  

 607   7      #ifdef __LOCK_AUDIO_SUPPORT__
 608   7                    mmi_dq_aud_play_with_id(AUD_ID_OUT_CLOSED);
 609   7      #endif
 610   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 611   7                  }
 612   6                  else
 613   6      #endif
 614   6                  {
 615   7                    mmi_dq_sys_set_menu_father_id(STR_ID_SYSTEM);
 616   7                    mmi_dq_sys_show_cur_menu_list();
 617   7                  }
 618   6                }
 619   5                key_len = 0;
 620   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 621   5              }
 622   4              else // if((status == SYS_STATUS_ADD_PWD)||(status == SYS_STATUS_DEL_PWD)||(status == SYS_STATUS_ADD_A
             -DMIN_PWD)||(status == SYS_STATUS_CHG_ADMIN_PWD)||(status == SYS_STATUS_ADD_110_PWD))
 623   4              {
 624   5                if (opt_time == OPT_ONE_TIME)
 625   5                {
 626   6      #ifdef __LOCK_AUDIO_SUPPORT__
 627   6                  if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 628   6                    mmi_dq_aud_play_with_id(AUD_ID_PWD_INPUT_AGAIN);
 629   6                  else if (status == SYS_STATUS_DEL_PWD)
 630   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_PWD_AGAIN);
 631   6                  else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 632   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD_INIT_AGAIN);
 633   6                  else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 634   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD_AGAIN);
 635   6      #endif
 636   6      
 637   6                  opt_time = OPT_TWO_TIME;
 638   6                  key_len = 0;
 639   6                  memset(input_key_2, 0xFF, sizeof(input_key_2));
 640   6                }
 641   5                else if (opt_time == OPT_TWO_TIME)
 642   5                {
 643   6                  if (0 == memcmp(input_key_1, input_key_2, PWD_INPUT_MAX_LEN))
 644   6                  {
 645   7                    if (status == SYS_STATUS_DEL_PWD)
 646   7                    {
 647   8                      unsigned char del_index = mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_USER);
 648   8                      if (del_index == 0xFF)
 649   8      #ifdef __LOCK_AUDIO_SUPPORT__
 650   8                        mmi_dq_aud_play_with_id(AUD_ID_PWD_NOT_EXIST)
 651   8      #endif
 652   8                          ;
 653   8                      else
 654   8                      {
 655   9                        if (mmi_dq_fs_del_pwd(del_index, FDS_USE_TYPE_USER) == RET_SUCESS)
 656   9                        {
 657  10                          get_index = del_index;
 658  10      #ifdef __LOCK_AUDIO_SUPPORT__
 659  10                          mmi_dq_aud_play_with_id(AUD_ID_DEL_PWD_SUCESS);
 660  10      #endif
 661  10      #ifdef __LOCK_WIFI_SUPPORT__
 662  10                          mmi_dq_wifi_del_password(get_index);
 663  10      #endif
 664  10                          // printfV("get_index", (int)get_index);
 665  10                        }
 666   9                        else
 667   9      #ifdef __LOCK_AUDIO_SUPPORT__
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 12  

 668   9                          mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL)
 669   9      #endif
 670   9                            ;
 671   9                        mmi_dq_sys_del_pwd_con();
 672   9                      }
 673   8                    }
 674   7                    else if (mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_ALL) != 0xFF)
 675   7      #ifdef __LOCK_AUDIO_SUPPORT__
 676   7                      mmi_dq_aud_play_with_id(AUD_ID_PWD_EXIST)
 677   7      #endif
 678   7                        ;
 679   7                    else
 680   7                    {
 681   8                      if (status == SYS_STATUS_ADD_PWD)
 682   8                      {
 683   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_USER) == RET_FAIL)
 684   9      #ifdef __LOCK_AUDIO_SUPPORT__
 685   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL)
 686   9      #endif
 687   9                            ;
 688   9                        else
 689   9                        {
 690  10      #ifdef __LOCK_AUDIO_SUPPORT__
 691  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_PWD_SUCESS);
 692  10      #endif
 693  10      #ifdef __LOCK_WIFI_SUPPORT__
 694  10                          mmi_dq_wifi_add_password(get_index);
 695  10      #endif
 696  10                          // printfV("get_index", (int)get_index);
 697  10                        }
 698   9      #ifdef __LOCK_WIFI_SUPPORT__
 699   9                        if (wifi_add_flag == 1)
 700   9                        {
 701  10                          wifi_add_flag = 0xff;
 702  10                          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 703  10                        }
 704   9                        else
 705   9      #endif
 706   9                          mmi_dq_sys_add_pwd_con();
 707   9                      }
 708   8                      else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 709   8                      {
 710   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == RET_FAIL)
 711   9      #ifdef __LOCK_AUDIO_SUPPORT__
 712   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL)
 713   9      #endif
 714   9                            ;
 715   9                        else
 716   9                        {
 717  10      #ifdef __LOCK_AUDIO_SUPPORT__
 718  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_ADMIN_PWD_INIT_SUCESS);
 719  10      #endif
 720  10      #ifdef __LOCK_WIFI_SUPPORT__
 721  10                          mmi_dq_wifi_add_password(get_index);
 722  10      #endif
 723  10                          // printfV("get_index", (int)get_index);
 724  10                        }
 725   9      #ifdef __LOCK_FP_SUPPORT__
                                mmi_dq_sys_chg_admin_fp_No1();
              #else
 728   9                        if (0 == mmi_dq_fs_get_admin_status())
 729   9                          mmi_dq_sys_lock_add_admin_suc();
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 13  

 730   9                        else
 731   9                          mmi_dq_sys_show_cur_menu_list();
 732   9      #endif
 733   9                      }
 734   8                      else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 735   8                      {
 736   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == RET_FAIL)
 737   9      #ifdef __LOCK_AUDIO_SUPPORT__
 738   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL)
 739   9      #endif
 740   9                            ;
 741   9                        else
 742   9                        {
 743  10      #ifdef __LOCK_AUDIO_SUPPORT__
 744  10                          mmi_dq_aud_play_with_id(AUD_ID_CHG_ADMIN_PWD_SUCESS);
 745  10      #endif
 746  10      #ifdef __LOCK_WIFI_SUPPORT__
 747  10                          mmi_dq_wifi_add_password(get_index);
 748  10      #endif
 749  10                          // printfV("get_index", (int)get_index);
 750  10                        }
 751   9                        mmi_dq_sys_show_cur_menu_list();
 752   9                      }
 753   8      #ifdef __LOCK_110_SUPPORT__
 754   8                      else if (status == SYS_STATUS_ADD_110_PWD)
 755   8                      {
 756   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_110) == RET_FAIL)
 757   9      #ifdef __LOCK_AUDIO_SUPPORT__
 758   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL)
 759   9      #endif
 760   9                            ;
 761   9                        else
 762   9                        {
 763  10      #ifdef __LOCK_WIFI_SUPPORT__
 764  10                          mmi_dq_wifi_set_110();
 765  10      #endif
 766  10      #ifdef __LOCK_AUDIO_SUPPORT__
 767  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_PWD_SUCESS);
 768  10      #endif
 769  10      #ifdef __LOCK_WIFI_SUPPORT__
 770  10                          mmi_dq_wifi_add_password(get_index);
 771  10      #endif
 772  10                          // printfV("get_index", (int)get_index);
 773  10                        }
 774   9                        mmi_dq_sys_show_cur_menu_list();
 775   9                      }
 776   8      #endif
 777   8                    }
 778   7                  }
 779   6                  else
 780   6                  {
 781   7      #ifdef __LOCK_AUDIO_SUPPORT__
 782   7                    mmi_dq_aud_play_with_id(AUD_ID_PWD_NOT_SAME_RETRY);
 783   7      #endif
 784   7                  }
 785   6                  mmi_ms_pwd_init_var();
 786   6                }
 787   5              }
 788   4            }
 789   3            return;
 790   3          }
 791   2          break;
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 14  

 792   2      #ifdef __LOCK_FP_SUPPORT__
                case SYS_STATUS_ADD_FP:
                case SYS_STATUS_DEL_FP:
              #ifdef __LOCK_110_SUPPORT__
                case SYS_STATUS_ADD_110_FP:
                case SYS_STATUS_DEL_110_FP:
              #endif
              #endif
 800   2      #ifdef __LOCK_RFID_CARD_SUPPORT__
 801   2        case SYS_STATUS_ADD_RFID:
 802   2        case SYS_STATUS_DEL_RFID:
 803   2      #endif
 804   2          if (key_val == KEY_S)
 805   2          {
 806   3      #ifdef __LOCK_AUDIO_SUPPORT__
 807   3            mmi_dq_aud_play_key_tone();
 808   3      #endif
 809   3      #ifdef __LOCK_WIFI_SUPPORT__
 810   3            if (wifi_add_flag == 1)
 811   3            {
 812   4              wifi_add_flag = 0xff;
 813   4              mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 814   4            }
 815   3            else
 816   3      #endif
 817   3              mmi_dq_sys_show_cur_menu_list();
 818   3          }
 819   2          break;
 820   2      #ifdef __LOCK_FP_SUPPORT__
                case SYS_STATUS_ADD_ADMIN_FP1:
                case SYS_STATUS_ADD_ADMIN_FP2:
                  if (key_val == KEY_S)
                  {
              #ifdef __LOCK_AUDIO_SUPPORT__
                    mmi_dq_aud_play_key_tone();
              #endif
                    if (0 == mmi_dq_fs_get_admin_status())
                      mmi_dq_sys_lock_add_admin_suc();
                    else
                      mmi_dq_sys_show_cur_menu_list();
                  }
                  break;
              #endif
 835   2        case SYS_STATUS_CLR_PWD:
 836   2        case SYS_STATUS_ADD_PWD_CON:
 837   2        case SYS_STATUS_DEL_PWD_CON:
 838   2      #ifdef __LOCK_FP_SUPPORT__
                case SYS_STATUS_CLR_FP:
                case SYS_STATUS_ADD_FP_CON:
                case SYS_STATUS_DEL_FP_CON:
              #endif
 843   2      #ifdef __LOCK_RFID_CARD_SUPPORT__
 844   2        case SYS_STATUS_CLR_RFID:
 845   2        case SYS_STATUS_ADD_RFID_CON:
 846   2        case SYS_STATUS_DEL_RFID_CON:
 847   2      #endif
 848   2        case SYS_STATUS_RESTORE_LOCK_CON:
 849   2          if (key_val == KEY_H)
 850   2          {
 851   3      #ifdef __LOCK_AUDIO_SUPPORT__
 852   3            mmi_dq_aud_play_key_tone();
 853   3      #endif
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 15  

 854   3            switch (status)
 855   3            {
 856   4            case SYS_STATUS_CLR_PWD:
 857   4              if (RET_SUCESS == mmi_dq_fs_clr_pwd())
 858   4              {
 859   5      #ifdef __LOCK_AUDIO_SUPPORT__
 860   5                mmi_dq_aud_play_with_id(AUD_ID_CLR_PWD_SUCESS)
 861   5      #endif
 862   5                  ;
 863   5      #ifdef __LOCK_WIFI_SUPPORT__
 864   5                mmi_dq_wifi_clr_pwd_suc();
 865   5      #endif
 866   5              }
 867   4              else
 868   4      #ifdef __LOCK_AUDIO_SUPPORT__
 869   4                mmi_dq_aud_play_with_id(AUD_ID_CLR_PWD_FAIL)
 870   4      #endif
 871   4                  ;
 872   4              mmi_dq_sys_show_cur_menu_list();
 873   4              break;
 874   4      #ifdef __LOCK_FP_SUPPORT__
                    case SYS_STATUS_CLR_FP:
                      if (RET_SUCESS == mmi_dq_fs_clr_fp())
                      {
              #ifdef __LOCK_AUDIO_SUPPORT__
                        mmi_dq_aud_play_with_id(AUD_ID_CLR_FP_SUCESS);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                        mmi_dq_wifi_clr_fps_suc();
              #endif
                      }
                      else
              #ifdef __LOCK_AUDIO_SUPPORT__
                        mmi_dq_aud_play_with_id(AUD_ID_CLR_FP_FAIL)
              #endif
                          ;
                      mmi_dq_sys_show_cur_menu_list();
                      break;
              #endif
 893   4      #ifdef __LOCK_RFID_CARD_SUPPORT__
 894   4            case SYS_STATUS_CLR_RFID:
 895   4              if (RET_SUCESS == mmi_dq_fs_clr_rfid())
 896   4              {
 897   5      #ifdef __LOCK_AUDIO_SUPPORT__
 898   5                mmi_dq_aud_play_with_id(AUD_ID_CLR_RFCARD_SUCESS);
 899   5      #endif
 900   5      #ifdef __LOCK_WIFI_SUPPORT__
 901   5                mmi_dq_wifi_clr_rfid_suc();
 902   5      #endif
 903   5              }
 904   4              else
 905   4      #ifdef __LOCK_AUDIO_SUPPORT__
 906   4                mmi_dq_aud_play_with_id(AUD_ID_CLR_RFCARD_FAIL)
 907   4      #endif
 908   4                  ;
 909   4              mmi_dq_sys_show_cur_menu_list();
 910   4              break;
 911   4      #endif
 912   4            case SYS_STATUS_ADD_PWD_CON:
 913   4              mmi_dq_sys_add_pwd();
 914   4              break;
 915   4            case SYS_STATUS_DEL_PWD_CON:
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 16  

 916   4              mmi_dq_sys_del_pwd();
 917   4              break;
 918   4      #ifdef __LOCK_FP_SUPPORT__
                    case SYS_STATUS_ADD_FP_CON:
                      mmi_dq_sys_add_fp();
                      break;
                    case SYS_STATUS_DEL_FP_CON:
                      mmi_dq_sys_del_fp();
                      break;
              #endif
 926   4      #ifdef __LOCK_RFID_CARD_SUPPORT__
 927   4            case SYS_STATUS_ADD_RFID_CON:
 928   4              mmi_dq_sys_add_rf();
 929   4              break;
 930   4            case SYS_STATUS_DEL_RFID_CON:
 931   4              mmi_dq_sys_del_rf();
 932   4              break;
 933   4      #endif
 934   4            case SYS_STATUS_RESTORE_LOCK_CON:
 935   4              mmi_dq_sys_restore_lock();
 936   4              break;
 937   4            }
 938   3          }
 939   2          else if (key_val == KEY_S)
 940   2          {
 941   3      #ifdef __LOCK_AUDIO_SUPPORT__
 942   3            mmi_dq_aud_play_key_tone();
 943   3      #endif
 944   3            mmi_dq_sys_show_cur_menu_list();
 945   3          }
 946   2          break;
 947   2        case SYS_STATUS_SYS_MENU:
 948   2          if (key_val == KEY_S)
 949   2          {
 950   3      #ifdef __LOCK_AUDIO_SUPPORT__
 951   3            mmi_dq_aud_play_key_tone();
 952   3      #endif
 953   3            mmi_dq_sys_get_pre_menu_list();
 954   3          }
 955   2          else if (key_val != KEY_0 && key_val <= mmi_dq_sys_get_menu_count())
 956   2          {
 957   3      #ifdef __LOCK_AUDIO_SUPPORT__
 958   3            mmi_dq_aud_play_key_tone();
 959   3      #endif
 960   3            mmi_dq_sys_exe_menu_fun(key_val - 1);
 961   3          }
 962   2          break;
 963   2      #ifdef __FACTORY_TEST_SUPPORT__
 964   2        case SYS_STATUS_FM_MODE:
 965   2        {
 966   3          unsigned char str = mmi_dq_factory_mode_get_test_project();
 967   3          if (str == STR_ID_KEY)
 968   3          {
 969   4      #ifdef __LOCK_AUDIO_SUPPORT__
 970   4            // mmi_dq_aud_play_key_num(key_val);
 971   4            mmi_dq_aud_play_key_tone();
 972   4      #endif
 973   4            mmi_dq_factory_mode_key_test(key_val);
 974   4          }
 975   3          else if (str == STR_ID_MOTO)
 976   3          {
 977   4            if (key_val == KEY_S)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 17  

 978   4            {
 979   5      #ifdef __LOCK_AUDIO_SUPPORT__
 980   5              mmi_dq_aud_play_key_tone();
 981   5      #endif
 982   5      #ifdef __LOCK_MOTOR_SUPPORT__
 983   5              mmi_dq_factory_mode_motor_test_back();
 984   5      #endif
 985   5              if (mmi_dq_fs_get_factory_flag() != 0)
 986   5                mmi_dq_factory_mode_test_stop();
 987   5              else
 988   5              {
 989   6      #ifdef __LOCK_MOTOR_SUPPORT__
 990   6                delay_ms(600);
 991   6                mmi_dq_factory_mode_motor_test();
 992   6      #endif
 993   6              }
 994   5            }
 995   4            else if (key_val == KEY_H)
 996   4            {
 997   5      #ifdef __LOCK_AUDIO_SUPPORT__
 998   5              mmi_dq_aud_play_key_tone();
 999   5      #endif
1000   5      #ifdef __LOCK_MOTOR_SUPPORT__
1001   5              mmi_dq_factory_mode_motor_test_back();
1002   5      #endif
1003   5              mmi_dq_factory_mode_test_item_result(STR_ID_MOTO, 1);
1004   5            }
1005   4          }
1006   3          else if (mmi_dq_fs_get_factory_flag() != 0)
1007   3          {
1008   4      #ifdef __LOCK_AUDIO_SUPPORT__
1009   4            mmi_dq_aud_play_key_tone();
1010   4      #endif
1011   4            mmi_dq_factory_mode_test_stop();
1012   4          }
1013   3        }
1014   2        break;
1015   2      #endif
1016   2      #ifdef __LOCK_WIFI_SUPPORT__
1017   2        case SYS_STATUS_WIFI_MODE:
1018   2          //if(key_val == KEY_S)
1019   2          //{
1020   2      #ifdef __LOCK_AUDIO_SUPPORT__
1021   2          mmi_dq_aud_stop();
1022   2      #endif
1023   2      #ifdef __LOCK_AUDIO_SUPPORT__
1024   2          mmi_dq_aud_play_with_id(AUD_ID_WIFI_CONNECTING);
1025   2      #endif
1026   2          //  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1027   2          //}
1028   2          break;
1029   2      #endif
1030   2        case SYS_STATUS_LOW_POWER:
1031   2      #ifdef __LOCK_AUDIO_SUPPORT__
1032   2          mmi_dq_aud_stop();
1033   2      #endif
1034   2      #ifdef __LOCK_AUDIO_SUPPORT__
1035   2          mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
1036   2      #endif
1037   2      #ifdef __LOCK_WIFI_SUPPORT__
1038   2          mmi_dq_wifi_lowpower_alarm();
1039   2      #endif
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 18  

1040   2          break;
1041   2        default:
1042   2          break;
1043   2        }
1044   1        return;
1045   1      }
*** WARNING C280 IN LINE 488 OF mmi_src\mmi_ms.c: 'i': unreferenced local variable
1046          
1047          #ifdef __LOCK_FP_SUPPORT__
              /*
              parameter: 
                none
              return :
                none
              */
              void mmi_ms_fps_opt_fun(unsigned char fps_val)
              {
                RET_VAL retval = 0;
                unsigned short index = 0;
                SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
                if (status == SYS_STATUS_LOW_POWER)
                {
              #ifdef __LOCK_AUDIO_SUPPORT__
                  mmi_dq_aud_stop();
              #endif
              #ifdef __LOCK_AUDIO_SUPPORT__
                  mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                  mmi_dq_wifi_lowpower_alarm();
              #endif
                  return;
                }
                else if (status == SYS_STATUS_WAIT_FOR_ENTER_SLEEP)
                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
              
                if ((status != SYS_STATUS_INPUT_FP && status != SYS_STATUS_ADD_FP && status != SYS_STATUS_DEL_FP && statu
             -s != SYS_STATUS_ADD_ADMIN_FP1 && status != SYS_STATUS_ADD_ADMIN_FP2 && status != SYS_STATUS_ADD_110_FP && status != SYS_
             -STATUS_DEL_110_FP)
              #ifdef __FACTORY_TEST_SUPPORT__
                  || (status == SYS_STATUS_FM_MODE && STR_ID_FINGERPRINT != mmi_dq_factory_mode_get_test_project())
              #endif
                )
                  return;
              
              #ifdef __LOCK_AUDIO_SUPPORT__
                mmi_dq_aud_stop();
              #endif
                if (mmi_dq_sys_door_state_check() == 1)
                {
              #ifdef __LOCK_AUDIO_SUPPORT__
                  mmi_dq_aud_stop();
              #endif
              #ifdef __LOCK_AUDIO_SUPPORT__
                  mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                  mmi_dq_wifi_fp_alarm();
              #endif
                  return;
                }
              
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 19  

                retval = mmi_dq_fp_get_image();
              
                if (retval == 0)
                {
                  // printfS("mmi_dq_fp_get_image", "ok");
                  // if (opt_time != 0)
                  //  retval = mmi_dq_fp_gen_char(0);
                  // if (retval == 0)
                  retval = mmi_dq_fp_gen_char(opt_time);
                  if (retval == 0)
                  {
                    // printfS("mmi_dq_fp_gen_char", "ok");
                    retval = mmi_dq_fp_high_speed_search(opt_time, &index);
                    if (retval == 0)
                    {
                      // printfS("mmi_dq_fp_high_speed_search", "ok");
                      if (status == SYS_STATUS_INPUT_FP)
                      {
                        retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_ALL);
                        if (retval == RET_SUCESS)
                        {
                          get_index = index;
                          mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_110_SUPPORT__
                          if (mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_110) == RET_SUCESS)
                          {
                            mmi_dq_sys_door_open(SYS_OPEN_BY_110_FP);
                          }
                          else
              #endif
                            mmi_dq_sys_door_open(SYS_OPEN_BY_FP);
                        }
                        else
                        {
                          mmi_dq_fp_light(FP_RED);
                          mmi_dq_sys_door_open_fail(SYS_OPEN_BY_FP);
                        }
                      }
                      else if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_ADMIN_FP1 || status == SYS_STATUS_ADD
             -_ADMIN_FP2 || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
                      {
                        mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                        mmi_dq_aud_play_with_id(AUD_ID_FP_EXIST);
              #endif
                      }
                      else if (status == SYS_STATUS_DEL_FP || status == SYS_STATUS_DEL_110_FP)
                      {
              #ifdef __LOCK_110_SUPPORT__
                        if (status == SYS_STATUS_DEL_FP)
                          retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_USER);
                        else if (status == SYS_STATUS_DEL_110_FP)
                          retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_110);
              #else
                        retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_USER);
              #endif
                        if (retval == RET_SUCESS)
                        {
                          static unsigned char del_num = 0;
                          if (opt_time == OPT_ONE_TIME)
                          {
                            opt_time = OPT_TWO_TIME;
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 20  

                            del_num = index;
                            mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                            mmi_dq_aud_play_with_id(AUD_ID_PRESS_DEL_FP_AGAIN);
              #endif
                          }
                          else
                          {
                            //retval = mmi_dq_fp_match();
                            if (del_num == index)
                              retval = 0;
                            else
                              retval = 255;
                            if (retval == 0) //|| retval == 255)
                            {
              #ifdef __LOCK_110_SUPPORT__
                              if (status == SYS_STATUS_DEL_FP)
                                retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_USER);
                              else if (status == SYS_STATUS_DEL_110_FP)
                                retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_110);
              #else
                              retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_USER);
              #endif
                              if (retval == RET_SUCESS)
                              {
                                retval = mmi_dq_fp_delete(index);
                              }
                              if (retval == 0)
                              {
                                mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                mmi_dq_aud_play_with_id(AUD_ID_DEL_FP_SUCESS);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                                mmi_dq_wifi_del_fp(index);
              #endif
                              }
                              else
                              {
                                mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL);
              #endif
                              }
              #ifdef __LOCK_110_SUPPORT__
                              if (status == SYS_STATUS_DEL_FP)
                                mmi_dq_sys_del_fp_con();
                              else if (status == SYS_STATUS_DEL_110_FP)
                                mmi_dq_sys_show_cur_menu_list();
              #else
                              mmi_dq_sys_del_fp_con();
              #endif
                            }
                            else
                            {
                              mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                              mmi_dq_aud_play_with_id(AUD_ID_FP_TWICE_NOT_SAME_RETRY);
              #endif
                            }
                            opt_time = OPT_ONE_TIME;
                          }
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 21  

                        }
                        else
                        {
                          mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                          mmi_dq_aud_play_with_id(AUD_ID_FP_NOT_EXIST);
              #endif
                        }
                      }
                    }
                    else
                    {
                      // printfS("mmi_dq_fp_high_speed_search", "error");
                      if (status == SYS_STATUS_INPUT_FP)
                      {
                        mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                        // mmi_dq_aud_play_with_id(AUD_ID_FP_WRONG_TRY);
              #endif
                        mmi_dq_sys_door_open_fail(SYS_OPEN_BY_FP);
                      }
                      else if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_ADMIN_FP1 || status == SYS_STATUS_ADD
             -_ADMIN_FP2 || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
                      {
                        if (opt_time == FPS_MAX_INPUT_TIME)
                        {
                          retval = mmi_dq_fp_reg_module();
                          if (retval == 0)
                          {
                            // printfS("mmi_dq_fp_reg_module", "ok");
                            if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
                            {
              #ifdef __LOCK_110_SUPPORT__
                              if (status == SYS_STATUS_ADD_110_FP)
                                index = mmi_dq_fs_get_fp_110_unuse_index();
                              else
              #endif
                                index = mmi_dq_fs_get_fp_unuse_index();
                              if (index == 0xFF)
                              {
                                // printfS("mmi_dq_fs_get_fp_unuse_index", "error");
                                mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                mmi_dq_aud_play_with_id(AUD_ID_FP_FULL);
              #endif
                                mmi_dq_sys_show_cur_menu_list();
                              }
                              else
                              {
                                // printfS("mmi_dq_fs_get_fp_unuse_index", "ok");
                                // printfV("index", (int)index);
                                retval = mmi_dq_fp_store_char(0, index);
                                if (status == SYS_STATUS_ADD_FP)
                                {
                                  if (retval == 0)
                                  {
                                    // printfS("mmi_dq_fp_store_char", "ok");
                                    retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_USER);
                                    if (retval != 0)
                                      mmi_dq_fp_delete(index);
                                  }
                                  if (retval == 0)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 22  

                                  {
                                    // printfS("mmi_dq_fs_set_fp", "ok");
                                    mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                                    mmi_dq_wifi_add_fp(index);
              #endif
                                  }
                                  else
                                  {
                                    // printfS("mmi_dq_fp_store_char", "error");
                                    mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
              #endif
                                  }
              #ifdef __LOCK_WIFI_SUPPORT__
                                  if (wifi_add_flag == 1)
                                  {
                                    wifi_add_flag = 0xff;
                                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
                                  }
                                  else
              #endif
                                    mmi_dq_sys_add_fp_con();
                                }
              #ifdef __LOCK_110_SUPPORT__
                                else if (status == SYS_STATUS_ADD_110_FP)
                                {
                                  if (retval == 0)
                                  {
                                    retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_110);
                                    if (retval != 0)
                                      mmi_dq_fp_delete(index);
                                  }
                                  if (retval == 0)
                                  {
                                    mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                                    mmi_dq_wifi_set_110();
                                    mmi_dq_wifi_add_fp(index);
              #endif
                                  }
                                  else
                                  {
                                    mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
              #endif
                                  }
                                  mmi_dq_sys_show_cur_menu_list();
                                }
              #endif
              #ifdef __FACTORY_TEST_SUPPORT__
                                else
                                {
                                  if (retval == 0)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 23  

                                  {
                                    retval = mmi_dq_fp_delete(index);
                                  }
                                  if (retval == 0)
                                  {
                                    mmi_dq_fp_light(FP_GREEN);
                                    mmi_dq_factory_mode_test_item_result(STR_ID_FINGERPRINT, 1);
                                  }
                                  else
                                  {
                                    mmi_dq_fp_light(FP_RED);
                                    mmi_dq_factory_mode_test_item_result(STR_ID_FINGERPRINT, 0);
                                  }
                                }
              #endif
                              }
                            }
                            else
                            {
                              if (status == SYS_STATUS_ADD_ADMIN_FP1)
                                index = 0;
                              else if (status == SYS_STATUS_ADD_ADMIN_FP2)
                                index = 1;
                              retval = mmi_dq_fp_delete(index);
                              if (retval == 0)
                                retval = mmi_dq_fp_store_char(0, index);
                              if (retval == 0)
                                retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_ADMIN);
                              if (retval == 0)
                              {
                                mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                                mmi_dq_wifi_add_fp(index);
              #endif
                              }
                              else
                              {
                                mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
              #endif
                              }
                              if (0 == mmi_dq_fs_get_admin_status())
                              {
                                if (status == SYS_STATUS_ADD_ADMIN_FP1)
                                  mmi_dq_sys_chg_admin_fp_No2();
                                else
                                  mmi_dq_sys_lock_add_admin_suc();
                              }
                              else
                                mmi_dq_sys_show_cur_menu_list();
                            }
                          }
                          else
                          {
                            mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                            mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL_RETRY);
              #endif
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 24  

                          }
                          opt_time = OPT_ONE_TIME;
                        }
                        else
                        {
                          opt_time++;
                          mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                          mmi_dq_aud_play_with_id(AUD_ID_PRESS_FP_AGAIN);
              #endif
                        }
                      }
                      else if (status == SYS_STATUS_DEL_FP)
                      {
                        mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                        mmi_dq_aud_play_with_id(AUD_ID_FP_NOT_EXIST);
              #endif
                      }
                    }
                    return;
                  }
                }
                // printfS("mmi_dq_fp_get_image", "error");
              
                mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                mmi_dq_aud_play_with_id(AUD_ID_PRESS_FP_AGAIN);
              #endif
                return;
              }
              #endif
1439          
1440          #ifdef __LOCK_RFID_CARD_SUPPORT__
1441          /*
1442          parameter: 
1443            none
1444          return :
1445            none
1446          */
1447          void mmi_ms_rfid_opt_fun(unsigned char rfid_val)
1448          {
1449   1        RET_VAL retval = RET_SUCESS;
1450   1        unsigned char index = 0;
1451   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
1452   1      
1453   1        if (status == SYS_STATUS_LOW_POWER)
1454   1        {
1455   2      #ifdef __LOCK_AUDIO_SUPPORT__
1456   2          mmi_dq_aud_stop();
1457   2      #endif
1458   2      #ifdef __LOCK_AUDIO_SUPPORT__
1459   2          mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
1460   2      #endif
1461   2      #ifdef __LOCK_WIFI_SUPPORT__
1462   2          mmi_dq_wifi_lowpower_alarm();
1463   2      #endif
1464   2          return;
1465   2        }
1466   1        else if (status == SYS_STATUS_WAIT_FOR_ENTER_SLEEP)
1467   1          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1468   1      
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 25  

1469   1        if ((status != SYS_STATUS_INPUT_RFID && status != SYS_STATUS_ADD_RFID && status != SYS_STATUS_DEL_RFID)
1470   1      #ifdef __FACTORY_TEST_SUPPORT__
1471   1          || (status == SYS_STATUS_FM_MODE && STR_ID_RF_CARD != mmi_dq_factory_mode_get_test_project())
1472   1      #endif
1473   1        )
1474   1          return;
1475   1      
1476   1      #ifdef __LOCK_AUDIO_SUPPORT__
1477   1        mmi_dq_aud_stop();
1478   1      #endif
1479   1      
1480   1        if (mmi_dq_sys_door_state_check() == 1)
1481   1        {
1482   2      #ifdef __LOCK_AUDIO_SUPPORT__
1483   2          mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
1484   2      #endif
1485   2      #ifdef __LOCK_WIFI_SUPPORT__
1486   2          mmi_dq_wifi_rfid_alarm();
1487   2      #endif
1488   2          return;
1489   2        }
1490   1      #ifdef __FACTORY_TEST_SUPPORT__
1491   1        if (status == SYS_STATUS_FM_MODE)
1492   1        {
1493   2          retval = mmi_dq_rfid_gen_char(opt_time);
1494   2          if (retval == RET_SUCESS)
1495   2          {
1496   3            if (opt_time == OPT_ONE_TIME)
1497   3            {
1498   4      #ifdef __LOCK_AUDIO_SUPPORT__
1499   4              mmi_dq_aud_play_with_id(AUD_ID_PRESS_RFCARD_AGAIN);
1500   4      #endif
1501   4              opt_time = OPT_TWO_TIME;
1502   4            }
1503   3            else
1504   3            {
1505   4              retval = mmi_dq_rfid_match();
1506   4              if (retval == RET_SUCESS)
1507   4      
1508   4                mmi_dq_factory_mode_test_item_result(STR_ID_RF_CARD, 1);
1509   4              else
1510   4      #ifdef __LOCK_AUDIO_SUPPORT__
1511   4                mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY)
1512   4      #endif
1513   4                  ;
1514   4              opt_time = OPT_ONE_TIME;
1515   4            }
1516   3          }
1517   2          return;
1518   2        }
1519   1      #endif
1520   1        retval = mmi_dq_rfid_search_by_temp(&index);
1521   1        if (retval == RET_SUCESS)
1522   1        {
1523   2          if (status == SYS_STATUS_INPUT_RFID)
1524   2          {
1525   3            mmi_dq_sys_door_open(SYS_OPEN_BY_RFID);
1526   3          }
1527   2          else if (status == SYS_STATUS_ADD_RFID)
1528   2          {
1529   3      #ifdef __LOCK_AUDIO_SUPPORT__
1530   3            mmi_dq_aud_play_with_id(AUD_ID_RFCARD_EXIST);
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 26  

1531   3      #endif
1532   3          }
1533   2          else if (status == SYS_STATUS_DEL_RFID)
1534   2          {
1535   3            retval = mmi_dq_rfid_gen_char(opt_time);
1536   3            if (retval == RET_SUCESS)
1537   3            {
1538   4              if (opt_time == OPT_ONE_TIME)
1539   4              {
1540   5      #ifdef __LOCK_AUDIO_SUPPORT__
1541   5                mmi_dq_aud_play_with_id(AUD_ID_PRESS_DEL_RFCARD_AGAIN);
1542   5      #endif
1543   5                opt_time = OPT_TWO_TIME;
1544   5              }
1545   4              else
1546   4              {
1547   5                retval = mmi_dq_rfid_match();
1548   5                if (retval == RET_SUCESS)
1549   5                {
1550   6                  retval = mmi_dq_fs_del_rfid(index);
1551   6                  if (retval == RET_SUCESS)
1552   6                  {
1553   7                    get_index = index;
1554   7      #ifdef __LOCK_AUDIO_SUPPORT__
1555   7                    mmi_dq_aud_play_with_id(AUD_ID_DEL_RFCARD_SUCESS);
1556   7      #endif
1557   7      #ifdef __LOCK_WIFI_SUPPORT__
1558   7                    mmi_dq_wifi_del_rfid_suc(get_index);
1559   7      #endif
1560   7                    // printfV("get_index", (int)get_index);
1561   7                  }
1562   6                  else
1563   6      #ifdef __LOCK_AUDIO_SUPPORT__
1564   6                    mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL)
1565   6      #endif
1566   6                      ;
1567   6                  mmi_dq_sys_del_rf_con();
1568   6                }
1569   5                else
1570   5      #ifdef __LOCK_AUDIO_SUPPORT__
1571   5                  mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY)
1572   5      #endif
1573   5                    ;
1574   5                opt_time = OPT_ONE_TIME;
1575   5              }
1576   4            }
1577   3            else
1578   3      #ifdef __LOCK_AUDIO_SUPPORT__
1579   3              mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL_RETRY)
1580   3      #endif
1581   3                ;
1582   3          }
1583   2        }
1584   1        else
1585   1        {
1586   2          if (status == SYS_STATUS_ADD_RFID)
1587   2          {
1588   3            retval = mmi_dq_rfid_gen_char(opt_time);
1589   3            if (retval == RET_SUCESS)
1590   3            {
1591   4              if (opt_time == OPT_ONE_TIME)
1592   4              {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 27  

1593   5      #ifdef __LOCK_AUDIO_SUPPORT__
1594   5                mmi_dq_aud_play_with_id(AUD_ID_PRESS_RFCARD_AGAIN);
1595   5      #endif
1596   5                opt_time = OPT_TWO_TIME;
1597   5              }
1598   4              else
1599   4              {
1600   5                retval = mmi_dq_rfid_match();
1601   5                if (retval == RET_SUCESS)
1602   5                {
1603   6                  retval = mmi_dq_rfid_store(0);
1604   6                  if (retval == RET_SUCESS)
1605   6                  {
1606   7      #ifdef __LOCK_AUDIO_SUPPORT__
1607   7                    mmi_dq_aud_play_with_id(AUD_ID_ADD_RFCARD_SUCESS);
1608   7      #endif
1609   7      #ifdef __LOCK_WIFI_SUPPORT__
1610   7                    mmi_dq_wifi_add_rfid_suc(get_index);
1611   7      #endif
1612   7                    // printfV("get_index", (int)get_index);
1613   7                  }
1614   6                  else
1615   6      #ifdef __LOCK_AUDIO_SUPPORT__
1616   6                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL)
1617   6      #endif
1618   6                      ;
1619   6      #ifdef __LOCK_WIFI_SUPPORT__
1620   6                  if (wifi_add_flag == 1)
1621   6                  {
1622   7                    wifi_add_flag = 0xff;
1623   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1624   7                  }
1625   6                  else
1626   6      #endif
1627   6                    mmi_dq_sys_add_rf_con();
1628   6                }
1629   5                else
1630   5      #ifdef __LOCK_AUDIO_SUPPORT__
1631   5                  mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY)
1632   5      #endif
1633   5                    ;
1634   5                opt_time = OPT_ONE_TIME;
1635   5              }
1636   4            }
1637   3            else
1638   3      #ifdef __LOCK_AUDIO_SUPPORT__
1639   3              mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL_RETRY)
1640   3      #endif
1641   3                ;
1642   3          }
1643   2          else if (status == SYS_STATUS_INPUT_RFID)
1644   2            mmi_dq_sys_door_open_fail(SYS_OPEN_BY_RFID);
1645   2          else
1646   2      #ifdef __LOCK_AUDIO_SUPPORT__
1647   2            mmi_dq_aud_play_with_id(AUD_ID_RFCARD_NOT_EXIST)
1648   2      #endif
1649   2              ;
1650   2        }
1651   1      
1652   1        return;
1653   1      }
*** WARNING C280 IN LINE 1447 OF mmi_src\mmi_ms.c: 'rfid_val': unreferenced local variable
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 28  

1654          #endif
1655          
1656          /*
1657          parameter: 
1658            none
1659          return :
1660            none
1661          */
1662          void mmi_ms_reset_opt_fun(void)
1663          {
1664   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
1665   1      
1666   1        if (status == SYS_STATUS_FM_MODE
1667   1      #ifdef __FACTORY_TEST_SUPPORT__
1668   1          && STR_ID_RESET == mmi_dq_factory_mode_get_test_project()
1669   1      #endif
1670   1        )
1671   1        {
1672   2      #ifdef __FACTORY_TEST_SUPPORT__
1673   2          mmi_dq_factory_mode_reset_test();
1674   2      #endif
1675   2          return;
1676   2        }
1677   1        else
1678   1        {
1679   2          if (RET_SUCESS == mmi_dq_fs_reset())
1680   2          {
1681   3      #ifdef __LOCK_AUDIO_SUPPORT__
1682   3            mmi_dq_aud_play_with_id(AUD_ID_RESTORE_SUCESS);
1683   3      #endif
1684   3      
1685   3      #ifdef __LOCK_WIFI_SUPPORT__
1686   3            mmi_dq_wifi_clr_pwd_suc();
1687   3            mmi_dq_wifi_clr_fps_suc();
1688   3            mmi_dq_wifi_clr_rfid_suc();
1689   3      #endif
1690   3          }
1691   2          else
1692   2      #ifdef __LOCK_AUDIO_SUPPORT__
1693   2            mmi_dq_aud_play_with_id(AUD_BASE_ID_FAIL)
1694   2      #endif
1695   2              ;
1696   2      
1697   2          mmi_dq_sys_add_admin_pwd();
1698   2        }
1699   1      }
1700          
1701          #ifdef __LOCK_WIFI_SUPPORT__
1702          /*
1703          parameter: 
1704            none
1705          return :
1706            none
1707          */
1708          void mmi_ms_wifi_opt_fun(void)
1709          {
1710   1        unsigned char type = mmi_dq_sys_get_wifi_check_type();
1711   1        if (type == 0)
1712   1          mmi_dq_wifi_check_connect();
1713   1        else if (type == 1)
1714   1          mmi_dq_wifi_check_open();
1715   1      }
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 29  

1716          
1717          /************************************************************************************
1718           *                     Own function                     *
1719           ************************************************************************************/
1720          #ifdef __LOCK_VIRTUAL_PASSWORD__
              void mmi_dq_ms_idle_input_with_app_result(unsigned char ret_code)
              {
                unsigned char open_mode = 0;
              
                if (ret_code == 0xFF || ret_code == 4)
                {
                  if (mmi_dq_sys_lock_error() == 1)
                    mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_PWD_WRONG_TRY, SHOW_MESSAGE_DELAY_T
             -IME, BASE_STATUS_M_SAVE_LOG);
                  else
                    mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_PWD_WRONG_TRY, SHOW_MESSAGE_DELAY_T
             -IME, BASE_STATUS_M_IDLE);
                }
                else if (ret_code == 2)
                {
                  mmi_dq_sys_lock_correct();
                  //dq_otp_add_open_log_by_temp(0);
                  mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_CLR_PWD_SUCESS, SHOW_MESSAGE_DELAY_T
             -IME, BASE_STATUS_M_SAVE_LOG);
                }
                else if (ret_code == 5)
                {
                  mmi_dq_sys_lock_correct();
                  mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_PWD_FULL, SHOW_MESSAGE_DELAY_TIME, B
             -ASE_STATUS_M_IDLE);
                }
                else if (ret_code == 6)
                {
                  //mmi_dq_sys_lock_correct();
                  mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_APP_SYN, SHOW_MESSAGE_DELAY_TIME, BA
             -SE_STATUS_M_IDLE);
                }
                //else if(ret_code == 3)
                //{
                //  mmi_dq_sys_lock_correct();
                //dq_otp_add_open_log_by_temp(0);
                //  mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD,LOCK_ADMIN,STR_ID_RESET_TIME_SUCESS,SHOW_MESSAGE_DELAY
             -_TIME,BASE_STATUS_M_SAVE_LOG);
                //}
                else
                {
                  mmi_dq_sys_lock_correct();
                  open_mode = mmi_dq_fs_get_open_mode();
                  if (open_mode == MS_OPEN_MODE_DBL)
                  {
                    if (g_dbl_open_mode_fp_flag == 1 || g_dbl_open_mode_rf_flag == 1)
                    {
                      g_dbl_open_mode_fp_flag = 0;
                      g_dbl_open_mode_rf_flag = 0;
                      dq_otp_add_open_log_by_temp(1);
                      mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_OPEN_DOOR, OPEN_LOCK_DELAY_TIME, B
             -ASE_STATUS_M_SAVE_LOG_WITH_CLOSE);
                    }
                    else
                    {
                      g_dbl_open_mode_pwd_flag = 1;
                      if (mmi_dq_fs_app_init_sucess())
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/22/2021 16:18:11 PAGE 30  

                        dq_otp_add_exchange_temp_open_log(0, 1);
                      mmi_dq_sys_show_message_with_id(STR_ID_SYSTEM, LOCK_ADMIN, STR_ID_DBL_OPEN_MODE, SHOW_MESSAGE_DELAY_TI
             -ME / 2, BASE_STATUS_M_IDLE);
                    }
                  }
                  else
                  {
                    dq_otp_add_open_log_by_temp(0);
                    mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_OPEN_DOOR, OPEN_LOCK_DELAY_TIME, BA
             -SE_STATUS_M_SAVE_LOG_WITH_CLOSE);
                  }
                }
              }
              
              #endif //__LOCK_VIRTUAL_PASSWORD__
1784          /************************************************************************************
1785           *                     End function                     *
1786           ************************************************************************************/
1787          
1788          #endif
1789          #endif //__MMI_MS_C__


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2759    ----
   CONSTANT SIZE    =     15    ----
   XDATA SIZE       =     72      31
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
