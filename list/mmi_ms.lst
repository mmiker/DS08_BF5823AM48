C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE MMI_MS
OBJECT MODULE PLACED IN .\output\mmi_ms.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE mmi_src\mmi_ms.c LARGE OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\include;.\
                    -Library\byd_standard_peripheral\include;.\byd_api\byd_key\include;.\byd_api\byd_mifare\include;.\byd_tool_comm;.\byd_rfi
                    -d;.\mmi_inc) DEBUG PRINT(.\list\mmi_ms.lst) TABS(2) OBJECT(.\output\mmi_ms.obj)

line level    source

   1          #ifndef __MMI_MS_C__
   2          #define __MMI_MS_C__
   3          
   4          #include "string.h"
   5          #include "mmi_ms.h"
   6          #include "mmi_key.h"
   7          #include "mmi_sys.h"
   8          #include "mmi_audio.h"
   9          #include "mmi_fps.h"
  10          #include "mmi_rfid.h"
  11          #include "mmi_com.h"
  12          #include "mmi_fs.h"
  13          #include "mmi_rst.h"
  14          #include "dqiot_drv.h"
  15          #include "delay.h"
  16          #include "mmi_fs.h"
  17          #include "mmi_fm.h"
  18          #include "mmi_wifi.h"
  19          #include "dqiot_drv_wifi.h"
  20          #include <stdio.h>
  21          // #ifdef __LOCK_VIRTUAL_PASSWORD__
  22          #include "dq_sdk_main.h"
  23          #include "mmi_ms.h"
  24          // #endif
  25          #ifdef __LOCK_DECODE_SUPPORT__
  26          #include "mmi_decode.h"
  27          #endif
  28          
  29          unsigned char input_key_1[KEY_INPUT_MAX_LEN];
  30          unsigned char input_key_2[KEY_INPUT_MAX_LEN];
  31          unsigned char key_len = 0;
  32          OPERATE_TIME opt_time = OPT_TIME_INVALID;
  33          static SYS_BASE_STATUS data sys_state = SYS_STATUS_INVALID;
  34          
  35          static unsigned char data key_last_value = KEY_INVALID;
  36          #ifdef __LOCK_RFID_CARD_SUPPORT__
  37          static unsigned char rfid_last_flag = 0;
  38          #endif
  39          #ifdef __LOCK_BUS_SUPPORT__
  40          static unsigned char admin_check_type = 0;
  41          #endif
  42          
  43          static unsigned char g_dbl_open_mode_pwd_flag = 0;
  44          static unsigned char g_dbl_open_mode_fp_flag = 0;
  45          static unsigned char g_dbl_open_mode_rf_flag = 0;
  46          
  47          // extern void printfS(char *show, char *status);
  48          // extern void printfV(char *show, int value);
  49          
  50          /*
  51          parameter: 
  52            none
  53          return :
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 2   

  54            none
  55          */
  56          void mmi_task_proc(void)
  57          {
  58   1        unsigned char touch_value = 0xFF;
  59   1        unsigned char key_value = KEY_INVALID;
  60   1      
  61   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
  62   1        if (mmi_dq_sys_get_rfid_flag() == 1)
  63   1        {
  64   2          //check rfid press
  65   2          if (mmi_dq_rfid_check() == RET_SUCESS)
  66   2          {
  67   3            if (mmi_dq_rfid_work() == RET_SUCESS)
  68   3            {
  69   4              if (rfid_last_flag == 0)
  70   4              {
  71   5                rfid_last_flag = 1;
  72   5                mmi_dq_ms_set_msg_que(QUE_EVENT_RFID, QUE_PRO_LOW, 0);
  73   5              }
  74   4            }
  75   3            else
  76   3            {
  77   4              rfid_last_flag = 0;
  78   4            }
  79   3          }
  80   2        }
  81   1      #endif
  82   1        //check key press
  83   1        touch_value = mmi_dq_key_work();
  84   1        if (touch_value != 0xFF)
  85   1        {
  86   2          key_value = mmi_dq_get_key_map(touch_value);
  87   2          if (key_value != KEY_INVALID)
  88   2          {
  89   3            if (key_last_value != key_value)
  90   3            {
  91   4              key_last_value = key_value;
  92   4              mmi_dq_ms_set_msg_que(QUE_EVENT_KEY, QUE_PRO_LOW, key_value);
  93   4            }
  94   3          }
  95   2          else
  96   2            key_last_value = KEY_INVALID;
  97   2        }
  98   1        else
  99   1          key_last_value = KEY_INVALID;
 100   1      
 101   1      #ifdef __LOCK_AUDIO_SUPPORT__
 102   1        if (mmi_dq_aud_get_end_flag() != 0)
 103   1          mmi_dq_ms_set_msg_que(QUE_EVENT_AUDIO_END, QUE_PRO_LOW, 0);
 104   1      #endif
 105   1      
 106   1        if (mmi_dq_rst_get_state() != 0)
 107   1          mmi_dq_ms_set_msg_que(QUE_EVENT_RST, QUE_PRO_LOW, 0);
 108   1      
 109   1        if (mmi_dq_sys_get_timer2_flag() != 0)
 110   1          mmi_dq_ms_set_msg_que(QUE_EVENT_TIMER_END, QUE_PRO_LOW, 0);
 111   1      
 112   1      #ifdef __LOCK_FP_SUPPORT__
                  //check fp press
                  // if (mmi_dq_fp_work() != 0)
                  //  mmi_dq_ms_set_msg_que(QUE_EVENT_FP, QUE_PRO_LOW, 0);
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 3   

              #endif
 117   1      
 118   1      #ifdef __LOCK_WIFI_SUPPORT__
 119   1        if (mmi_dq_sys_get_wifi_check_flag() != 0)
 120   1          mmi_dq_ms_set_msg_que(QUE_EVENT_WIFI_CHECK, QUE_PRO_LOW, 0);
 121   1      #endif
 122   1      
 123   1        return;
 124   1      }
 125          
 126          /*
 127          parameter: 
 128            none
 129          return :
 130            none
 131          */
 132          void mmi_sleep_task_proc(void)
 133          {
 134   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 135   1        unsigned char ret = 0xFF;
 136   1        static unsigned char time_count = 0;
 137   1      
 138   1        time_count++;
 139   1        if (time_count > 4)
 140   1        {
 141   2          time_count = 0;
 142   2          ret = mmi_dq_rfid_check();
 143   2        }
 144   1      #endif
 145   1      
 146   1        if (
 147   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 148   1          (ret == RET_SUCESS) ||
 149   1      #endif
 150   1          (mmi_dq_key_check() != 0) || (mmi_dq_rst_get_pin() != 0)
 151   1      #ifdef __LOCK_FP_SUPPORT__
                  || (mmi_dq_fp_get_pin() == 1)
              #endif
 154   1        )
 155   1        {
 156   2          key_last_value = mmi_dq_get_key_map(dqiot_drv_get_touch_value());
 157   2          mmi_dq_sys_wake_up();
 158   2        }
 159   1      
 160   1      #ifdef __LOCK_WIFI_SUPPORT__
 161   1        //if(mmi_dq_sys_get_wifi_check_flag() != 0)
 162   1        //  mmi_dq_ms_set_msg_que(QUE_EVENT_WIFI_CHECK,QUE_PRO_LOW,0);
 163   1      #endif
 164   1      
 165   1        return;
 166   1      }
 167          
 168          /*
 169          parameter: 
 170            none
 171          return :
 172            none
 173          */
 174          void mmi_wait_sleep_task_proc(void)
 175          {
 176   1      //unsigned int timer1_count = 0;
 177   1      #ifdef __LOCK_WIFI_SUPPORT__
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 4   

 178   1        if (mmi_dq_wifi_get_running_flag() == 1)
 179   1          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 180   1        //if((mmi_dq_rfid_check() == RET_SUCESS) || (mmi_dq_key_check() != 0) || (mmi_dq_rst_get_pin() == 0))
 181   1        else
 182   1      #endif
 183   1          if (mmi_dq_ms_get_run_flag() == 0)
 184   1        {
 185   2          mmi_dq_sys_enter_sleep();
 186   2        }
 187   1      
 188   1        return;
 189   1      }
 190          
 191          /*
 192          parameter: 
 193            none
 194          return :
 195            none
 196          */
 197          unsigned char mmi_dq_ms_get_run_flag(void)
 198          {
 199   1        if ((key_last_value == KEY_INVALID)
 200   1      #ifdef __LOCK_AUDIO_SUPPORT__
 201   1          && (mmi_dq_aud_get_state() == 0)
 202   1      #endif
 203   1          && (mmi_dq_rst_get_pin() == 0)
 204   1      #ifdef __LOCK_FP_SUPPORT__
                  && (mmi_dq_fp_get_pin() != 1)
              #endif
 207   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 208   1          && rfid_last_flag == 0
 209   1      #endif
 210   1        )
 211   1          return 0;
 212   1      
 213   1        return 1;
 214   1      }
 215          
 216          /*
 217          parameter: 
 218            none
 219          return :
 220            none
 221          */
 222          void mmi_dq_ms_sys_msg_handle(void)
 223          {
 224   1        Sys_MSG_Queue_M sys_msg_que;
 225   1        if (mmi_OutQueue(&sys_msg_que))
 226   1        {
 227   2          mmi_dq_sys_sleep_timer_reset();
 228   2          switch (sys_msg_que.que_event)
 229   2          {
 230   3          case QUE_EVENT_KEY:
 231   3            mmi_ms_pwd_opt_fun(sys_msg_que.que_data);
 232   3            break;
 233   3      #ifdef __LOCK_FP_SUPPORT__
                  case QUE_EVENT_FP:
                    mmi_ms_fps_opt_fun(sys_msg_que.que_data);
                    break;
              #endif
 238   3      #ifdef __LOCK_RFID_CARD_SUPPORT__
 239   3          case QUE_EVENT_RFID:
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 5   

 240   3            mmi_ms_rfid_opt_fun(sys_msg_que.que_data);
 241   3            break;
 242   3      #endif
 243   3          case QUE_EVENT_RST:
 244   3            mmi_ms_reset_opt_fun();
 245   3            break;
 246   3          case QUE_EVENT_AUDIO_END:
 247   3      
 248   3            break;
 249   3          case QUE_EVENT_TIMER_END:
 250   3            mmi_dq_sys_delay_event_pro();
 251   3            break;
 252   3      #ifdef __LOCK_WIFI_SUPPORT__
 253   3          case QUE_EVENT_WIFI_CHECK:
 254   3            mmi_ms_wifi_opt_fun();
 255   3            break;
 256   3      #endif
 257   3          default:
 258   3            break;
 259   3          }
 260   2        }
 261   1      }
 262          
 263          /*
 264          parameter: 
 265            none
 266          return :
 267            none
 268          */
 269          void mmi_dq_ms_set_msg_que(SYS_QUEUE_EVENT q_event, SYS_QUEUE_PRO q_pro, unsigned char q_data)
 270          {
 271   1        Sys_MSG_Queue_M que;
 272   1        que.que_event = q_event;
 273   1        que.que_pro = q_pro;
 274   1        que.que_data = q_data;
 275   1        //printf("mmi_dq_ms_set_msg_que  event : %d",q_event);
 276   1        mmi_InQueue(que);
 277   1        return;
 278   1      }
 279          
 280          /*
 281          parameter: 
 282            none
 283          return :
 284            none
 285          */
 286          void mmi_dq_ms_set_sys_state(SYS_BASE_STATUS state)
 287          {
 288   1        sys_state = state;
 289   1        return;
 290   1      }
 291          
 292          /*
 293          parameter: 
 294            none
 295          return :
 296            none
 297          */
 298          SYS_BASE_STATUS mmi_dq_ms_get_sys_state(void)
 299          {
 300   1        return sys_state;
 301   1      }
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 6   

 302          
 303          /*
 304          parameter: 
 305            none
 306          return :
 307            none
 308          */
 309          void mmi_ms_pwd_init_var(void)
 310          {
 311   1        key_len = 0;
 312   1        opt_time = OPT_ONE_TIME;
 313   1        memset(input_key_1, 0xFF, sizeof(input_key_1));
 314   1        memset(input_key_2, 0xFF, sizeof(input_key_2));
 315   1      }
 316          
 317          /*
 318          parameter: 
 319            none
 320          return :
 321            none
 322          */
 323          void mmi_ms_opt_time_init(void)
 324          {
 325   1        opt_time = OPT_ONE_TIME;
 326   1      }
 327          
 328          /*
 329          parameter: 
 330            none
 331          return :
 332            none
 333          */
 334          void mmi_ms_pwd_opt_fun(unsigned char key_val)
 335          {
 336   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
 337   1        //printf("mmi_ms_pwd_opt_fun status: 0x%x  key: %d",status,key_val);
 338   1        switch (status)
 339   1        {
 340   2        case SYS_STATUS_WAIT_FOR_ENTER_SLEEP:
 341   2          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 342   2          status = SYS_STATUS_IDLE;
 343   2      #ifdef __LOCK_DECODE_SUPPORT__
 344   2        case SYS_STATUS_ADD_DECODE_RANDOM:
 345   2          if (key_len == 0)
 346   2          {
 347   3            if (key_val == KEY_S)
 348   3            {
 349   4      #ifdef __LOCK_AUDIO_SUPPORT__
 350   4              mmi_dq_aud_play_key_tone();
 351   4      #endif
 352   4              mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 353   4              mmi_dq_sys_show_cur_menu_list();
 354   4              break;
 355   4            }
 356   3            else if (key_val == KEY_H)
 357   3            {
 358   4      #ifdef __LOCK_AUDIO_SUPPORT__
 359   4              mmi_dq_aud_play_key_tone();
 360   4      #endif
 361   4      #ifdef __LOCK_AUDIO_SUPPORT__
 362   4              mmi_dq_aud_play_with_id(AUD_ID_INPUT_68_PWD);
 363   4      #endif
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 7   

 364   4              break;
 365   4            }
 366   3          }
 367   2      
 368   2      // mmi_dq_aud_play_key_num(key_val);
 369   2      #ifdef __LOCK_AUDIO_SUPPORT__
 370   2          mmi_dq_aud_play_key_tone();
 371   2      #endif
 372   2          //input pwd
 373   2          if ((key_val >= KEY_0 && key_val <= KEY_9) && key_len < KEY_INPUT_MAX_LEN)
 374   2          {
 375   3            if (opt_time == OPT_ONE_TIME)
 376   3            {
 377   4              input_key_1[key_len++] = key_val;
 378   4            }
 379   3            else if (opt_time == OPT_TWO_TIME)
 380   3            {
 381   4              input_key_2[key_len++] = key_val;
 382   4            }
 383   3          }
 384   2      
 385   2          if (key_val == KEY_S)
 386   2          {
 387   3            if (opt_time == OPT_ONE_TIME)
 388   3              input_key_1[key_len--] = 0xFF;
 389   3            else if (opt_time == OPT_TWO_TIME)
 390   3              input_key_2[key_len--] = 0xFF;
 391   3      
 392   3            if (key_len == 0)
 393   3            {
 394   4              if (opt_time == OPT_ONE_TIME)
 395   4              {
 396   5      #ifdef __LOCK_AUDIO_SUPPORT__
 397   5                mmi_dq_aud_play_with_id(AUD_ID_INPUT_68_PWD);
 398   5      #endif
 399   5              }
 400   4              else if (opt_time == OPT_TWO_TIME)
 401   4              {
 402   5      #ifdef __LOCK_AUDIO_SUPPORT__
 403   5                mmi_dq_aud_play_with_id(AUD_ID_PWD_INPUT_AGAIN);
 404   5      #endif
 405   5              }
 406   4            }
 407   3          }
 408   2          else if ((key_val == KEY_H) || (key_len == PWD_INPUT_DECODE_RANDOM))
 409   2          {
 410   3            if (key_len < PWD_INPUT_DECODE_RANDOM)
 411   3            {
 412   4      #ifdef __LOCK_AUDIO_SUPPORT__
 413   4              mmi_dq_aud_play_with_id(AUD_ID_PWD_68_LEN);
 414   4      #endif
 415   4              key_len = 0;
 416   4              if (opt_time == OPT_ONE_TIME)
 417   4                memset(input_key_1, 0xFF, sizeof(input_key_1));
 418   4              else if (opt_time == OPT_TWO_TIME)
 419   4                memset(input_key_2, 0xFF, sizeof(input_key_2));
 420   4            }
 421   3            else
 422   3            {
 423   4              if (opt_time == OPT_ONE_TIME)
 424   4              {
 425   5      #ifdef __LOCK_AUDIO_SUPPORT__
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 8   

 426   5                mmi_dq_aud_play_with_id(AUD_ID_PWD_INPUT_AGAIN);
 427   5      #endif
 428   5                opt_time = OPT_TWO_TIME;
 429   5                key_len = 0;
 430   5                memset(input_key_2, 0xFF, sizeof(input_key_2));
 431   5              }
 432   4              else if (opt_time == OPT_TWO_TIME)
 433   4              {
 434   5                if (0 == memcmp(input_key_1, input_key_2, PWD_INPUT_DECODE_RANDOM))
 435   5                {
 436   6                  decode_check_code(input_key_1);
 437   6                  if (get_decode.chk_key_2[0] == input_key_1[13] && get_decode.chk_key_2[1] == input_key_1[14])
 438   6                  {
 439   7                    unsigned char i, j;
 440   7                    unsigned char a[10][5] = {
 441   7                      {0x26, 0x41, 0x53, 0x89, 0x70},
 442   7                      {0x43, 0x16, 0x98, 0x25, 0x07},
 443   7                      {0x92, 0x35, 0x64, 0x70, 0x81},
 444   7                      {0x72, 0x59, 0x03, 0x18, 0x46},
 445   7                      {0x02, 0x85, 0x19, 0x63, 0x74},
 446   7                      {0x12, 0x05, 0x69, 0x43, 0x87},
 447   7                      {0x18, 0x95, 0x42, 0x76, 0x30},
 448   7                      {0x09, 0x58, 0x26, 0x17, 0x34},
 449   7                      {0x10, 0x63, 0x52, 0x74, 0x89},
 450   7                      {0x21, 0x69, 0x50, 0x37, 0x84},
 451   7                    };
 452   7      
 453   7                    for (i = 0; i < 10; i++)
 454   7                    {
 455   8                      for (j = 0; j < 5; j++)
 456   8                      {
 457   9                        g_pwd_signed_data[i].exchg_num[j] = a[i][j];
 458   9                      }
 459   8                    }
 460   7      
 461   7                    //è§£ç 
 462   7                    mmi_dq_decode_app_random_code(input_key_1);
 463   7                    decode_time_stamp_10num(input_key_1, 10, get_decode.sec_key_10, get_decode.exg_key_10);
 464   7      
 465   7                    //å†™flash
 466   7                    if (mmi_dq_fs_set_decode(FDS_USE_TYPE_ADMIN) == RET_SUCESS)
 467   7                    {
 468   8                      struct tm t;
 469   8      
 470   8                      //æ—¶é—´æˆ³è½¬æ—¶é—´
 471   8                      ntp(get_decode.tim_key_10, &t);
 472   8      
 473   8                      dqiot_drv_uart0A_init();
 474   8                      printf("flash is success\n");
 475   8                      printf("A %04d-%02d-%02d %02d:%02d:%02d\r\n", t.tm_year, t.tm_mon + 1, t.tm_mday, t.tm_hour + 8, t
             -.tm_min, t.tm_sec);
 476   8                      dqiot_drv_uart0B_init();
 477   8      #ifdef __LOCK_AUDIO_SUPPORT__
 478   8                      mmi_dq_aud_play_with_id(AUD_BASE_ID_SUCCESS);
 479   8      #endif
 480   8                    }
 481   7                    else
 482   7                    {
 483   8      #ifdef __LOCK_AUDIO_SUPPORT__
 484   8                      mmi_dq_aud_play_with_id(AUD_BASE_ID_FAIL);
 485   8      #endif
 486   8                      dqiot_drv_uart0A_init();
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 9   

 487   8                      printf("flash is error\n");
 488   8                      dqiot_drv_uart0B_init();
 489   8                    }
 490   7      
 491   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 492   7                  }
 493   6                  else
 494   6                  {
 495   7                    dqiot_drv_uart0A_init();
 496   7                    printf("check is error\n");
 497   7                    dqiot_drv_uart0B_init();
 498   7                    mmi_dq_aud_play_with_id(AUD_BASE_ID_FAIL);
 499   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 500   7                  }
 501   6                }
 502   5                else
 503   5                {
 504   6      #ifdef __LOCK_AUDIO_SUPPORT__
 505   6                  mmi_dq_aud_play_with_id(AUD_ID_PWD_NOT_SAME_RETRY);
 506   6      #endif
 507   6                }
 508   5                mmi_ms_pwd_init_var();
 509   5              }
 510   4            }
 511   3          }
 512   2          break;
 513   2      #endif
 514   2        case SYS_STATUS_INPUT_PWD:
 515   2        case SYS_STATUS_INPUT_ADMIN_PWD:
 516   2        case SYS_STATUS_ADD_PWD:
 517   2        case SYS_STATUS_DEL_PWD:
 518   2        case SYS_STATUS_ADD_ADMIN_PWD:
 519   2        case SYS_STATUS_CHG_ADMIN_PWD:
 520   2      #ifdef __LOCK_110_SUPPORT__
 521   2        case SYS_STATUS_ADD_110_PWD:
 522   2      #endif
 523   2          if (mmi_dq_sys_door_state_check() == 1)
 524   2          {
 525   3      #ifdef __LOCK_AUDIO_SUPPORT__
 526   3            mmi_dq_aud_stop();
 527   3            mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
 528   3      #endif
 529   3      #ifdef __LOCK_WIFI_SUPPORT__
 530   3            mmi_dq_wifi_pw_alarm();
 531   3      #endif
 532   3            return;
 533   3          }
 534   2          if (key_len == 0)
 535   2          {
 536   3            if (key_val == KEY_S)
 537   3            {
 538   4              if (SYS_STATUS_ADD_ADMIN_PWD != status)
 539   4              {
 540   5      #ifdef __LOCK_AUDIO_SUPPORT__
 541   5                mmi_dq_aud_play_key_tone();
 542   5      #endif
 543   5                if (status == SYS_STATUS_INPUT_PWD)
 544   5                  //mmi_dq_sys_enter_sleep();
 545   5                  mmi_dq_ms_set_sys_state(SYS_STATUS_WAIT_FOR_ENTER_SLEEP);
 546   5                else if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 547   5                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 548   5      #ifdef __LOCK_WIFI_SUPPORT__
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 10  

 549   5                else if (wifi_add_flag == 1)
 550   5                {
 551   6                  wifi_add_flag = 0xff;
 552   6                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 553   6                }
 554   5                else
 555   5      #endif
 556   5                  mmi_dq_sys_show_cur_menu_list();
 557   5              }
 558   4              break;
 559   4            }
 560   3            else if (key_val == KEY_H)
 561   3            {
 562   4              if (status == SYS_STATUS_INPUT_PWD)
 563   4              {
 564   5      #ifdef __LOCK_AUDIO_SUPPORT__
 565   5                mmi_dq_aud_play_key_tone();
 566   5      #endif
 567   5      #ifdef __LOCK_BUS_SUPPORT__
 568   5                admin_check_type = 0;
 569   5      #endif
 570   5      #ifdef __LOCK_AUDIO_SUPPORT__
 571   5                mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD);
 572   5      #endif
 573   5                mmi_dq_ms_set_sys_state(SYS_STATUS_INPUT_ADMIN_PWD);
 574   5              }
 575   4              break;
 576   4            }
 577   3          }
 578   2      
 579   2      // mmi_dq_aud_play_key_num(key_val);
 580   2      #ifdef __LOCK_AUDIO_SUPPORT__
 581   2          mmi_dq_aud_play_key_tone();
 582   2      #endif
 583   2          //input pwd
 584   2          if ((key_val >= KEY_0 && key_val <= KEY_9) && key_len < KEY_INPUT_MAX_LEN)
 585   2          {
 586   3            if ((status == SYS_STATUS_INPUT_PWD) || (status == SYS_STATUS_INPUT_ADMIN_PWD))
 587   3              input_key_1[key_len++] = key_val;
 588   3            else // if((status == SYS_STATUS_ADD_PWD)||(status == SYS_STATUS_ADD_110_PWD)||(status == SYS_STATUS_AD
             -D_ADMIN_PWD))
 589   3            {
 590   4              if (opt_time == OPT_ONE_TIME)
 591   4              {
 592   5                input_key_1[key_len++] = key_val;
 593   5              }
 594   4              else if (opt_time == OPT_TWO_TIME)
 595   4              {
 596   5                input_key_2[key_len++] = key_val;
 597   5              }
 598   4            }
 599   3          }
 600   2      
 601   2          if (key_val == KEY_S)
 602   2          {
 603   3            if (opt_time == OPT_ONE_TIME)
 604   3              input_key_1[key_len--] = 0xFF;
 605   3            else if (opt_time == OPT_TWO_TIME)
 606   3              input_key_2[key_len--] = 0xFF;
 607   3      
 608   3            if (key_len == 0)
 609   3            {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 11  

 610   4              if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 611   4      #ifdef __LOCK_AUDIO_SUPPORT__
 612   4                mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD)
 613   4      #endif
 614   4                  ;
 615   4              else if (opt_time == OPT_ONE_TIME)
 616   4              {
 617   5      #ifdef __LOCK_AUDIO_SUPPORT__
 618   5                if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 619   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_68_PWD);
 620   5                else if (status == SYS_STATUS_DEL_PWD)
 621   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_NUM);
 622   5                else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 623   5                  mmi_dq_aud_play_with_id(AUD_ID_ADD_ADMIN_PWD_FIRST);
 624   5                else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 625   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD);
 626   5      #endif
 627   5              }
 628   4              else if (opt_time == OPT_TWO_TIME)
 629   4              {
 630   5      #ifdef __LOCK_AUDIO_SUPPORT__
 631   5                if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 632   5                  mmi_dq_aud_play_with_id(AUD_ID_PWD_INPUT_AGAIN);
 633   5                else if (status == SYS_STATUS_DEL_PWD)
 634   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_PWD_AGAIN);
 635   5                else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 636   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD_INIT_AGAIN);
 637   5                else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 638   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD_AGAIN);
 639   5      #endif
 640   5              }
 641   4            }
 642   3          }
 643   2          else if ((key_val == KEY_H) || (key_len == PWD_INPUT_MAX_LEN))
 644   2          {
 645   3            if (key_len < PWD_INPUT_MIN_LEN)
 646   3            {
 647   4              if (status == SYS_STATUS_INPUT_PWD)
 648   4              {
 649   5                if (key_len == 2 && input_key_1[0] == KEY_0 && input_key_1[1] == KEY_0) //00 è¿œç¨‹å¼€é—¨
 650   5                  mmi_dq_sys_wifi_open();
 651   5      #ifdef __LOCK_WIFI_SUPPORT__
 652   5                else if (key_len == 1 && input_key_1[0] == KEY_5) //5 æ·»åŠ åˆ é™¤å¯†ç /æŒ‡çº¹/RFå¡
 653   5                  mmi_dq_wifi_cmd_add_del();
 654   5                else if (key_len == 1 && input_key_1[0] == KEY_6) //6 è®¾ç½®æ‹ç…§/å½•åƒå¼€å…³
 655   5                  mmi_dq_wifi_pv_switch();
 656   5                else if (key_len == 2 && input_key_1[0] == KEY_1 && input_key_1[1] == KEY_8) //18 åº”æ€¥é’¥åŒ™å¼€é—¨æ
             -ˆåŠŸ
 657   5                {
 658   6      #ifdef __LOCK_DECODE_SUPPORT__
 659   6                  unsigned char i, j;
 660   6                  unsigned char random_code[15] = {5, 6, 4, 8, 0, 4, 7, 5, 7, 7, 9, 8, 0, 1, 8};
 661   6                  // unsigned char time_code[5] = {0x80, 0x47, 0x57, 0x79, 0x80};
 662   6                  // unsigned char sec_code[5] = {0x56, 0x13, 0x40, 0x27, 0x89};
 663   6                  // unsigned char exg_code[5] = {0x46, 0x57, 0x08, 0x12, 0x39};
 664   6                  unsigned char a[10][5] = {
 665   6                    {0x26, 0x41, 0x53, 0x89, 0x70},
 666   6                    {0x43, 0x16, 0x98, 0x25, 0x07},
 667   6                    {0x92, 0x35, 0x64, 0x70, 0x81},
 668   6                    {0x72, 0x59, 0x03, 0x18, 0x46},
 669   6                    {0x02, 0x85, 0x19, 0x63, 0x74},
 670   6                    {0x12, 0x05, 0x69, 0x43, 0x87},
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 12  

 671   6                    {0x18, 0x95, 0x42, 0x76, 0x30},
 672   6                    {0x09, 0x58, 0x26, 0x17, 0x34},
 673   6                    {0x10, 0x63, 0x52, 0x74, 0x89},
 674   6                    {0x21, 0x69, 0x50, 0x37, 0x84},
 675   6                  };
 676   6      
 677   6                  for (i = 0; i < 10; i++)
 678   6                  {
 679   7                    for (j = 0; j < 5; j++)
 680   7                    {
 681   8                      g_pwd_signed_data[i].exchg_num[j] = a[i][j];
 682   8                    }
 683   7                  }
 684   6      
 685   6                  decode_check_code(random_code);
 686   6                  if (get_decode.chk_key_2[0] == random_code[13] && get_decode.chk_key_2[1] == random_code[14])
 687   6                  {
 688   7                    struct tm t;
 689   7      
 690   7                    //è§£ç 
 691   7                    mmi_dq_decode_app_random_code(random_code);
 692   7                    decode_time_stamp_10num(random_code, 10, get_decode.sec_key_10, get_decode.exg_key_10);
 693   7      
 694   7                    //å†™flash
 695   7                    if (mmi_dq_fs_set_decode(FDS_USE_TYPE_ADMIN) == RET_SUCESS)
 696   7                    {
 697   8      #ifdef __LOCK_AUDIO_SUPPORT__
 698   8                      mmi_dq_aud_play_with_id(AUD_BASE_ID_SUCCESS);
 699   8      #endif
 700   8      
 701   8                      dqiot_drv_uart0A_init();
 702   8                      printf("flash is success\n");
 703   8                      dqiot_drv_uart0B_init();
 704   8                    }
 705   7                    else
 706   7                    {
 707   8      #ifdef __LOCK_AUDIO_SUPPORT__
 708   8                      mmi_dq_aud_play_with_id(AUD_BASE_ID_FAIL);
 709   8      #endif
 710   8                      dqiot_drv_uart0A_init();
 711   8                      printf("flash is error\n");
 712   8                      dqiot_drv_uart0B_init();
 713   8                    }
 714   7      
 715   7                    // get_decode.tim_key_10 = 1619063988;
 716   7                    //æ—¶é—´æˆ³è½¬æ—¶é—´
 717   7                    ntp(get_decode.tim_key_10, &t);
 718   7                    dqiot_drv_uart0A_init();
 719   7                    printf("A %04d-%02d-%02d %02d:%02d:%02d\r\n", t.tm_year, t.tm_mon + 1, t.tm_mday, t.tm_hour + 8, t.
             -tm_min, t.tm_sec);
 720   7                    dqiot_drv_uart0B_init();
 721   7                  }
 722   6      
 723   6      #endif
 724   6                }
 725   5                //  mmi_dq_wifi_open_by_key();
 726   5                // else if (key_len == 2 && input_key_1[0] == KEY_1 && input_key_1[1] == KEY_9) //19 é—¨æœªå…³
 727   5                //  mmi_dq_wifi_close_over_time();
 728   5                // else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_0) //20 éœ‡åŠ¨æŠ¥è­¦
 729   5                //  mmi_dq_wifi_via_alarm();
 730   5                // else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_5) //25 ç¡çœ 
 731   5                //  mmi_dq_wifi_sleep();
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 13  

 732   5                // else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_6) //26 å”¤é†’
 733   5                //  mmi_dq_wifi_wakeup();
 734   5                // else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_7) //27 æ‹ç…§
 735   5                //  mmi_dq_wifi_take_photos();
 736   5                // else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_8) //28 å½•åƒ
 737   5                //  mmi_dq_wifi_take_videos();
 738   5                // else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_0) //30 æŸ¥è¯¢ç½‘ç»œçŠ¶æ
             -€
 739   5                //  mmi_dq_wifi_check_net();
 740   5                // else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_1) //31 Airkissé…ç½‘(ad
             -min 8)
 741   5                //  mmi_dq_wifi_arikiss_con();
 742   5                // else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_2) //32 äºŒç»´ç é…ç½‘(
             -admin 9)
 743   5                //  mmi_dq_wifi_code_con();
 744   5      #endif
 745   5      #ifdef __LOCK_BUS_SUPPORT__
 746   5                else if (key_len == 2 && input_key_1[0] == KEY_0 && input_key_1[1] == KEY_1) //01
 747   5                {
 748   6      
 749   6                  if (mmi_dq_fs_get_business_flag() == 1)
 750   6                  {
 751   7                    admin_check_type = 1;
 752   7      #ifdef __LOCK_AUDIO_SUPPORT__
 753   7                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD);
 754   7      #endif
 755   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_INPUT_ADMIN_PWD);
 756   7                  }
 757   6                  else
 758   6                  {
 759   7                    mmi_dq_fs_set_business_flag(1);
 760   7      #ifdef __LOCK_AUDIO_SUPPORT__
 761   7                    mmi_dq_aud_play_with_id(AUD_ID_OUT_OPEN);
 762   7      #endif
 763   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 764   7                  }
 765   6                }
 766   5      #endif
 767   5                else
 768   5                {
 769   6                  mmi_dq_sys_door_open_fail(SYS_OPEN_BY_PASSWORD);
 770   6                }
 771   5                key_len = 0;
 772   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 773   5              }
 774   4              else
 775   4              {
 776   5      #ifdef __LOCK_AUDIO_SUPPORT__
 777   5                mmi_dq_aud_play_with_id(AUD_ID_PWD_68_LEN);
 778   5      #endif
 779   5                key_len = 0;
 780   5                if (opt_time == OPT_ONE_TIME)
 781   5                  memset(input_key_1, 0xFF, sizeof(input_key_1));
 782   5                else if (opt_time == OPT_TWO_TIME)
 783   5                  memset(input_key_2, 0xFF, sizeof(input_key_2));
 784   5              }
 785   4            }
 786   3            else
 787   3            {
 788   4      #ifdef __LOCK_VIRTUAL_PASSWORD__
                      if (1) //æµ‹è¯•ä¸ŽAPPæ˜¯å¦è¿žæŽ¥æˆåŠŸ
                      {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 14  

              
                        mmi_dq_fs_check_input_pwd_from_app(input_key_1, key_len);
                        key_len = 0;
                        // return SUCESS;
                      }
                      else
              #endif //__LOCK_VIRTUAL_PASSWORD__
 798   4                if (status == SYS_STATUS_INPUT_PWD)
 799   4              {
 800   5                //if(mmi_dq_fs_check_input_pwd(input_key_1,key_len,FDS_USE_TYPE_ALL) == 0xFF)
 801   5                unsigned char ret = 0;
 802   5                ret = mmi_dq_fs_check_input_pwd_for_open(input_key_1, key_len);
 803   5                //printf("check input ret: %d",(unsigned int)ret);
 804   5                if (ret == 0xFF)
 805   5                  mmi_dq_sys_door_open_fail(SYS_OPEN_BY_PASSWORD);
 806   5      #ifdef __LOCK_BUS_SUPPORT__
 807   5                else if (ret == 0xFE && mmi_dq_fs_get_business_flag() == 1)
 808   5                {
 809   6                  mmi_dq_fs_set_business_flag(0);
 810   6      #ifdef __LOCK_AUDIO_SUPPORT__
 811   6                  mmi_dq_aud_play_with_id(AUD_ID_OUT_CLOSED);
 812   6      #endif
 813   6                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 814   6                }
 815   5      #endif
 816   5      #ifdef __LOCK_110_SUPPORT__
 817   5                else if (ret == 1)
 818   5                  mmi_dq_sys_door_open(SYS_OPEN_BY_110_PASSWORD);
 819   5      #endif
 820   5                else
 821   5                  mmi_dq_sys_door_open(SYS_OPEN_BY_PASSWORD);
 822   5                key_len = 0;
 823   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 824   5              }
 825   4              else if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 826   4              {
 827   5                if (mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == 0xFF)
 828   5      #ifdef __LOCK_AUDIO_SUPPORT__
 829   5                  mmi_dq_aud_play_with_id(AUD_ID_PWD_WRONG_TRY)
 830   5      #endif
 831   5                    ;
 832   5                else
 833   5                {
 834   6      #ifdef __LOCK_BUS_SUPPORT__
 835   6                  if (admin_check_type == 1)
 836   6                  {
 837   7                    mmi_dq_fs_set_business_flag(0);
 838   7      #ifdef __LOCK_AUDIO_SUPPORT__
 839   7                    mmi_dq_aud_play_with_id(AUD_ID_OUT_CLOSED);
 840   7      #endif
 841   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 842   7                  }
 843   6                  else
 844   6      #endif
 845   6                  {
 846   7                    mmi_dq_sys_set_menu_father_id(STR_ID_SYSTEM);
 847   7                    mmi_dq_sys_show_cur_menu_list();
 848   7                  }
 849   6                }
 850   5                key_len = 0;
 851   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 852   5              }
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 15  

 853   4              else // if((status == SYS_STATUS_ADD_PWD)||(status == SYS_STATUS_DEL_PWD)||(status == SYS_STATUS_ADD_A
             -DMIN_PWD)||(status == SYS_STATUS_CHG_ADMIN_PWD)||(status == SYS_STATUS_ADD_110_PWD))
 854   4              {
 855   5                if (opt_time == OPT_ONE_TIME)
 856   5                {
 857   6      #ifdef __LOCK_AUDIO_SUPPORT__
 858   6                  if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 859   6                    mmi_dq_aud_play_with_id(AUD_ID_PWD_INPUT_AGAIN);
 860   6                  else if (status == SYS_STATUS_DEL_PWD)
 861   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_PWD_AGAIN);
 862   6                  else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 863   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD_INIT_AGAIN);
 864   6                  else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 865   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD_AGAIN);
 866   6      #endif
 867   6      
 868   6                  opt_time = OPT_TWO_TIME;
 869   6                  key_len = 0;
 870   6                  memset(input_key_2, 0xFF, sizeof(input_key_2));
 871   6                }
 872   5                else if (opt_time == OPT_TWO_TIME)
 873   5                {
 874   6                  if (0 == memcmp(input_key_1, input_key_2, PWD_INPUT_MAX_LEN))
 875   6                  {
 876   7                    if (status == SYS_STATUS_DEL_PWD)
 877   7                    {
 878   8                      unsigned char del_index = mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_USER);
 879   8                      if (del_index == 0xFF)
 880   8      #ifdef __LOCK_AUDIO_SUPPORT__
 881   8                        mmi_dq_aud_play_with_id(AUD_ID_PWD_NOT_EXIST)
 882   8      #endif
 883   8                          ;
 884   8                      else
 885   8                      {
 886   9                        if (mmi_dq_fs_del_pwd(del_index, FDS_USE_TYPE_USER) == RET_SUCESS)
 887   9                        {
 888  10                          get_index = del_index;
 889  10      #ifdef __LOCK_AUDIO_SUPPORT__
 890  10                          mmi_dq_aud_play_with_id(AUD_ID_DEL_PWD_SUCESS);
 891  10      #endif
 892  10      #ifdef __LOCK_WIFI_SUPPORT__
 893  10                          mmi_dq_wifi_del_password(get_index);
 894  10      #endif
 895  10                          // printfV("get_index", (int)get_index);
 896  10                        }
 897   9                        else
 898   9      #ifdef __LOCK_AUDIO_SUPPORT__
 899   9                          mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL)
 900   9      #endif
 901   9                            ;
 902   9                        mmi_dq_sys_del_pwd_con();
 903   9                      }
 904   8                    }
 905   7                    else if (mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_ALL) != 0xFF)
 906   7      #ifdef __LOCK_AUDIO_SUPPORT__
 907   7                      mmi_dq_aud_play_with_id(AUD_ID_PWD_EXIST)
 908   7      #endif
 909   7                        ;
 910   7                    else
 911   7                    {
 912   8                      if (status == SYS_STATUS_ADD_PWD)
 913   8                      {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 16  

 914   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_USER) == RET_FAIL)
 915   9      #ifdef __LOCK_AUDIO_SUPPORT__
 916   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL)
 917   9      #endif
 918   9                            ;
 919   9                        else
 920   9                        {
 921  10      #ifdef __LOCK_AUDIO_SUPPORT__
 922  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_PWD_SUCESS);
 923  10      #endif
 924  10      #ifdef __LOCK_WIFI_SUPPORT__
 925  10                          mmi_dq_wifi_add_password(get_index);
 926  10      #endif
 927  10                          // printfV("get_index", (int)get_index);
 928  10                        }
 929   9      #ifdef __LOCK_WIFI_SUPPORT__
 930   9                        if (wifi_add_flag == 1)
 931   9                        {
 932  10                          wifi_add_flag = 0xff;
 933  10                          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 934  10                        }
 935   9                        else
 936   9      #endif
 937   9                          mmi_dq_sys_add_pwd_con();
 938   9                      }
 939   8                      else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 940   8                      {
 941   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == RET_FAIL)
 942   9      #ifdef __LOCK_AUDIO_SUPPORT__
 943   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL)
 944   9      #endif
 945   9                            ;
 946   9                        else
 947   9                        {
 948  10      #ifdef __LOCK_AUDIO_SUPPORT__
 949  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_ADMIN_PWD_INIT_SUCESS);
 950  10      #endif
 951  10      #ifdef __LOCK_WIFI_SUPPORT__
 952  10                          mmi_dq_wifi_add_password(get_index);
 953  10      #endif
 954  10                          // printfV("get_index", (int)get_index);
 955  10                        }
 956   9      #ifdef __LOCK_FP_SUPPORT__
                                mmi_dq_sys_chg_admin_fp_No1();
              #else
 959   9                        if (0 == mmi_dq_fs_get_admin_status())
 960   9                          mmi_dq_sys_lock_add_admin_suc();
 961   9                        else
 962   9                          mmi_dq_sys_show_cur_menu_list();
 963   9      #endif
 964   9                      }
 965   8                      else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 966   8                      {
 967   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == RET_FAIL)
 968   9      #ifdef __LOCK_AUDIO_SUPPORT__
 969   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL)
 970   9      #endif
 971   9                            ;
 972   9                        else
 973   9                        {
 974  10      #ifdef __LOCK_AUDIO_SUPPORT__
 975  10                          mmi_dq_aud_play_with_id(AUD_ID_CHG_ADMIN_PWD_SUCESS);
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 17  

 976  10      #endif
 977  10      #ifdef __LOCK_WIFI_SUPPORT__
 978  10                          mmi_dq_wifi_add_password(get_index);
 979  10      #endif
 980  10                          // printfV("get_index", (int)get_index);
 981  10                        }
 982   9                        mmi_dq_sys_show_cur_menu_list();
 983   9                      }
 984   8      #ifdef __LOCK_110_SUPPORT__
 985   8                      else if (status == SYS_STATUS_ADD_110_PWD)
 986   8                      {
 987   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_110) == RET_FAIL)
 988   9      #ifdef __LOCK_AUDIO_SUPPORT__
 989   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL)
 990   9      #endif
 991   9                            ;
 992   9                        else
 993   9                        {
 994  10      #ifdef __LOCK_WIFI_SUPPORT__
 995  10                          mmi_dq_wifi_set_110();
 996  10      #endif
 997  10      #ifdef __LOCK_AUDIO_SUPPORT__
 998  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_PWD_SUCESS);
 999  10      #endif
1000  10      #ifdef __LOCK_WIFI_SUPPORT__
1001  10                          mmi_dq_wifi_add_password(get_index);
1002  10      #endif
1003  10                          // printfV("get_index", (int)get_index);
1004  10                        }
1005   9                        mmi_dq_sys_show_cur_menu_list();
1006   9                      }
1007   8      #endif
1008   8                    }
1009   7                  }
1010   6                  else
1011   6                  {
1012   7      #ifdef __LOCK_AUDIO_SUPPORT__
1013   7                    mmi_dq_aud_play_with_id(AUD_ID_PWD_NOT_SAME_RETRY);
1014   7      #endif
1015   7                  }
1016   6                  mmi_ms_pwd_init_var();
1017   6                }
1018   5              }
1019   4            }
1020   3            return;
1021   3          }
1022   2          break;
1023   2      #ifdef __LOCK_FP_SUPPORT__
                case SYS_STATUS_ADD_FP:
                case SYS_STATUS_DEL_FP:
              #ifdef __LOCK_110_SUPPORT__
                case SYS_STATUS_ADD_110_FP:
                case SYS_STATUS_DEL_110_FP:
              #endif
              #endif
1031   2      #ifdef __LOCK_RFID_CARD_SUPPORT__
1032   2        case SYS_STATUS_ADD_RFID:
1033   2        case SYS_STATUS_DEL_RFID:
1034   2      #endif
1035   2          if (key_val == KEY_S)
1036   2          {
1037   3      #ifdef __LOCK_AUDIO_SUPPORT__
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 18  

1038   3            mmi_dq_aud_play_key_tone();
1039   3      #endif
1040   3      #ifdef __LOCK_WIFI_SUPPORT__
1041   3            if (wifi_add_flag == 1)
1042   3            {
1043   4              wifi_add_flag = 0xff;
1044   4              mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1045   4            }
1046   3            else
1047   3      #endif
1048   3              mmi_dq_sys_show_cur_menu_list();
1049   3          }
1050   2          break;
1051   2      #ifdef __LOCK_FP_SUPPORT__
                case SYS_STATUS_ADD_ADMIN_FP1:
                case SYS_STATUS_ADD_ADMIN_FP2:
                  if (key_val == KEY_S)
                  {
              #ifdef __LOCK_AUDIO_SUPPORT__
                    mmi_dq_aud_play_key_tone();
              #endif
                    if (0 == mmi_dq_fs_get_admin_status())
                      mmi_dq_sys_lock_add_admin_suc();
                    else
                      mmi_dq_sys_show_cur_menu_list();
                  }
                  break;
              #endif
1066   2        case SYS_STATUS_CLR_PWD:
1067   2        case SYS_STATUS_ADD_PWD_CON:
1068   2        case SYS_STATUS_DEL_PWD_CON:
1069   2      #ifdef __LOCK_FP_SUPPORT__
                case SYS_STATUS_CLR_FP:
                case SYS_STATUS_ADD_FP_CON:
                case SYS_STATUS_DEL_FP_CON:
              #endif
1074   2      #ifdef __LOCK_RFID_CARD_SUPPORT__
1075   2        case SYS_STATUS_CLR_RFID:
1076   2        case SYS_STATUS_ADD_RFID_CON:
1077   2        case SYS_STATUS_DEL_RFID_CON:
1078   2      #endif
1079   2        case SYS_STATUS_RESTORE_LOCK_CON:
1080   2          if (key_val == KEY_H)
1081   2          {
1082   3      #ifdef __LOCK_AUDIO_SUPPORT__
1083   3            mmi_dq_aud_play_key_tone();
1084   3      #endif
1085   3            switch (status)
1086   3            {
1087   4            case SYS_STATUS_CLR_PWD:
1088   4              if (RET_SUCESS == mmi_dq_fs_clr_pwd())
1089   4              {
1090   5      #ifdef __LOCK_AUDIO_SUPPORT__
1091   5                mmi_dq_aud_play_with_id(AUD_ID_CLR_PWD_SUCESS)
1092   5      #endif
1093   5                  ;
1094   5      #ifdef __LOCK_WIFI_SUPPORT__
1095   5                mmi_dq_wifi_clr_pwd_suc();
1096   5      #endif
1097   5              }
1098   4              else
1099   4      #ifdef __LOCK_AUDIO_SUPPORT__
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 19  

1100   4                mmi_dq_aud_play_with_id(AUD_ID_CLR_PWD_FAIL)
1101   4      #endif
1102   4                  ;
1103   4              mmi_dq_sys_show_cur_menu_list();
1104   4              break;
1105   4      #ifdef __LOCK_FP_SUPPORT__
                    case SYS_STATUS_CLR_FP:
                      if (RET_SUCESS == mmi_dq_fs_clr_fp())
                      {
              #ifdef __LOCK_AUDIO_SUPPORT__
                        mmi_dq_aud_play_with_id(AUD_ID_CLR_FP_SUCESS);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                        mmi_dq_wifi_clr_fps_suc();
              #endif
                      }
                      else
              #ifdef __LOCK_AUDIO_SUPPORT__
                        mmi_dq_aud_play_with_id(AUD_ID_CLR_FP_FAIL)
              #endif
                          ;
                      mmi_dq_sys_show_cur_menu_list();
                      break;
              #endif
1124   4      #ifdef __LOCK_RFID_CARD_SUPPORT__
1125   4            case SYS_STATUS_CLR_RFID:
1126   4              if (RET_SUCESS == mmi_dq_fs_clr_rfid())
1127   4              {
1128   5      #ifdef __LOCK_AUDIO_SUPPORT__
1129   5                mmi_dq_aud_play_with_id(AUD_ID_CLR_RFCARD_SUCESS);
1130   5      #endif
1131   5      #ifdef __LOCK_WIFI_SUPPORT__
1132   5                mmi_dq_wifi_clr_rfid_suc();
1133   5      #endif
1134   5              }
1135   4              else
1136   4      #ifdef __LOCK_AUDIO_SUPPORT__
1137   4                mmi_dq_aud_play_with_id(AUD_ID_CLR_RFCARD_FAIL)
1138   4      #endif
1139   4                  ;
1140   4              mmi_dq_sys_show_cur_menu_list();
1141   4              break;
1142   4      #endif
1143   4            case SYS_STATUS_ADD_PWD_CON:
1144   4              mmi_dq_sys_add_pwd();
1145   4              break;
1146   4            case SYS_STATUS_DEL_PWD_CON:
1147   4              mmi_dq_sys_del_pwd();
1148   4              break;
1149   4      #ifdef __LOCK_FP_SUPPORT__
                    case SYS_STATUS_ADD_FP_CON:
                      mmi_dq_sys_add_fp();
                      break;
                    case SYS_STATUS_DEL_FP_CON:
                      mmi_dq_sys_del_fp();
                      break;
              #endif
1157   4      #ifdef __LOCK_RFID_CARD_SUPPORT__
1158   4            case SYS_STATUS_ADD_RFID_CON:
1159   4              mmi_dq_sys_add_rf();
1160   4              break;
1161   4            case SYS_STATUS_DEL_RFID_CON:
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 20  

1162   4              mmi_dq_sys_del_rf();
1163   4              break;
1164   4      #endif
1165   4            case SYS_STATUS_RESTORE_LOCK_CON:
1166   4              mmi_dq_sys_restore_lock();
1167   4              break;
1168   4            }
1169   3          }
1170   2          else if (key_val == KEY_S)
1171   2          {
1172   3      #ifdef __LOCK_AUDIO_SUPPORT__
1173   3            mmi_dq_aud_play_key_tone();
1174   3      #endif
1175   3            mmi_dq_sys_show_cur_menu_list();
1176   3          }
1177   2          break;
1178   2        case SYS_STATUS_SYS_MENU:
1179   2          if (key_val == KEY_S)
1180   2          {
1181   3      #ifdef __LOCK_AUDIO_SUPPORT__
1182   3            mmi_dq_aud_play_key_tone();
1183   3      #endif
1184   3            mmi_dq_sys_get_pre_menu_list();
1185   3          }
1186   2          else if (key_val != KEY_0 && key_val <= mmi_dq_sys_get_menu_count())
1187   2          {
1188   3      #ifdef __LOCK_AUDIO_SUPPORT__
1189   3            mmi_dq_aud_play_key_tone();
1190   3      #endif
1191   3            mmi_dq_sys_exe_menu_fun(key_val - 1);
1192   3          }
1193   2          break;
1194   2      #ifdef __FACTORY_TEST_SUPPORT__
1195   2        case SYS_STATUS_FM_MODE:
1196   2        {
1197   3          unsigned char str = mmi_dq_factory_mode_get_test_project();
1198   3          if (str == STR_ID_KEY)
1199   3          {
1200   4      #ifdef __LOCK_AUDIO_SUPPORT__
1201   4            // mmi_dq_aud_play_key_num(key_val);
1202   4            mmi_dq_aud_play_key_tone();
1203   4      #endif
1204   4            mmi_dq_factory_mode_key_test(key_val);
1205   4          }
1206   3          else if (str == STR_ID_MOTO)
1207   3          {
1208   4            if (key_val == KEY_S)
1209   4            {
1210   5      #ifdef __LOCK_AUDIO_SUPPORT__
1211   5              mmi_dq_aud_play_key_tone();
1212   5      #endif
1213   5      #ifdef __LOCK_MOTOR_SUPPORT__
1214   5              mmi_dq_factory_mode_motor_test_back();
1215   5      #endif
1216   5              if (mmi_dq_fs_get_factory_flag() != 0)
1217   5                mmi_dq_factory_mode_test_stop();
1218   5              else
1219   5              {
1220   6      #ifdef __LOCK_MOTOR_SUPPORT__
1221   6                delay_ms(600);
1222   6                mmi_dq_factory_mode_motor_test();
1223   6      #endif
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 21  

1224   6              }
1225   5            }
1226   4            else if (key_val == KEY_H)
1227   4            {
1228   5      #ifdef __LOCK_AUDIO_SUPPORT__
1229   5              mmi_dq_aud_play_key_tone();
1230   5      #endif
1231   5      #ifdef __LOCK_MOTOR_SUPPORT__
1232   5              mmi_dq_factory_mode_motor_test_back();
1233   5      #endif
1234   5              mmi_dq_factory_mode_test_item_result(STR_ID_MOTO, 1);
1235   5            }
1236   4          }
1237   3          else if (mmi_dq_fs_get_factory_flag() != 0)
1238   3          {
1239   4      #ifdef __LOCK_AUDIO_SUPPORT__
1240   4            mmi_dq_aud_play_key_tone();
1241   4      #endif
1242   4            mmi_dq_factory_mode_test_stop();
1243   4          }
1244   3        }
1245   2        break;
1246   2      #endif
1247   2      #ifdef __LOCK_WIFI_SUPPORT__
1248   2        case SYS_STATUS_WIFI_MODE:
1249   2          //if(key_val == KEY_S)
1250   2          //{
1251   2      #ifdef __LOCK_AUDIO_SUPPORT__
1252   2          mmi_dq_aud_stop();
1253   2      #endif
1254   2      #ifdef __LOCK_AUDIO_SUPPORT__
1255   2          mmi_dq_aud_play_with_id(AUD_ID_WIFI_CONNECTING);
1256   2      #endif
1257   2          //  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1258   2          //}
1259   2          break;
1260   2      #endif
1261   2        case SYS_STATUS_LOW_POWER:
1262   2      #ifdef __LOCK_AUDIO_SUPPORT__
1263   2          mmi_dq_aud_stop();
1264   2      #endif
1265   2      #ifdef __LOCK_AUDIO_SUPPORT__
1266   2          mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
1267   2      #endif
1268   2      #ifdef __LOCK_WIFI_SUPPORT__
1269   2          mmi_dq_wifi_lowpower_alarm();
1270   2      #endif
1271   2          break;
1272   2        default:
1273   2          break;
1274   2        }
1275   1        return;
1276   1      }
1277          
1278          #ifdef __LOCK_FP_SUPPORT__
              /*
              parameter: 
                none
              return :
                none
              */
              void mmi_ms_fps_opt_fun(unsigned char fps_val)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 22  

              {
                RET_VAL retval = 0;
                unsigned short index = 0;
                SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
                if (status == SYS_STATUS_LOW_POWER)
                {
              #ifdef __LOCK_AUDIO_SUPPORT__
                  mmi_dq_aud_stop();
              #endif
              #ifdef __LOCK_AUDIO_SUPPORT__
                  mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                  mmi_dq_wifi_lowpower_alarm();
              #endif
                  return;
                }
                else if (status == SYS_STATUS_WAIT_FOR_ENTER_SLEEP)
                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
              
                if ((status != SYS_STATUS_INPUT_FP && status != SYS_STATUS_ADD_FP && status != SYS_STATUS_DEL_FP && statu
             -s != SYS_STATUS_ADD_ADMIN_FP1 && status != SYS_STATUS_ADD_ADMIN_FP2 && status != SYS_STATUS_ADD_110_FP && status != SYS_
             -STATUS_DEL_110_FP)
              #ifdef __FACTORY_TEST_SUPPORT__
                  || (status == SYS_STATUS_FM_MODE && STR_ID_FINGERPRINT != mmi_dq_factory_mode_get_test_project())
              #endif
                )
                  return;
              
              #ifdef __LOCK_AUDIO_SUPPORT__
                mmi_dq_aud_stop();
              #endif
                if (mmi_dq_sys_door_state_check() == 1)
                {
              #ifdef __LOCK_AUDIO_SUPPORT__
                  mmi_dq_aud_stop();
              #endif
              #ifdef __LOCK_AUDIO_SUPPORT__
                  mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                  mmi_dq_wifi_fp_alarm();
              #endif
                  return;
                }
              
                retval = mmi_dq_fp_get_image();
              
                if (retval == 0)
                {
                  // printfS("mmi_dq_fp_get_image", "ok");
                  // if (opt_time != 0)
                  //  retval = mmi_dq_fp_gen_char(0);
                  // if (retval == 0)
                  retval = mmi_dq_fp_gen_char(opt_time);
                  if (retval == 0)
                  {
                    // printfS("mmi_dq_fp_gen_char", "ok");
                    retval = mmi_dq_fp_high_speed_search(opt_time, &index);
                    if (retval == 0)
                    {
                      // printfS("mmi_dq_fp_high_speed_search", "ok");
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 23  

                      if (status == SYS_STATUS_INPUT_FP)
                      {
                        retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_ALL);
                        if (retval == RET_SUCESS)
                        {
                          get_index = index;
                          mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_110_SUPPORT__
                          if (mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_110) == RET_SUCESS)
                          {
                            mmi_dq_sys_door_open(SYS_OPEN_BY_110_FP);
                          }
                          else
              #endif
                            mmi_dq_sys_door_open(SYS_OPEN_BY_FP);
                        }
                        else
                        {
                          mmi_dq_fp_light(FP_RED);
                          mmi_dq_sys_door_open_fail(SYS_OPEN_BY_FP);
                        }
                      }
                      else if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_ADMIN_FP1 || status == SYS_STATUS_ADD
             -_ADMIN_FP2 || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
                      {
                        mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                        mmi_dq_aud_play_with_id(AUD_ID_FP_EXIST);
              #endif
                      }
                      else if (status == SYS_STATUS_DEL_FP || status == SYS_STATUS_DEL_110_FP)
                      {
              #ifdef __LOCK_110_SUPPORT__
                        if (status == SYS_STATUS_DEL_FP)
                          retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_USER);
                        else if (status == SYS_STATUS_DEL_110_FP)
                          retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_110);
              #else
                        retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_USER);
              #endif
                        if (retval == RET_SUCESS)
                        {
                          static unsigned char del_num = 0;
                          if (opt_time == OPT_ONE_TIME)
                          {
                            opt_time = OPT_TWO_TIME;
                            del_num = index;
                            mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                            mmi_dq_aud_play_with_id(AUD_ID_PRESS_DEL_FP_AGAIN);
              #endif
                          }
                          else
                          {
                            //retval = mmi_dq_fp_match();
                            if (del_num == index)
                              retval = 0;
                            else
                              retval = 255;
                            if (retval == 0) //|| retval == 255)
                            {
              #ifdef __LOCK_110_SUPPORT__
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 24  

                              if (status == SYS_STATUS_DEL_FP)
                                retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_USER);
                              else if (status == SYS_STATUS_DEL_110_FP)
                                retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_110);
              #else
                              retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_USER);
              #endif
                              if (retval == RET_SUCESS)
                              {
                                retval = mmi_dq_fp_delete(index);
                              }
                              if (retval == 0)
                              {
                                mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                mmi_dq_aud_play_with_id(AUD_ID_DEL_FP_SUCESS);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                                mmi_dq_wifi_del_fp(index);
              #endif
                              }
                              else
                              {
                                mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL);
              #endif
                              }
              #ifdef __LOCK_110_SUPPORT__
                              if (status == SYS_STATUS_DEL_FP)
                                mmi_dq_sys_del_fp_con();
                              else if (status == SYS_STATUS_DEL_110_FP)
                                mmi_dq_sys_show_cur_menu_list();
              #else
                              mmi_dq_sys_del_fp_con();
              #endif
                            }
                            else
                            {
                              mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                              mmi_dq_aud_play_with_id(AUD_ID_FP_TWICE_NOT_SAME_RETRY);
              #endif
                            }
                            opt_time = OPT_ONE_TIME;
                          }
                        }
                        else
                        {
                          mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                          mmi_dq_aud_play_with_id(AUD_ID_FP_NOT_EXIST);
              #endif
                        }
                      }
                    }
                    else
                    {
                      // printfS("mmi_dq_fp_high_speed_search", "error");
                      if (status == SYS_STATUS_INPUT_FP)
                      {
                        mmi_dq_fp_light(FP_RED);
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 25  

              #ifdef __LOCK_AUDIO_SUPPORT__
                        // mmi_dq_aud_play_with_id(AUD_ID_FP_WRONG_TRY);
              #endif
                        mmi_dq_sys_door_open_fail(SYS_OPEN_BY_FP);
                      }
                      else if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_ADMIN_FP1 || status == SYS_STATUS_ADD
             -_ADMIN_FP2 || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
                      {
                        if (opt_time == FPS_MAX_INPUT_TIME)
                        {
                          retval = mmi_dq_fp_reg_module();
                          if (retval == 0)
                          {
                            // printfS("mmi_dq_fp_reg_module", "ok");
                            if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
                            {
              #ifdef __LOCK_110_SUPPORT__
                              if (status == SYS_STATUS_ADD_110_FP)
                                index = mmi_dq_fs_get_fp_110_unuse_index();
                              else
              #endif
                                index = mmi_dq_fs_get_fp_unuse_index();
                              if (index == 0xFF)
                              {
                                // printfS("mmi_dq_fs_get_fp_unuse_index", "error");
                                mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                mmi_dq_aud_play_with_id(AUD_ID_FP_FULL);
              #endif
                                mmi_dq_sys_show_cur_menu_list();
                              }
                              else
                              {
                                // printfS("mmi_dq_fs_get_fp_unuse_index", "ok");
                                // printfV("index", (int)index);
                                retval = mmi_dq_fp_store_char(0, index);
                                if (status == SYS_STATUS_ADD_FP)
                                {
                                  if (retval == 0)
                                  {
                                    // printfS("mmi_dq_fp_store_char", "ok");
                                    retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_USER);
                                    if (retval != 0)
                                      mmi_dq_fp_delete(index);
                                  }
                                  if (retval == 0)
                                  {
                                    // printfS("mmi_dq_fs_set_fp", "ok");
                                    mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                                    mmi_dq_wifi_add_fp(index);
              #endif
                                  }
                                  else
                                  {
                                    // printfS("mmi_dq_fp_store_char", "error");
                                    mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 26  

              #endif
                                  }
              #ifdef __LOCK_WIFI_SUPPORT__
                                  if (wifi_add_flag == 1)
                                  {
                                    wifi_add_flag = 0xff;
                                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
                                  }
                                  else
              #endif
                                    mmi_dq_sys_add_fp_con();
                                }
              #ifdef __LOCK_110_SUPPORT__
                                else if (status == SYS_STATUS_ADD_110_FP)
                                {
                                  if (retval == 0)
                                  {
                                    retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_110);
                                    if (retval != 0)
                                      mmi_dq_fp_delete(index);
                                  }
                                  if (retval == 0)
                                  {
                                    mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                                    mmi_dq_wifi_set_110();
                                    mmi_dq_wifi_add_fp(index);
              #endif
                                  }
                                  else
                                  {
                                    mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
              #endif
                                  }
                                  mmi_dq_sys_show_cur_menu_list();
                                }
              #endif
              #ifdef __FACTORY_TEST_SUPPORT__
                                else
                                {
                                  if (retval == 0)
                                  {
                                    retval = mmi_dq_fp_delete(index);
                                  }
                                  if (retval == 0)
                                  {
                                    mmi_dq_fp_light(FP_GREEN);
                                    mmi_dq_factory_mode_test_item_result(STR_ID_FINGERPRINT, 1);
                                  }
                                  else
                                  {
                                    mmi_dq_fp_light(FP_RED);
                                    mmi_dq_factory_mode_test_item_result(STR_ID_FINGERPRINT, 0);
                                  }
                                }
              #endif
                              }
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 27  

                            }
                            else
                            {
                              if (status == SYS_STATUS_ADD_ADMIN_FP1)
                                index = 0;
                              else if (status == SYS_STATUS_ADD_ADMIN_FP2)
                                index = 1;
                              retval = mmi_dq_fp_delete(index);
                              if (retval == 0)
                                retval = mmi_dq_fp_store_char(0, index);
                              if (retval == 0)
                                retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_ADMIN);
                              if (retval == 0)
                              {
                                mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
              #endif
              #ifdef __LOCK_WIFI_SUPPORT__
                                mmi_dq_wifi_add_fp(index);
              #endif
                              }
                              else
                              {
                                mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                                mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
              #endif
                              }
                              if (0 == mmi_dq_fs_get_admin_status())
                              {
                                if (status == SYS_STATUS_ADD_ADMIN_FP1)
                                  mmi_dq_sys_chg_admin_fp_No2();
                                else
                                  mmi_dq_sys_lock_add_admin_suc();
                              }
                              else
                                mmi_dq_sys_show_cur_menu_list();
                            }
                          }
                          else
                          {
                            mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                            mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL_RETRY);
              #endif
                          }
                          opt_time = OPT_ONE_TIME;
                        }
                        else
                        {
                          opt_time++;
                          mmi_dq_fp_light(FP_GREEN);
              #ifdef __LOCK_AUDIO_SUPPORT__
                          mmi_dq_aud_play_with_id(AUD_ID_PRESS_FP_AGAIN);
              #endif
                        }
                      }
                      else if (status == SYS_STATUS_DEL_FP)
                      {
                        mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 28  

                        mmi_dq_aud_play_with_id(AUD_ID_FP_NOT_EXIST);
              #endif
                      }
                    }
                    return;
                  }
                }
                // printfS("mmi_dq_fp_get_image", "error");
              
                mmi_dq_fp_light(FP_RED);
              #ifdef __LOCK_AUDIO_SUPPORT__
                mmi_dq_aud_play_with_id(AUD_ID_PRESS_FP_AGAIN);
              #endif
                return;
              }
              #endif
1670          
1671          #ifdef __LOCK_RFID_CARD_SUPPORT__
1672          /*
1673          parameter: 
1674            none
1675          return :
1676            none
1677          */
1678          void mmi_ms_rfid_opt_fun(unsigned char rfid_val)
1679          {
1680   1        RET_VAL retval = RET_SUCESS;
1681   1        unsigned char index = 0;
1682   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
1683   1      
1684   1        if (status == SYS_STATUS_LOW_POWER)
1685   1        {
1686   2      #ifdef __LOCK_AUDIO_SUPPORT__
1687   2          mmi_dq_aud_stop();
1688   2      #endif
1689   2      #ifdef __LOCK_AUDIO_SUPPORT__
1690   2          mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
1691   2      #endif
1692   2      #ifdef __LOCK_WIFI_SUPPORT__
1693   2          mmi_dq_wifi_lowpower_alarm();
1694   2      #endif
1695   2          return;
1696   2        }
1697   1        else if (status == SYS_STATUS_WAIT_FOR_ENTER_SLEEP)
1698   1          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1699   1      
1700   1        if ((status != SYS_STATUS_INPUT_RFID && status != SYS_STATUS_ADD_RFID && status != SYS_STATUS_DEL_RFID)
1701   1      #ifdef __FACTORY_TEST_SUPPORT__
1702   1          || (status == SYS_STATUS_FM_MODE && STR_ID_RF_CARD != mmi_dq_factory_mode_get_test_project())
1703   1      #endif
1704   1        )
1705   1          return;
1706   1      
1707   1      #ifdef __LOCK_AUDIO_SUPPORT__
1708   1        mmi_dq_aud_stop();
1709   1      #endif
1710   1      
1711   1        if (mmi_dq_sys_door_state_check() == 1)
1712   1        {
1713   2      #ifdef __LOCK_AUDIO_SUPPORT__
1714   2          mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
1715   2      #endif
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 29  

1716   2      #ifdef __LOCK_WIFI_SUPPORT__
1717   2          mmi_dq_wifi_rfid_alarm();
1718   2      #endif
1719   2          return;
1720   2        }
1721   1      #ifdef __FACTORY_TEST_SUPPORT__
1722   1        if (status == SYS_STATUS_FM_MODE)
1723   1        {
1724   2          retval = mmi_dq_rfid_gen_char(opt_time);
1725   2          if (retval == RET_SUCESS)
1726   2          {
1727   3            if (opt_time == OPT_ONE_TIME)
1728   3            {
1729   4      #ifdef __LOCK_AUDIO_SUPPORT__
1730   4              mmi_dq_aud_play_with_id(AUD_ID_PRESS_RFCARD_AGAIN);
1731   4      #endif
1732   4              opt_time = OPT_TWO_TIME;
1733   4            }
1734   3            else
1735   3            {
1736   4              retval = mmi_dq_rfid_match();
1737   4              if (retval == RET_SUCESS)
1738   4      
1739   4                mmi_dq_factory_mode_test_item_result(STR_ID_RF_CARD, 1);
1740   4              else
1741   4      #ifdef __LOCK_AUDIO_SUPPORT__
1742   4                mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY)
1743   4      #endif
1744   4                  ;
1745   4              opt_time = OPT_ONE_TIME;
1746   4            }
1747   3          }
1748   2          return;
1749   2        }
1750   1      #endif
1751   1        retval = mmi_dq_rfid_search_by_temp(&index);
1752   1        if (retval == RET_SUCESS)
1753   1        {
1754   2          if (status == SYS_STATUS_INPUT_RFID)
1755   2          {
1756   3            mmi_dq_sys_door_open(SYS_OPEN_BY_RFID);
1757   3          }
1758   2          else if (status == SYS_STATUS_ADD_RFID)
1759   2          {
1760   3      #ifdef __LOCK_AUDIO_SUPPORT__
1761   3            mmi_dq_aud_play_with_id(AUD_ID_RFCARD_EXIST);
1762   3      #endif
1763   3          }
1764   2          else if (status == SYS_STATUS_DEL_RFID)
1765   2          {
1766   3            retval = mmi_dq_rfid_gen_char(opt_time);
1767   3            if (retval == RET_SUCESS)
1768   3            {
1769   4              if (opt_time == OPT_ONE_TIME)
1770   4              {
1771   5      #ifdef __LOCK_AUDIO_SUPPORT__
1772   5                mmi_dq_aud_play_with_id(AUD_ID_PRESS_DEL_RFCARD_AGAIN);
1773   5      #endif
1774   5                opt_time = OPT_TWO_TIME;
1775   5              }
1776   4              else
1777   4              {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 30  

1778   5                retval = mmi_dq_rfid_match();
1779   5                if (retval == RET_SUCESS)
1780   5                {
1781   6                  retval = mmi_dq_fs_del_rfid(index);
1782   6                  if (retval == RET_SUCESS)
1783   6                  {
1784   7                    get_index = index;
1785   7      #ifdef __LOCK_AUDIO_SUPPORT__
1786   7                    mmi_dq_aud_play_with_id(AUD_ID_DEL_RFCARD_SUCESS);
1787   7      #endif
1788   7      #ifdef __LOCK_WIFI_SUPPORT__
1789   7                    mmi_dq_wifi_del_rfid_suc(get_index);
1790   7      #endif
1791   7                    // printfV("get_index", (int)get_index);
1792   7                  }
1793   6                  else
1794   6      #ifdef __LOCK_AUDIO_SUPPORT__
1795   6                    mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL)
1796   6      #endif
1797   6                      ;
1798   6                  mmi_dq_sys_del_rf_con();
1799   6                }
1800   5                else
1801   5      #ifdef __LOCK_AUDIO_SUPPORT__
1802   5                  mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY)
1803   5      #endif
1804   5                    ;
1805   5                opt_time = OPT_ONE_TIME;
1806   5              }
1807   4            }
1808   3            else
1809   3      #ifdef __LOCK_AUDIO_SUPPORT__
1810   3              mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL_RETRY)
1811   3      #endif
1812   3                ;
1813   3          }
1814   2        }
1815   1        else
1816   1        {
1817   2          if (status == SYS_STATUS_ADD_RFID)
1818   2          {
1819   3            retval = mmi_dq_rfid_gen_char(opt_time);
1820   3            if (retval == RET_SUCESS)
1821   3            {
1822   4              if (opt_time == OPT_ONE_TIME)
1823   4              {
1824   5      #ifdef __LOCK_AUDIO_SUPPORT__
1825   5                mmi_dq_aud_play_with_id(AUD_ID_PRESS_RFCARD_AGAIN);
1826   5      #endif
1827   5                opt_time = OPT_TWO_TIME;
1828   5              }
1829   4              else
1830   4              {
1831   5                retval = mmi_dq_rfid_match();
1832   5                if (retval == RET_SUCESS)
1833   5                {
1834   6                  retval = mmi_dq_rfid_store(0);
1835   6                  if (retval == RET_SUCESS)
1836   6                  {
1837   7      #ifdef __LOCK_AUDIO_SUPPORT__
1838   7                    mmi_dq_aud_play_with_id(AUD_ID_ADD_RFCARD_SUCESS);
1839   7      #endif
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 31  

1840   7      #ifdef __LOCK_WIFI_SUPPORT__
1841   7                    mmi_dq_wifi_add_rfid_suc(get_index);
1842   7      #endif
1843   7                    // printfV("get_index", (int)get_index);
1844   7                  }
1845   6                  else
1846   6      #ifdef __LOCK_AUDIO_SUPPORT__
1847   6                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL)
1848   6      #endif
1849   6                      ;
1850   6      #ifdef __LOCK_WIFI_SUPPORT__
1851   6                  if (wifi_add_flag == 1)
1852   6                  {
1853   7                    wifi_add_flag = 0xff;
1854   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1855   7                  }
1856   6                  else
1857   6      #endif
1858   6                    mmi_dq_sys_add_rf_con();
1859   6                }
1860   5                else
1861   5      #ifdef __LOCK_AUDIO_SUPPORT__
1862   5                  mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY)
1863   5      #endif
1864   5                    ;
1865   5                opt_time = OPT_ONE_TIME;
1866   5              }
1867   4            }
1868   3            else
1869   3      #ifdef __LOCK_AUDIO_SUPPORT__
1870   3              mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL_RETRY)
1871   3      #endif
1872   3                ;
1873   3          }
1874   2          else if (status == SYS_STATUS_INPUT_RFID)
1875   2            mmi_dq_sys_door_open_fail(SYS_OPEN_BY_RFID);
1876   2          else
1877   2      #ifdef __LOCK_AUDIO_SUPPORT__
1878   2            mmi_dq_aud_play_with_id(AUD_ID_RFCARD_NOT_EXIST)
1879   2      #endif
1880   2              ;
1881   2        }
1882   1      
1883   1        return;
1884   1      }
*** WARNING C280 IN LINE 1678 OF mmi_src\mmi_ms.c: 'rfid_val': unreferenced local variable
1885          #endif
1886          
1887          /*
1888          parameter: 
1889            none
1890          return :
1891            none
1892          */
1893          void mmi_ms_reset_opt_fun(void)
1894          {
1895   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
1896   1      
1897   1        if (status == SYS_STATUS_FM_MODE
1898   1      #ifdef __FACTORY_TEST_SUPPORT__
1899   1          && STR_ID_RESET == mmi_dq_factory_mode_get_test_project()
1900   1      #endif
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 32  

1901   1        )
1902   1        {
1903   2      #ifdef __FACTORY_TEST_SUPPORT__
1904   2          mmi_dq_factory_mode_reset_test();
1905   2      #endif
1906   2          return;
1907   2        }
1908   1        else
1909   1        {
1910   2          if (RET_SUCESS == mmi_dq_fs_reset())
1911   2          {
1912   3      #ifdef __LOCK_AUDIO_SUPPORT__
1913   3            mmi_dq_aud_play_with_id(AUD_ID_RESTORE_SUCESS);
1914   3      #endif
1915   3      
1916   3      #ifdef __LOCK_WIFI_SUPPORT__
1917   3            mmi_dq_wifi_clr_pwd_suc();
1918   3            mmi_dq_wifi_clr_fps_suc();
1919   3            mmi_dq_wifi_clr_rfid_suc();
1920   3      #endif
1921   3          }
1922   2          else
1923   2      #ifdef __LOCK_AUDIO_SUPPORT__
1924   2            mmi_dq_aud_play_with_id(AUD_BASE_ID_FAIL)
1925   2      #endif
1926   2              ;
1927   2      
1928   2          mmi_dq_sys_add_admin_pwd();
1929   2        }
1930   1      }
1931          
1932          #ifdef __LOCK_WIFI_SUPPORT__
1933          /*
1934          parameter: 
1935            none
1936          return :
1937            none
1938          */
1939          void mmi_ms_wifi_opt_fun(void)
1940          {
1941   1        unsigned char type = mmi_dq_sys_get_wifi_check_type();
1942   1        if (type == 0)
1943   1          mmi_dq_wifi_check_connect();
1944   1        else if (type == 1)
1945   1          mmi_dq_wifi_check_open();
1946   1      }
1947          
1948          /************************************************************************************
1949           *                     Own function                     *
1950           ************************************************************************************/
1951          #ifdef __LOCK_VIRTUAL_PASSWORD__
              void mmi_dq_ms_idle_input_with_app_result(unsigned char ret_code)
              {
                unsigned char open_mode = 0;
              
                if (ret_code == 0xFF || ret_code == 4)
                {
                  if (mmi_dq_sys_lock_error() == 1)
                    ;
                  // mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_PWD_WRONG_TRY, SHOW_MESSAGE_DELAY
             -_TIME, BASE_STATUS_M_SAVE_LOG);
                  else
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 33  

                    ;
                  //  mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_PWD_WRONG_TRY, SHOW_MESSAGE_DELA
             -Y_TIME, BASE_STATUS_M_IDLE);
                }
                else if (ret_code == 2)
                {
                  mmi_dq_sys_lock_correct();
                  //dq_otp_add_open_log_by_temp(0);
                  //mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_CLR_PWD_SUCESS, SHOW_MESSAGE_DELAY
             -_TIME, BASE_STATUS_M_SAVE_LOG);
                }
                else if (ret_code == 5)
                {
                  mmi_dq_sys_lock_correct();
                  //mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_PWD_FULL, SHOW_MESSAGE_DELAY_TIME,
             - BASE_STATUS_M_IDLE);
                }
                else if (ret_code == 6)
                {
                  //mmi_dq_sys_lock_correct();
                  //mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_APP_SYN, SHOW_MESSAGE_DELAY_TIME, 
             -BASE_STATUS_M_IDLE);
                }
                //else if(ret_code == 3)
                //{
                //  mmi_dq_sys_lock_correct();
                //dq_otp_add_open_log_by_temp(0);
                //  mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD,LOCK_ADMIN,STR_ID_RESET_TIME_SUCESS,SHOW_MESSAGE_DELAY
             -_TIME,BASE_STATUS_M_SAVE_LOG);
                //}
                else
                {
                  mmi_dq_sys_lock_correct();
                  open_mode = mmi_dq_fs_get_open_mode();
                  if (open_mode == MS_OPEN_MODE_DBL)
                  {
                    if (g_dbl_open_mode_fp_flag == 1 || g_dbl_open_mode_rf_flag == 1)
                    {
                      g_dbl_open_mode_fp_flag = 0;
                      g_dbl_open_mode_rf_flag = 0;
                      //dq_otp_add_open_log_by_temp(1);
                      //mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_OPEN_DOOR, OPEN_LOCK_DELAY_TIME,
             - BASE_STATUS_M_SAVE_LOG_WITH_CLOSE);
                    }
                    else
                    {
                      g_dbl_open_mode_pwd_flag = 1;
                      if (mmi_dq_fs_app_init_sucess())
                        ;
                      //dq_otp_add_exchange_temp_open_log(0, 1);
                      //mmi_dq_sys_show_message_with_id(STR_ID_SYSTEM, LOCK_ADMIN, STR_ID_DBL_OPEN_MODE, SHOW_MESSAGE_DELAY_
             -TIME / 2, BASE_STATUS_M_IDLE);
                    }
                  }
                  else
                  {
                    //dq_otp_add_open_log_by_temp(0);
                    //mmi_dq_sys_show_message_with_id(STR_ID_PASSWORD, LOCK_ADMIN, STR_ID_OPEN_DOOR, OPEN_LOCK_DELAY_TIME, 
             -BASE_STATUS_M_SAVE_LOG_WITH_CLOSE);
                  }
                }
              }
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/28/2021 10:59:01 PAGE 34  

              
              #endif //__LOCK_VIRTUAL_PASSWORD__
2018          /************************************************************************************
2019           *                     End function                     *
2020           ************************************************************************************/
2021          
2022          #endif
2023          #endif //__MMI_MS_C__


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3939    ----
   CONSTANT SIZE    =    199    ----
   XDATA SIZE       =     72      94
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
