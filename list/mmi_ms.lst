C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE MMI_MS
OBJECT MODULE PLACED IN .\output\mmi_ms.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE mmi_src\mmi_ms.c LARGE OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\include;.\
                    -Library\byd_standard_peripheral\include;.\byd_api\byd_key\include;.\byd_api\byd_mifare\include;.\byd_tool_comm;.\byd_rfi
                    -d;.\mmi_inc) DEBUG PRINT(.\list\mmi_ms.lst) TABS(2) OBJECT(.\output\mmi_ms.obj)

line level    source

   1          #ifndef __MMI_MS_C__
   2          #define __MMI_MS_C__
   3          
   4          #include "string.h"
   5          #include "mmi_ms.h"
   6          #include "mmi_key.h"
   7          #include "mmi_sys.h"
   8          #include "mmi_audio.h"
   9          #include "mmi_fps.h"
  10          #include "mmi_rfid.h"
  11          #include "mmi_com.h"
  12          #include "mmi_fs.h"
  13          #include "mmi_rst.h"
  14          #include "dqiot_drv.h"
  15          #include "delay.h"
  16          #include "mmi_fs.h"
  17          #include "mmi_fm.h"
  18          #include "mmi_wifi.h"
  19          #include "dqiot_drv_wifi.h"
  20          // #include <stdio.h>
  21          
  22          unsigned char input_key_1[KEY_INPUT_MAX_LEN];
  23          unsigned char input_key_2[KEY_INPUT_MAX_LEN];
  24          unsigned char key_len = 0;
  25          OPERATE_TIME opt_time = OPT_TIME_INVALID;
  26          static SYS_BASE_STATUS data sys_state = SYS_STATUS_INVALID;
  27          
  28          static unsigned char data key_last_value = KEY_INVALID;
  29          #ifdef __LOCK_RFID_CARD_SUPPORT__
  30          static unsigned char rfid_last_flag = 0;
  31          #endif
  32          #ifdef __LOCK_BUS_SUPPORT__
  33          static unsigned char admin_check_type = 0;
  34          #endif
  35          
  36          // extern void printfS(char *show, char *status);
  37          // extern void printfV(char *show, int value);
  38          
  39          /*
  40          parameter: 
  41            none
  42          return :
  43            none
  44          */
  45          void mmi_task_proc(void)
  46          {
  47   1        unsigned char touch_value = 0xFF;
  48   1        unsigned char key_value = KEY_INVALID;
  49   1      
  50   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
  51   1        if (mmi_dq_sys_get_rfid_flag() == 1)
  52   1        {
  53   2          //check rfid press
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 2   

  54   2          if (mmi_dq_rfid_check() == RET_SUCESS)
  55   2          {
  56   3            if (mmi_dq_rfid_work() == RET_SUCESS)
  57   3            {
  58   4              if (rfid_last_flag == 0)
  59   4              {
  60   5                rfid_last_flag = 1;
  61   5                mmi_dq_ms_set_msg_que(QUE_EVENT_RFID, QUE_PRO_LOW, 0);
  62   5              }
  63   4            }
  64   3            else
  65   3            {
  66   4              rfid_last_flag = 0;
  67   4            }
  68   3          }
  69   2        }
  70   1      #endif
  71   1        //check key press
  72   1        touch_value = mmi_dq_key_work();
  73   1        if (touch_value != 0xFF)
  74   1        {
  75   2          key_value = mmi_dq_get_key_map(touch_value);
  76   2          if (key_value != KEY_INVALID)
  77   2          {
  78   3            if (key_last_value != key_value)
  79   3            {
  80   4              key_last_value = key_value;
  81   4              mmi_dq_ms_set_msg_que(QUE_EVENT_KEY, QUE_PRO_LOW, key_value);
  82   4            }
  83   3          }
  84   2          else
  85   2            key_last_value = KEY_INVALID;
  86   2        }
  87   1        else
  88   1          key_last_value = KEY_INVALID;
  89   1      
  90   1        if (mmi_dq_aud_get_end_flag() != 0)
  91   1          mmi_dq_ms_set_msg_que(QUE_EVENT_AUDIO_END, QUE_PRO_LOW, 0);
  92   1      
  93   1        if (mmi_dq_rst_get_state() != 0)
  94   1          mmi_dq_ms_set_msg_que(QUE_EVENT_RST, QUE_PRO_LOW, 0);
  95   1      
  96   1        if (mmi_dq_sys_get_timer2_flag() != 0)
  97   1          mmi_dq_ms_set_msg_que(QUE_EVENT_TIMER_END, QUE_PRO_LOW, 0);
  98   1      
  99   1      #ifdef __LOCK_FP_SUPPORT__
 100   1        //check fp press
 101   1        if (mmi_dq_fp_work() != 0)
 102   1          mmi_dq_ms_set_msg_que(QUE_EVENT_FP, QUE_PRO_LOW, 0);
 103   1      #endif
 104   1      
 105   1        if (mmi_dq_sys_get_wifi_check_flag() != 0)
 106   1          mmi_dq_ms_set_msg_que(QUE_EVENT_WIFI_CHECK, QUE_PRO_LOW, 0);
 107   1      
 108   1        return;
 109   1      }
 110          
 111          /*
 112          parameter: 
 113            none
 114          return :
 115            none
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 3   

 116          */
 117          void mmi_sleep_task_proc(void)
 118          {
 119   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 120   1        unsigned char ret = 0xFF;
 121   1        static unsigned char time_count = 0;
 122   1      
 123   1        time_count++;
 124   1        if (time_count > 4)
 125   1        {
 126   2          time_count = 0;
 127   2          ret = mmi_dq_rfid_check();
 128   2        }
 129   1      #endif
 130   1      
 131   1        if (
 132   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 133   1          (ret == RET_SUCESS) ||
 134   1      #endif
 135   1          (mmi_dq_key_check() != 0) || (mmi_dq_rst_get_pin() != 0)
 136   1      #ifdef __LOCK_FP_SUPPORT__
 137   1          || (mmi_dq_fp_get_pin() == 1)
 138   1      #endif
 139   1        )
 140   1        {
 141   2          key_last_value = mmi_dq_get_key_map(dqiot_drv_get_touch_value());
 142   2          mmi_dq_sys_wake_up();
 143   2        }
 144   1      
 145   1        //if(mmi_dq_sys_get_wifi_check_flag() != 0)
 146   1        //  mmi_dq_ms_set_msg_que(QUE_EVENT_WIFI_CHECK,QUE_PRO_LOW,0);
 147   1        return;
 148   1      }
 149          
 150          /*
 151          parameter: 
 152            none
 153          return :
 154            none
 155          */
 156          void mmi_wait_sleep_task_proc(void)
 157          {
 158   1        //unsigned int timer1_count = 0;
 159   1        if (mmi_dq_wifi_get_running_flag() == 1)
 160   1          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 161   1        //if((mmi_dq_rfid_check() == RET_SUCESS) || (mmi_dq_key_check() != 0) || (mmi_dq_rst_get_pin() == 0))
 162   1        else if (mmi_dq_ms_get_run_flag() == 0)
 163   1        {
 164   2          mmi_dq_sys_enter_sleep();
 165   2        }
 166   1      
 167   1        return;
 168   1      }
 169          
 170          /*
 171          parameter: 
 172            none
 173          return :
 174            none
 175          */
 176          unsigned char mmi_dq_ms_get_run_flag(void)
 177          {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 4   

 178   1        if ((key_last_value == KEY_INVALID) && (mmi_dq_aud_get_state() == 0) && (mmi_dq_rst_get_pin() == 0)
 179   1      #ifdef __LOCK_FP_SUPPORT__
 180   1          && (mmi_dq_fp_get_pin() != 1)
 181   1      #endif
 182   1      #ifdef __LOCK_RFID_CARD_SUPPORT__
 183   1          && rfid_last_flag == 0
 184   1      #endif
 185   1        )
 186   1          return 0;
 187   1      
 188   1        return 1;
 189   1      }
 190          
 191          /*
 192          parameter: 
 193            none
 194          return :
 195            none
 196          */
 197          void mmi_dq_ms_sys_msg_handle(void)
 198          {
 199   1        Sys_MSG_Queue_M sys_msg_que;
 200   1        if (mmi_OutQueue(&sys_msg_que))
 201   1        {
 202   2          mmi_dq_sys_sleep_timer_reset();
 203   2          switch (sys_msg_que.que_event)
 204   2          {
 205   3          case QUE_EVENT_KEY:
 206   3            mmi_ms_pwd_opt_fun(sys_msg_que.que_data);
 207   3            break;
 208   3      #ifdef __LOCK_FP_SUPPORT__
 209   3          case QUE_EVENT_FP:
 210   3            mmi_ms_fps_opt_fun(sys_msg_que.que_data);
 211   3            break;
 212   3      #endif
 213   3      #ifdef __LOCK_RFID_CARD_SUPPORT__
 214   3          case QUE_EVENT_RFID:
 215   3            mmi_ms_rfid_opt_fun(sys_msg_que.que_data);
 216   3            break;
 217   3      #endif
 218   3          case QUE_EVENT_RST:
 219   3            mmi_ms_reset_opt_fun();
 220   3            break;
 221   3          case QUE_EVENT_AUDIO_END:
 222   3      
 223   3            break;
 224   3          case QUE_EVENT_TIMER_END:
 225   3            mmi_dq_sys_delay_event_pro();
 226   3            break;
 227   3          case QUE_EVENT_WIFI_CHECK:
 228   3            mmi_ms_wifi_opt_fun();
 229   3            break;
 230   3          default:
 231   3            break;
 232   3          }
 233   2        }
 234   1      }
 235          
 236          /*
 237          parameter: 
 238            none
 239          return :
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 5   

 240            none
 241          */
 242          void mmi_dq_ms_set_msg_que(SYS_QUEUE_EVENT q_event, SYS_QUEUE_PRO q_pro, unsigned char q_data)
 243          {
 244   1        Sys_MSG_Queue_M que;
 245   1        que.que_event = q_event;
 246   1        que.que_pro = q_pro;
 247   1        que.que_data = q_data;
 248   1        //printf("mmi_dq_ms_set_msg_que  event : %d",q_event);
 249   1        mmi_InQueue(que);
 250   1        return;
 251   1      }
 252          
 253          /*
 254          parameter: 
 255            none
 256          return :
 257            none
 258          */
 259          void mmi_dq_ms_set_sys_state(SYS_BASE_STATUS state)
 260          {
 261   1        sys_state = state;
 262   1        return;
 263   1      }
 264          
 265          /*
 266          parameter: 
 267            none
 268          return :
 269            none
 270          */
 271          SYS_BASE_STATUS mmi_dq_ms_get_sys_state(void)
 272          {
 273   1        return sys_state;
 274   1      }
 275          
 276          /*
 277          parameter: 
 278            none
 279          return :
 280            none
 281          */
 282          void mmi_ms_pwd_init_var(void)
 283          {
 284   1        key_len = 0;
 285   1        opt_time = OPT_ONE_TIME;
 286   1        memset(input_key_1, 0xFF, sizeof(input_key_1));
 287   1        memset(input_key_2, 0xFF, sizeof(input_key_2));
 288   1      }
 289          
 290          /*
 291          parameter: 
 292            none
 293          return :
 294            none
 295          */
 296          void mmi_ms_opt_time_init(void)
 297          {
 298   1        opt_time = OPT_ONE_TIME;
 299   1      }
 300          
 301          /*
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 6   

 302          parameter: 
 303            none
 304          return :
 305            none
 306          */
 307          void mmi_ms_pwd_opt_fun(unsigned char key_val)
 308          {
 309   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
 310   1        //printf("mmi_ms_pwd_opt_fun status: 0x%x  key: %d",status,key_val);
 311   1        switch (status)
 312   1        {
 313   2        case SYS_STATUS_WAIT_FOR_ENTER_SLEEP:
 314   2          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 315   2          status = SYS_STATUS_IDLE;
 316   2        case SYS_STATUS_INPUT_PWD:
 317   2        case SYS_STATUS_INPUT_ADMIN_PWD:
 318   2        case SYS_STATUS_ADD_PWD:
 319   2        case SYS_STATUS_DEL_PWD:
 320   2        case SYS_STATUS_ADD_ADMIN_PWD:
 321   2        case SYS_STATUS_CHG_ADMIN_PWD:
 322   2      #ifdef __LOCK_110_SUPPORT__
 323   2        case SYS_STATUS_ADD_110_PWD:
 324   2      #endif
 325   2          if (mmi_dq_sys_door_state_check() == 1)
 326   2          {
 327   3            mmi_dq_aud_stop();
 328   3            mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
 329   3            mmi_dq_wifi_pw_alarm();
 330   3            return;
 331   3          }
 332   2          if (key_len == 0)
 333   2          {
 334   3            if (key_val == KEY_S)
 335   3            {
 336   4              if (SYS_STATUS_ADD_ADMIN_PWD != status)
 337   4              {
 338   5                mmi_dq_aud_play_key_tone();
 339   5                if (status == SYS_STATUS_INPUT_PWD)
 340   5                  //mmi_dq_sys_enter_sleep();
 341   5                  mmi_dq_ms_set_sys_state(SYS_STATUS_WAIT_FOR_ENTER_SLEEP);
 342   5                else if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 343   5                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 344   5                else if (wifi_add_flag != 0)
 345   5                {
 346   6                  wifi_add_flag = 0;
 347   6                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 348   6                }
 349   5                else
 350   5                  mmi_dq_sys_show_cur_menu_list();
 351   5              }
 352   4              break;
 353   4            }
 354   3            else if (key_val == KEY_H)
 355   3            {
 356   4              if (status == SYS_STATUS_INPUT_PWD)
 357   4              {
 358   5                mmi_dq_aud_play_key_tone();
 359   5                admin_check_type = 0;
 360   5                mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD);
 361   5                mmi_dq_ms_set_sys_state(SYS_STATUS_INPUT_ADMIN_PWD);
 362   5              }
 363   4              break;
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 7   

 364   4            }
 365   3          }
 366   2      
 367   2          // mmi_dq_aud_play_key_num(key_val);
 368   2          mmi_dq_aud_play_key_tone();
 369   2          //input pwd
 370   2          if ((key_val >= KEY_0 && key_val <= KEY_9) && key_len < KEY_INPUT_MAX_LEN)
 371   2          {
 372   3            if ((status == SYS_STATUS_INPUT_PWD) || (status == SYS_STATUS_INPUT_ADMIN_PWD))
 373   3              input_key_1[key_len++] = key_val;
 374   3            else // if((status == SYS_STATUS_ADD_PWD)||(status == SYS_STATUS_ADD_110_PWD)||(status == SYS_STATUS_AD
             -D_ADMIN_PWD))
 375   3            {
 376   4              if (opt_time == OPT_ONE_TIME)
 377   4              {
 378   5                input_key_1[key_len++] = key_val;
 379   5              }
 380   4              else if (opt_time == OPT_TWO_TIME)
 381   4              {
 382   5                input_key_2[key_len++] = key_val;
 383   5              }
 384   4            }
 385   3          }
 386   2      
 387   2          if (key_val == KEY_S)
 388   2          {
 389   3            if (opt_time == OPT_ONE_TIME)
 390   3              input_key_1[key_len--] = 0xFF;
 391   3            else if (opt_time == OPT_TWO_TIME)
 392   3              input_key_2[key_len--] = 0xFF;
 393   3      
 394   3            if (key_len == 0)
 395   3            {
 396   4              if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 397   4                mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD);
 398   4              else if (opt_time == OPT_ONE_TIME)
 399   4              {
 400   5                if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 401   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_68_PWD);
 402   5                else if (status == SYS_STATUS_DEL_PWD)
 403   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_NUM);
 404   5                else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 405   5                  mmi_dq_aud_play_with_id(AUD_ID_ADD_ADMIN_PWD_FIRST);
 406   5                else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 407   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD);
 408   5              }
 409   4              else if (opt_time == OPT_TWO_TIME)
 410   4              {
 411   5                if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 412   5                  mmi_dq_aud_play_with_id(AUD_ID_PWD_INPUT_AGAIN);
 413   5                else if (status == SYS_STATUS_DEL_PWD)
 414   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_PWD_AGAIN);
 415   5                else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 416   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD_INIT_AGAIN);
 417   5                else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 418   5                  mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD_AGAIN);
 419   5              }
 420   4            }
 421   3          }
 422   2          else if ((key_val == KEY_H) || (key_len == PWD_INPUT_MAX_LEN))
 423   2          {
 424   3            if (key_len < PWD_INPUT_MIN_LEN)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 8   

 425   3            {
 426   4              if (status == SYS_STATUS_INPUT_PWD)
 427   4              {
 428   5                if (key_len == 1 && input_key_1[0] == KEY_5) //5 æ·»åŠ åˆ é™¤å¯†ç /æŒ‡çº¹/RFå¡
 429   5                  mmi_dq_wifi_cmd_add_del();
 430   5                else if (key_len == 1 && input_key_1[0] == KEY_6) //6 è®¾ç½®æ‹ç…§/å½•åƒå¼€å…³
 431   5                  mmi_dq_wifi_pv_switch();
 432   5                else if (key_len == 2 && input_key_1[0] == KEY_0 && input_key_1[1] == KEY_3) //03 è¿œç¨‹å¼€é—¨
 433   5                  mmi_dq_sys_wifi_open();
 434   5                else if (key_len == 2 && input_key_1[0] == KEY_1 && input_key_1[1] == KEY_8) //18 åº”æ€¥é’¥åŒ™å¼€é—¨æ
             -ˆåŠŸ
 435   5                  mmi_dq_wifi_open_by_key();
 436   5                else if (key_len == 2 && input_key_1[0] == KEY_1 && input_key_1[1] == KEY_9) //19 é—¨æœªå…³
 437   5                  mmi_dq_wifi_close_over_time();
 438   5                else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_0) //20 éœ‡åŠ¨æŠ¥è­¦
 439   5                  mmi_dq_wifi_via_alarm();
 440   5                else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_5) //25 ç¡çœ 
 441   5                  mmi_dq_wifi_sleep();
 442   5                else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_6) //26 å”¤é†’
 443   5                  mmi_dq_wifi_wakeup();
 444   5                else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_7) //27 æ‹ç…§
 445   5                  mmi_dq_wifi_take_photos();
 446   5                else if (key_len == 2 && input_key_1[0] == KEY_2 && input_key_1[1] == KEY_8) //28 å½•åƒ
 447   5                  mmi_dq_wifi_take_videos();
 448   5                else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_0) //30 æŸ¥è¯¢ç½‘ç»œçŠ¶æ€
 449   5                  mmi_dq_wifi_check_net();
 450   5                else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_1) //31 Airkissé…ç½‘(admin
             - 8)
 451   5                  mmi_dq_wifi_arikiss_con();
 452   5                else if (key_len == 2 && input_key_1[0] == KEY_3 && input_key_1[1] == KEY_2) //32 äºŒç»´ç é…ç½‘(adm
             -in 9)
 453   5                  mmi_dq_wifi_code_con();
 454   5      
 455   5      #ifdef __LOCK_BUS_SUPPORT__
 456   5                else if (key_len == 2 && input_key_1[0] == KEY_0 && input_key_1[1] == KEY_1) //01
 457   5                {
 458   6                  if (mmi_dq_fs_get_business_flag() == 1)
 459   6                  {
 460   7                    admin_check_type = 1;
 461   7                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD);
 462   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_INPUT_ADMIN_PWD);
 463   7                  }
 464   6                  else
 465   6                  {
 466   7                    mmi_dq_fs_set_business_flag(1);
 467   7                    mmi_dq_aud_play_with_id(AUD_ID_OUT_OPEN);
 468   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 469   7                  }
 470   6                }
 471   5      #endif
 472   5                else
 473   5                {
 474   6                  mmi_dq_sys_door_open_fail(SYS_OPEN_BY_PASSWORD);
 475   6                }
 476   5                key_len = 0;
 477   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 478   5              }
 479   4              else
 480   4              {
 481   5                mmi_dq_aud_play_with_id(AUD_ID_PWD_68_LEN);
 482   5                key_len = 0;
 483   5                if (opt_time == OPT_ONE_TIME)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 9   

 484   5                  memset(input_key_1, 0xFF, sizeof(input_key_1));
 485   5                else if (opt_time == OPT_TWO_TIME)
 486   5                  memset(input_key_2, 0xFF, sizeof(input_key_2));
 487   5              }
 488   4            }
 489   3            else
 490   3            {
 491   4              if (status == SYS_STATUS_INPUT_PWD)
 492   4              {
 493   5                //if(mmi_dq_fs_check_input_pwd(input_key_1,key_len,FDS_USE_TYPE_ALL) == 0xFF)
 494   5                unsigned char ret = 0;
 495   5                ret = mmi_dq_fs_check_input_pwd_for_open(input_key_1, key_len);
 496   5                //printf("check input ret: %d",(unsigned int)ret);
 497   5                if (ret == 0xFF)
 498   5                  mmi_dq_sys_door_open_fail(SYS_OPEN_BY_PASSWORD);
 499   5      #ifdef __LOCK_BUS_SUPPORT__
 500   5                else if (ret == 0xFE && mmi_dq_fs_get_business_flag() == 1)
 501   5                {
 502   6                  mmi_dq_fs_set_business_flag(0);
 503   6                  mmi_dq_aud_play_with_id(AUD_ID_OUT_CLOSED);
 504   6                  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 505   6                }
 506   5      #endif
 507   5      #ifdef __LOCK_110_SUPPORT__
 508   5                else if (ret == 1)
 509   5                  mmi_dq_sys_door_open(SYS_OPEN_BY_110_PASSWORD);
 510   5      #endif
 511   5                else
 512   5                  mmi_dq_sys_door_open(SYS_OPEN_BY_PASSWORD);
 513   5                key_len = 0;
 514   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 515   5              }
 516   4              else if (status == SYS_STATUS_INPUT_ADMIN_PWD)
 517   4              {
 518   5                if (mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == 0xFF)
 519   5                  mmi_dq_aud_play_with_id(AUD_ID_PWD_WRONG_TRY);
 520   5                else
 521   5                {
 522   6      #ifdef __LOCK_BUS_SUPPORT__
 523   6                  if (admin_check_type == 1)
 524   6                  {
 525   7                    mmi_dq_fs_set_business_flag(0);
 526   7                    mmi_dq_aud_play_with_id(AUD_ID_OUT_CLOSED);
 527   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 528   7                  }
 529   6                  else
 530   6      #endif
 531   6                  {
 532   7                    mmi_dq_sys_set_menu_father_id(STR_ID_SYSTEM);
 533   7                    mmi_dq_sys_show_cur_menu_list();
 534   7                  }
 535   6                }
 536   5                key_len = 0;
 537   5                memset(input_key_1, 0xFF, sizeof(input_key_1));
 538   5              }
 539   4              else // if((status == SYS_STATUS_ADD_PWD)||(status == SYS_STATUS_DEL_PWD)||(status == SYS_STATUS_ADD_A
             -DMIN_PWD)||(status == SYS_STATUS_CHG_ADMIN_PWD)||(status == SYS_STATUS_ADD_110_PWD))
 540   4              {
 541   5                if (opt_time == OPT_ONE_TIME)
 542   5                {
 543   6                  if (status == SYS_STATUS_ADD_PWD || status == SYS_STATUS_ADD_110_PWD)
 544   6                    mmi_dq_aud_play_with_id(AUD_ID_PWD_INPUT_AGAIN);
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 10  

 545   6                  else if (status == SYS_STATUS_DEL_PWD)
 546   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_DEL_PWD_AGAIN);
 547   6                  else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 548   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_ADMIN_PWD_INIT_AGAIN);
 549   6                  else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 550   6                    mmi_dq_aud_play_with_id(AUD_ID_INPUT_NEW_ADMIN_PWD_AGAIN);
 551   6      
 552   6                  opt_time = OPT_TWO_TIME;
 553   6                  key_len = 0;
 554   6                  memset(input_key_2, 0xFF, sizeof(input_key_2));
 555   6                }
 556   5                else if (opt_time == OPT_TWO_TIME)
 557   5                {
 558   6                  if (0 == memcmp(input_key_1, input_key_2, PWD_INPUT_MAX_LEN))
 559   6                  {
 560   7                    if (status == SYS_STATUS_DEL_PWD)
 561   7                    {
 562   8                      unsigned char del_index = mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_USER);
 563   8                      if (del_index == 0xFF)
 564   8                        mmi_dq_aud_play_with_id(AUD_ID_PWD_NOT_EXIST);
 565   8                      else
 566   8                      {
 567   9                        if (mmi_dq_fs_del_pwd(del_index, FDS_USE_TYPE_USER) == RET_SUCESS)
 568   9                        {
 569  10                          get_index = del_index;
 570  10                          mmi_dq_aud_play_with_id(AUD_ID_DEL_PWD_SUCESS);
 571  10                          mmi_dq_wifi_del_password(get_index);
 572  10                          // printfV("get_index", (int)get_index);
 573  10                        }
 574   9                        else
 575   9                          mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL);
 576   9                        mmi_dq_sys_del_pwd_con();
 577   9                      }
 578   8                    }
 579   7                    else if (mmi_dq_fs_check_input_pwd(input_key_1, key_len, FDS_USE_TYPE_ALL) != 0xFF)
 580   7                      mmi_dq_aud_play_with_id(AUD_ID_PWD_EXIST);
 581   7                    else
 582   7                    {
 583   8                      if (status == SYS_STATUS_ADD_PWD)
 584   8                      {
 585   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_USER) == RET_FAIL)
 586   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
 587   9                        else
 588   9                        {
 589  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_PWD_SUCESS);
 590  10                          mmi_dq_wifi_add_password(get_index);
 591  10                          // printfV("get_index", (int)get_index);
 592  10                        }
 593   9                        if (wifi_add_flag == 0)
 594   9                          mmi_dq_sys_add_pwd_con();
 595   9                        else
 596   9                        {
 597  10                          wifi_add_flag = 0;
 598  10                          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 599  10                        }
 600   9                      }
 601   8                      else if (status == SYS_STATUS_ADD_ADMIN_PWD)
 602   8                      {
 603   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == RET_FAIL)
 604   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
 605   9                        else
 606   9                        {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 11  

 607  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_ADMIN_PWD_INIT_SUCESS);
 608  10                          mmi_dq_wifi_add_password(get_index);
 609  10                          // printfV("get_index", (int)get_index);
 610  10                        }
 611   9      #ifdef __LOCK_FP_SUPPORT__
 612   9                        mmi_dq_sys_chg_admin_fp_No1();
 613   9      #endif
 614   9                        // mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 615   9                      }
 616   8                      else if (status == SYS_STATUS_CHG_ADMIN_PWD)
 617   8                      {
 618   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_ADMIN) == RET_FAIL)
 619   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
 620   9                        else
 621   9                        {
 622  10                          mmi_dq_aud_play_with_id(AUD_ID_CHG_ADMIN_PWD_SUCESS);
 623  10                          mmi_dq_wifi_add_password(get_index);
 624  10                          // printfV("get_index", (int)get_index);
 625  10                        }
 626   9                        mmi_dq_sys_show_cur_menu_list();
 627   9                      }
 628   8      #ifdef __LOCK_110_SUPPORT__
 629   8                      else if (status == SYS_STATUS_ADD_110_PWD)
 630   8                      {
 631   9                        if (mmi_dq_fs_set_pwd(input_key_1, key_len, FDS_USE_TYPE_110) == RET_FAIL)
 632   9                          mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
 633   9                        else
 634   9                        {
 635  10      #ifdef __LOCK_WIFI_SUPPORT__
 636  10                          mmi_dq_wifi_set_110();
 637  10      #endif
 638  10                          mmi_dq_aud_play_with_id(AUD_ID_ADD_PWD_SUCESS);
 639  10                          mmi_dq_wifi_add_password(get_index);
 640  10                          // printfV("get_index", (int)get_index);
 641  10                        }
 642   9                        mmi_dq_sys_show_cur_menu_list();
 643   9                      }
 644   8      #endif
 645   8                    }
 646   7                  }
 647   6                  else
 648   6                  {
 649   7                    mmi_dq_aud_play_with_id(AUD_ID_PWD_NOT_SAME_RETRY);
 650   7                  }
 651   6                  mmi_ms_pwd_init_var();
 652   6                }
 653   5              }
 654   4            }
 655   3            return;
 656   3          }
 657   2          break;
 658   2      #ifdef __LOCK_FP_SUPPORT__
 659   2        case SYS_STATUS_ADD_FP:
 660   2        case SYS_STATUS_DEL_FP:
 661   2      #ifdef __LOCK_110_SUPPORT__
 662   2        case SYS_STATUS_ADD_110_FP:
 663   2        case SYS_STATUS_DEL_110_FP:
 664   2      #endif
 665   2      #endif
 666   2      #ifdef __LOCK_RFID_CARD_SUPPORT__
 667   2        case SYS_STATUS_ADD_RFID:
 668   2        case SYS_STATUS_DEL_RFID:
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 12  

 669   2      #endif
 670   2          if (key_val == KEY_S)
 671   2          {
 672   3            mmi_dq_aud_play_key_tone();
 673   3            if (wifi_add_flag != 0)
 674   3            {
 675   4              wifi_add_flag = 0;
 676   4              mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 677   4            }
 678   3            else
 679   3              mmi_dq_sys_show_cur_menu_list();
 680   3          }
 681   2          break;
 682   2      #ifdef __LOCK_FP_SUPPORT__
 683   2        case SYS_STATUS_ADD_ADMIN_FP1:
 684   2        case SYS_STATUS_ADD_ADMIN_FP2:
 685   2          if (key_val == KEY_S)
 686   2          {
 687   3            mmi_dq_aud_play_key_tone();
 688   3            if (0 == mmi_dq_fs_get_admin_status())
 689   3              mmi_dq_sys_lock_add_admin_suc();
 690   3            else
 691   3              mmi_dq_sys_show_cur_menu_list();
 692   3          }
 693   2          break;
 694   2      #endif
 695   2        case SYS_STATUS_CLR_PWD:
 696   2        case SYS_STATUS_ADD_PWD_CON:
 697   2        case SYS_STATUS_DEL_PWD_CON:
 698   2      #ifdef __LOCK_FP_SUPPORT__
 699   2        case SYS_STATUS_CLR_FP:
 700   2        case SYS_STATUS_ADD_FP_CON:
 701   2        case SYS_STATUS_DEL_FP_CON:
 702   2      #endif
 703   2      #ifdef __LOCK_RFID_CARD_SUPPORT__
 704   2        case SYS_STATUS_CLR_RFID:
 705   2        case SYS_STATUS_ADD_RFID_CON:
 706   2        case SYS_STATUS_DEL_RFID_CON:
 707   2      #endif
 708   2        case SYS_STATUS_RESTORE_LOCK_CON:
 709   2          if (key_val == KEY_H)
 710   2          {
 711   3            mmi_dq_aud_play_key_tone();
 712   3            switch (status)
 713   3            {
 714   4            case SYS_STATUS_CLR_PWD:
 715   4              if (RET_SUCESS == mmi_dq_fs_clr_pwd())
 716   4              {
 717   5                mmi_dq_aud_play_with_id(AUD_ID_CLR_PWD_SUCESS);
 718   5                mmi_dq_wifi_clr_pwd_suc();
 719   5              }
 720   4              else
 721   4                mmi_dq_aud_play_with_id(AUD_ID_CLR_PWD_FAIL);
 722   4              mmi_dq_sys_show_cur_menu_list();
 723   4              break;
 724   4      #ifdef __LOCK_FP_SUPPORT__
 725   4            case SYS_STATUS_CLR_FP:
 726   4              if (RET_SUCESS == mmi_dq_fs_clr_fp())
 727   4              {
 728   5                mmi_dq_aud_play_with_id(AUD_ID_CLR_FP_SUCESS);
 729   5                mmi_dq_wifi_clr_fps_suc();
 730   5              }
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 13  

 731   4              else
 732   4                mmi_dq_aud_play_with_id(AUD_ID_CLR_FP_FAIL);
 733   4              mmi_dq_sys_show_cur_menu_list();
 734   4              break;
 735   4      #endif
 736   4      #ifdef __LOCK_RFID_CARD_SUPPORT__
 737   4            case SYS_STATUS_CLR_RFID:
 738   4              if (RET_SUCESS == mmi_dq_fs_clr_rfid())
 739   4              {
 740   5                mmi_dq_aud_play_with_id(AUD_ID_CLR_RFCARD_SUCESS);
 741   5                mmi_dq_wifi_clr_rfid_suc();
 742   5              }
 743   4              else
 744   4                mmi_dq_aud_play_with_id(AUD_ID_CLR_RFCARD_FAIL);
 745   4              mmi_dq_sys_show_cur_menu_list();
 746   4              break;
 747   4      #endif
 748   4            case SYS_STATUS_ADD_PWD_CON:
 749   4              mmi_dq_sys_add_pwd();
 750   4              break;
 751   4            case SYS_STATUS_DEL_PWD_CON:
 752   4              mmi_dq_sys_del_pwd();
 753   4              break;
 754   4      #ifdef __LOCK_FP_SUPPORT__
 755   4            case SYS_STATUS_ADD_FP_CON:
 756   4              mmi_dq_sys_add_fp();
 757   4              break;
 758   4            case SYS_STATUS_DEL_FP_CON:
 759   4              mmi_dq_sys_del_fp();
 760   4              break;
 761   4      #endif
 762   4      #ifdef __LOCK_RFID_CARD_SUPPORT__
 763   4            case SYS_STATUS_ADD_RFID_CON:
 764   4              mmi_dq_sys_add_rf();
 765   4              break;
 766   4            case SYS_STATUS_DEL_RFID_CON:
 767   4              mmi_dq_sys_del_rf();
 768   4              break;
 769   4      #endif
 770   4            case SYS_STATUS_RESTORE_LOCK_CON:
 771   4              mmi_dq_sys_restore_lock();
 772   4              break;
 773   4            }
 774   3          }
 775   2          else if (key_val == KEY_S)
 776   2          {
 777   3            mmi_dq_aud_play_key_tone();
 778   3            mmi_dq_sys_show_cur_menu_list();
 779   3          }
 780   2          break;
 781   2        case SYS_STATUS_SYS_MENU:
 782   2          if (key_val == KEY_S)
 783   2          {
 784   3            mmi_dq_aud_play_key_tone();
 785   3            mmi_dq_sys_get_pre_menu_list();
 786   3          }
 787   2          else if (key_val != KEY_0 && key_val <= mmi_dq_sys_get_menu_count())
 788   2          {
 789   3            mmi_dq_aud_play_key_tone();
 790   3            mmi_dq_sys_exe_menu_fun(key_val - 1);
 791   3          }
 792   2          break;
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 14  

 793   2      #ifdef __FACTORY_TEST_SUPPORT__
 794   2        case SYS_STATUS_FM_MODE:
 795   2        {
 796   3          unsigned char str = mmi_dq_factory_mode_get_test_project();
 797   3          if (str == STR_ID_KEY)
 798   3          {
 799   4            // mmi_dq_aud_play_key_num(key_val);
 800   4            mmi_dq_aud_play_key_tone();
 801   4            mmi_dq_factory_mode_key_test(key_val);
 802   4          }
 803   3          else if (str == STR_ID_MOTO)
 804   3          {
 805   4            if (key_val == KEY_S)
 806   4            {
 807   5              mmi_dq_aud_play_key_tone();
 808   5              mmi_dq_factory_mode_motor_test_back();
 809   5              if (mmi_dq_fs_get_factory_flag() != 0)
 810   5                mmi_dq_factory_mode_test_stop();
 811   5              else
 812   5              {
 813   6                delay_ms(600);
 814   6                mmi_dq_factory_mode_motor_test();
 815   6              }
 816   5            }
 817   4            else if (key_val == KEY_H)
 818   4            {
 819   5              mmi_dq_aud_play_key_tone();
 820   5              mmi_dq_factory_mode_motor_test_back();
 821   5              mmi_dq_factory_mode_test_item_result(STR_ID_MOTO, 1);
 822   5            }
 823   4          }
 824   3          else if (mmi_dq_fs_get_factory_flag() != 0)
 825   3          {
 826   4            mmi_dq_aud_play_key_tone();
 827   4            mmi_dq_factory_mode_test_stop();
 828   4          }
 829   3        }
 830   2        break;
 831   2      #endif
 832   2        case SYS_STATUS_WIFI_MODE:
 833   2          //if(key_val == KEY_S)
 834   2          //{
 835   2          mmi_dq_aud_stop();
 836   2          mmi_dq_aud_play_with_id(AUD_ID_WIFI_CONNECTING);
 837   2          //  mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 838   2          //}
 839   2          break;
 840   2        case SYS_STATUS_LOW_POWER:
 841   2          mmi_dq_aud_stop();
 842   2          mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
 843   2          mmi_dq_wifi_lowpower_alarm();
 844   2          break;
 845   2        default:
 846   2          break;
 847   2        }
 848   1        return;
 849   1      }
 850          
 851          #ifdef __LOCK_FP_SUPPORT__
 852          /*
 853          parameter: 
 854            none
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 15  

 855          return :
 856            none
 857          */
 858          void mmi_ms_fps_opt_fun(unsigned char fps_val)
 859          {
 860   1        RET_VAL retval = 0;
 861   1        unsigned short index = 0;
 862   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
 863   1        if (status == SYS_STATUS_LOW_POWER)
 864   1        {
 865   2          mmi_dq_aud_stop();
 866   2          mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
 867   2          mmi_dq_wifi_lowpower_alarm();
 868   2          return;
 869   2        }
 870   1        else if (status == SYS_STATUS_WAIT_FOR_ENTER_SLEEP)
 871   1          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
 872   1      
 873   1        if ((status != SYS_STATUS_INPUT_FP && status != SYS_STATUS_ADD_FP && status != SYS_STATUS_DEL_FP && statu
             -s != SYS_STATUS_ADD_ADMIN_FP1 && status != SYS_STATUS_ADD_ADMIN_FP2 && status != SYS_STATUS_ADD_110_FP && status != SYS_
             -STATUS_DEL_110_FP)
 874   1      #ifdef __FACTORY_TEST_SUPPORT__
 875   1          || (status == SYS_STATUS_FM_MODE && STR_ID_FINGERPRINT != mmi_dq_factory_mode_get_test_project())
 876   1      #endif
 877   1        )
 878   1          return;
 879   1      
 880   1      #ifdef __LOCK_AUDIO_SUPPORT__
 881   1        mmi_dq_aud_stop();
 882   1      #endif
 883   1        if (mmi_dq_sys_door_state_check() == 1)
 884   1        {
 885   2          mmi_dq_aud_stop();
 886   2          mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
 887   2          mmi_dq_wifi_fp_alarm();
 888   2          return;
 889   2        }
 890   1      
 891   1        retval = mmi_dq_fp_get_image();
 892   1      
 893   1        if (retval == 0)
 894   1        {
 895   2          // printfS("mmi_dq_fp_get_image", "ok");
 896   2          // if (opt_time != 0)
 897   2          //  retval = mmi_dq_fp_gen_char(0);
 898   2          // if (retval == 0)
 899   2          retval = mmi_dq_fp_gen_char(opt_time);
 900   2          if (retval == 0)
 901   2          {
 902   3            // printfS("mmi_dq_fp_gen_char", "ok");
 903   3            retval = mmi_dq_fp_high_speed_search(opt_time, &index);
 904   3            if (retval == 0)
 905   3            {
 906   4              // printfS("mmi_dq_fp_high_speed_search", "ok");
 907   4              if (status == SYS_STATUS_INPUT_FP)
 908   4              {
 909   5                retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_ALL);
 910   5                if (retval == RET_SUCESS)
 911   5                {
 912   6                  get_index = index;
 913   6                  mmi_dq_fp_light(FP_GREEN);
 914   6      #ifdef __LOCK_110_SUPPORT__
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 16  

 915   6                  if (mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_110) == RET_SUCESS)
 916   6                  {
 917   7                    mmi_dq_sys_door_open(SYS_OPEN_BY_110_FP);
 918   7                  }
 919   6                  else
 920   6      #endif
 921   6                    mmi_dq_sys_door_open(SYS_OPEN_BY_FP);
 922   6                }
 923   5                else
 924   5                {
 925   6                  mmi_dq_fp_light(FP_RED);
 926   6                  mmi_dq_sys_door_open_fail(SYS_OPEN_BY_FP);
 927   6                }
 928   5              }
 929   4              else if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_ADMIN_FP1 || status == SYS_STATUS_ADD
             -_ADMIN_FP2 || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
 930   4              {
 931   5                mmi_dq_fp_light(FP_RED);
 932   5                mmi_dq_aud_play_with_id(AUD_ID_FP_EXIST);
 933   5              }
 934   4              else if (status == SYS_STATUS_DEL_FP || status == SYS_STATUS_DEL_110_FP)
 935   4              {
 936   5      #ifdef __LOCK_110_SUPPORT__
 937   5                if (status == SYS_STATUS_DEL_FP)
 938   5                  retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_USER);
 939   5                else if (status == SYS_STATUS_DEL_110_FP)
 940   5                  retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_110);
 941   5      #else
                        retval = mmi_dq_fs_check_fp((unsigned char)index, FDS_USE_TYPE_USER);
              #endif
 944   5                if (retval == RET_SUCESS)
 945   5                {
 946   6                  static unsigned char del_num = 0;
 947   6                  if (opt_time == OPT_ONE_TIME)
 948   6                  {
 949   7                    opt_time = OPT_TWO_TIME;
 950   7                    del_num = index;
 951   7                    mmi_dq_fp_light(FP_GREEN);
 952   7                    mmi_dq_aud_play_with_id(AUD_ID_PRESS_DEL_FP_AGAIN);
 953   7                  }
 954   6                  else
 955   6                  {
 956   7                    //retval = mmi_dq_fp_match();
 957   7                    if (del_num == index)
 958   7                      retval = 0;
 959   7                    else
 960   7                      retval = 255;
 961   7                    if (retval == 0) //|| retval == 255)
 962   7                    {
 963   8      #ifdef __LOCK_110_SUPPORT__
 964   8                      if (status == SYS_STATUS_DEL_FP)
 965   8                        retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_USER);
 966   8                      else if (status == SYS_STATUS_DEL_110_FP)
 967   8                        retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_110);
 968   8      #else
                              retval = mmi_dq_fs_del_fp((unsigned char)index, FDS_USE_TYPE_USER);
              #endif
 971   8                      if (retval == RET_SUCESS)
 972   8                      {
 973   9                        retval = mmi_dq_fp_delete(index);
 974   9                      }
 975   8                      if (retval == 0)
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 17  

 976   8                      {
 977   9                        mmi_dq_fp_light(FP_GREEN);
 978   9                        mmi_dq_aud_play_with_id(AUD_ID_DEL_FP_SUCESS);
 979   9                        mmi_dq_wifi_del_fp(index);
 980   9                      }
 981   8                      else
 982   8                      {
 983   9                        mmi_dq_fp_light(FP_RED);
 984   9                        mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL);
 985   9                      }
 986   8      #ifdef __LOCK_110_SUPPORT__
 987   8                      if (status == SYS_STATUS_DEL_FP)
 988   8                        mmi_dq_sys_del_fp_con();
 989   8                      else if (status == SYS_STATUS_DEL_110_FP)
 990   8                        mmi_dq_sys_show_cur_menu_list();
 991   8      #else
                              mmi_dq_sys_del_fp_con();
              #endif
 994   8                    }
 995   7                    else
 996   7                    {
 997   8                      mmi_dq_fp_light(FP_RED);
 998   8                      mmi_dq_aud_play_with_id(AUD_ID_FP_TWICE_NOT_SAME_RETRY);
 999   8                    }
1000   7                    opt_time = OPT_ONE_TIME;
1001   7                  }
1002   6                }
1003   5                else
1004   5                {
1005   6                  mmi_dq_fp_light(FP_RED);
1006   6                  mmi_dq_aud_play_with_id(AUD_ID_FP_NOT_EXIST);
1007   6                }
1008   5              }
1009   4            }
1010   3            else
1011   3            {
1012   4              // printfS("mmi_dq_fp_high_speed_search", "error");
1013   4              if (status == SYS_STATUS_INPUT_FP)
1014   4              {
1015   5                mmi_dq_fp_light(FP_RED);
1016   5                //mmi_dq_aud_play_with_id(AUD_ID_FP_WRONG_TRY);
1017   5                mmi_dq_sys_door_open_fail(SYS_OPEN_BY_FP);
1018   5              }
1019   4              else if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_ADMIN_FP1 || status == SYS_STATUS_ADD
             -_ADMIN_FP2 || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
1020   4              {
1021   5                if (opt_time == FPS_MAX_INPUT_TIME)
1022   5                {
1023   6                  retval = mmi_dq_fp_reg_module();
1024   6                  if (retval == 0)
1025   6                  {
1026   7                    // printfS("mmi_dq_fp_reg_module", "ok");
1027   7                    if (status == SYS_STATUS_ADD_FP || status == SYS_STATUS_ADD_110_FP || status == SYS_STATUS_FM_MODE)
1028   7                    {
1029   8      #ifdef __LOCK_110_SUPPORT__
1030   8                      if (status == SYS_STATUS_ADD_110_FP)
1031   8                        index = mmi_dq_fs_get_fp_110_unuse_index();
1032   8                      else
1033   8      #endif
1034   8                        index = mmi_dq_fs_get_fp_unuse_index();
1035   8                      if (index == 0xFF)
1036   8                      {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 18  

1037   9                        // printfS("mmi_dq_fs_get_fp_unuse_index", "error");
1038   9                        mmi_dq_fp_light(FP_RED);
1039   9                        mmi_dq_aud_play_with_id(AUD_ID_FP_FULL);
1040   9                        mmi_dq_sys_show_cur_menu_list();
1041   9                      }
1042   8                      else
1043   8                      {
1044   9                        // printfS("mmi_dq_fs_get_fp_unuse_index", "ok");
1045   9                        // printfV("index", (int)index);
1046   9                        retval = mmi_dq_fp_store_char(0, index);
1047   9                        if (status == SYS_STATUS_ADD_FP)
1048   9                        {
1049  10                          if (retval == 0)
1050  10                          {
1051  11                            // printfS("mmi_dq_fp_store_char", "ok");
1052  11                            retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_USER);
1053  11                            if (retval != 0)
1054  11                              mmi_dq_fp_delete(index);
1055  11                          }
1056  10                          if (retval == 0)
1057  10                          {
1058  11                            // printfS("mmi_dq_fs_set_fp", "ok");
1059  11                            mmi_dq_fp_light(FP_GREEN);
1060  11                            mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
1061  11                            mmi_dq_wifi_add_fp(index);
1062  11                          }
1063  10                          else
1064  10                          {
1065  11                            // printfS("mmi_dq_fp_store_char", "error");
1066  11                            mmi_dq_fp_light(FP_RED);
1067  11                            mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
1068  11                          }
1069  10                          if (wifi_add_flag == 0)
1070  10                            mmi_dq_sys_add_fp_con();
1071  10                          else
1072  10                          {
1073  11                            wifi_add_flag = 0;
1074  11                            mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1075  11                          }
1076  10                        }
1077   9      #ifdef __LOCK_110_SUPPORT__
1078   9                        else if (status == SYS_STATUS_ADD_110_FP)
1079   9                        {
1080  10                          if (retval == 0)
1081  10                          {
1082  11                            retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_110);
1083  11                            if (retval != 0)
1084  11                              mmi_dq_fp_delete(index);
1085  11                          }
1086  10                          if (retval == 0)
1087  10                          {
1088  11                            mmi_dq_fp_light(FP_GREEN);
1089  11                            mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
1090  11                            mmi_dq_wifi_set_110();
1091  11                            mmi_dq_wifi_add_fp(index);
1092  11                          }
1093  10                          else
1094  10                          {
1095  11                            mmi_dq_fp_light(FP_RED);
1096  11                            mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
1097  11                          }
1098  10                          mmi_dq_sys_show_cur_menu_list();
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 19  

1099  10                        }
1100   9      #endif
1101   9      #ifdef __FACTORY_TEST_SUPPORT__
1102   9                        else
1103   9                        {
1104  10                          if (retval == 0)
1105  10                          {
1106  11                            retval = mmi_dq_fp_delete(index);
1107  11                          }
1108  10                          if (retval == 0)
1109  10                          {
1110  11                            mmi_dq_fp_light(FP_GREEN);
1111  11                            mmi_dq_factory_mode_test_item_result(STR_ID_FINGERPRINT, 1);
1112  11                          }
1113  10                          else
1114  10                          {
1115  11                            mmi_dq_fp_light(FP_RED);
1116  11                            mmi_dq_factory_mode_test_item_result(STR_ID_FINGERPRINT, 0);
1117  11                          }
1118  10                        }
1119   9      #endif
1120   9                      }
1121   8                    }
1122   7                    else
1123   7                    {
1124   8                      if (status == SYS_STATUS_ADD_ADMIN_FP1)
1125   8                        index = 0;
1126   8                      else if (status == SYS_STATUS_ADD_ADMIN_FP2)
1127   8                        index = 1;
1128   8                      retval = mmi_dq_fp_delete(index);
1129   8                      if (retval == 0)
1130   8                        retval = mmi_dq_fp_store_char(0, index);
1131   8                      if (retval == 0)
1132   8                        retval = mmi_dq_fs_set_fp((unsigned char)index, FDS_USE_TYPE_ADMIN);
1133   8                      if (retval == 0)
1134   8                      {
1135   9                        mmi_dq_fp_light(FP_GREEN);
1136   9                        mmi_dq_aud_play_with_id(AUD_ID_ADD_FP_SUCESS);
1137   9                        mmi_dq_wifi_add_fp(index);
1138   9                      }
1139   8                      else
1140   8                      {
1141   9                        mmi_dq_fp_light(FP_RED);
1142   9                        mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
1143   9                      }
1144   8                      if (0 == mmi_dq_fs_get_admin_status())
1145   8                      {
1146   9                        if (status == SYS_STATUS_ADD_ADMIN_FP1)
1147   9                          mmi_dq_sys_chg_admin_fp_No2();
1148   9                        else
1149   9                          mmi_dq_sys_lock_add_admin_suc();
1150   9                      }
1151   8                      else
1152   8                        mmi_dq_sys_show_cur_menu_list();
1153   8                    }
1154   7                  }
1155   6                  else
1156   6                  {
1157   7                    mmi_dq_fp_light(FP_RED);
1158   7                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL_RETRY);
1159   7                  }
1160   6                  opt_time = OPT_ONE_TIME;
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 20  

1161   6                }
1162   5                else
1163   5                {
1164   6                  opt_time++;
1165   6                  mmi_dq_fp_light(FP_GREEN);
1166   6                  mmi_dq_aud_play_with_id(AUD_ID_PRESS_FP_AGAIN);
1167   6                }
1168   5              }
1169   4              else if (status == SYS_STATUS_DEL_FP)
1170   4              {
1171   5                mmi_dq_fp_light(FP_RED);
1172   5                mmi_dq_aud_play_with_id(AUD_ID_FP_NOT_EXIST);
1173   5              }
1174   4            }
1175   3            return;
1176   3          }
1177   2        }
1178   1        // printfS("mmi_dq_fp_get_image", "error");
1179   1      
1180   1        mmi_dq_fp_light(FP_RED);
1181   1        mmi_dq_aud_play_with_id(AUD_ID_PRESS_FP_AGAIN);
1182   1        return;
1183   1      }
*** WARNING C280 IN LINE 858 OF mmi_src\mmi_ms.c: 'fps_val': unreferenced local variable
1184          #endif
1185          
1186          #ifdef __LOCK_RFID_CARD_SUPPORT__
1187          /*
1188          parameter: 
1189            none
1190          return :
1191            none
1192          */
1193          void mmi_ms_rfid_opt_fun(unsigned char rfid_val)
1194          {
1195   1        RET_VAL retval = RET_SUCESS;
1196   1        unsigned char index = 0;
1197   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
1198   1      
1199   1        if (status == SYS_STATUS_LOW_POWER)
1200   1        {
1201   2          mmi_dq_aud_stop();
1202   2          mmi_dq_aud_play_with_id(AUD_ID_LOW_BATTERY);
1203   2          mmi_dq_wifi_lowpower_alarm();
1204   2          return;
1205   2        }
1206   1        else if (status == SYS_STATUS_WAIT_FOR_ENTER_SLEEP)
1207   1          mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1208   1      
1209   1        if ((status != SYS_STATUS_INPUT_RFID && status != SYS_STATUS_ADD_RFID && status != SYS_STATUS_DEL_RFID)
1210   1      #ifdef __FACTORY_TEST_SUPPORT__
1211   1          || (status == SYS_STATUS_FM_MODE && STR_ID_RF_CARD != mmi_dq_factory_mode_get_test_project())
1212   1      #endif
1213   1        )
1214   1          return;
1215   1      
1216   1      #ifdef __LOCK_AUDIO_SUPPORT__
1217   1        mmi_dq_aud_stop();
1218   1      #endif
1219   1      
1220   1        if (mmi_dq_sys_door_state_check() == 1)
1221   1        {
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 21  

1222   2          mmi_dq_aud_play_with_id(AUD_ID_RONG_TIMES_EXCEED);
1223   2          mmi_dq_wifi_rfid_alarm();
1224   2          return;
1225   2        }
1226   1      #ifdef __FACTORY_TEST_SUPPORT__
1227   1        if (status == SYS_STATUS_FM_MODE)
1228   1        {
1229   2          retval = mmi_dq_rfid_gen_char(opt_time);
1230   2          if (retval == RET_SUCESS)
1231   2          {
1232   3            if (opt_time == OPT_ONE_TIME)
1233   3            {
1234   4              mmi_dq_aud_play_with_id(AUD_ID_PRESS_RFCARD_AGAIN);
1235   4              opt_time = OPT_TWO_TIME;
1236   4            }
1237   3            else
1238   3            {
1239   4              retval = mmi_dq_rfid_match();
1240   4              if (retval == RET_SUCESS)
1241   4      
1242   4                mmi_dq_factory_mode_test_item_result(STR_ID_RF_CARD, 1);
1243   4              else
1244   4                mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY);
1245   4              opt_time = OPT_ONE_TIME;
1246   4            }
1247   3          }
1248   2          return;
1249   2        }
1250   1      #endif
1251   1        retval = mmi_dq_rfid_search_by_temp(&index);
1252   1        if (retval == RET_SUCESS)
1253   1        {
1254   2          if (status == SYS_STATUS_INPUT_RFID)
1255   2          {
1256   3            mmi_dq_sys_door_open(SYS_OPEN_BY_RFID);
1257   3          }
1258   2          else if (status == SYS_STATUS_ADD_RFID)
1259   2          {
1260   3            mmi_dq_aud_play_with_id(AUD_ID_RFCARD_EXIST);
1261   3          }
1262   2          else if (status == SYS_STATUS_DEL_RFID)
1263   2          {
1264   3            retval = mmi_dq_rfid_gen_char(opt_time);
1265   3            if (retval == RET_SUCESS)
1266   3            {
1267   4              if (opt_time == OPT_ONE_TIME)
1268   4              {
1269   5                mmi_dq_aud_play_with_id(AUD_ID_PRESS_DEL_RFCARD_AGAIN);
1270   5                opt_time = OPT_TWO_TIME;
1271   5              }
1272   4              else
1273   4              {
1274   5                retval = mmi_dq_rfid_match();
1275   5                if (retval == RET_SUCESS)
1276   5                {
1277   6                  retval = mmi_dq_fs_del_rfid(index);
1278   6                  if (retval == RET_SUCESS)
1279   6                  {
1280   7                    get_index = index;
1281   7                    mmi_dq_aud_play_with_id(AUD_ID_DEL_RFCARD_SUCESS);
1282   7                    mmi_dq_wifi_del_rfid_suc(get_index);
1283   7                    // printfV("get_index", (int)get_index);
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 22  

1284   7                  }
1285   6                  else
1286   6                    mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL);
1287   6                  mmi_dq_sys_del_rf_con();
1288   6                }
1289   5                else
1290   5                  mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY);
1291   5                opt_time = OPT_ONE_TIME;
1292   5              }
1293   4            }
1294   3            else
1295   3              mmi_dq_aud_play_with_id(AUD_ID_DEL_FAIL_RETRY);
1296   3          }
1297   2        }
1298   1        else
1299   1        {
1300   2          if (status == SYS_STATUS_ADD_RFID)
1301   2          {
1302   3            retval = mmi_dq_rfid_gen_char(opt_time);
1303   3            if (retval == RET_SUCESS)
1304   3            {
1305   4              if (opt_time == OPT_ONE_TIME)
1306   4              {
1307   5                mmi_dq_aud_play_with_id(AUD_ID_PRESS_RFCARD_AGAIN);
1308   5                opt_time = OPT_TWO_TIME;
1309   5              }
1310   4              else
1311   4              {
1312   5                retval = mmi_dq_rfid_match();
1313   5                if (retval == RET_SUCESS)
1314   5                {
1315   6                  retval = mmi_dq_rfid_store(0);
1316   6                  if (retval == RET_SUCESS)
1317   6                  {
1318   7                    mmi_dq_aud_play_with_id(AUD_ID_ADD_RFCARD_SUCESS);
1319   7                    mmi_dq_wifi_add_rfid_suc(get_index);
1320   7                    // printfV("get_index", (int)get_index);
1321   7                  }
1322   6                  else
1323   6                    mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL);
1324   6                  if (wifi_add_flag == 0)
1325   6                    mmi_dq_sys_add_rf_con();
1326   6                  else
1327   6                  {
1328   7                    wifi_add_flag = 0;
1329   7                    mmi_dq_ms_set_sys_state(SYS_STATUS_IDLE);
1330   7                  }
1331   6                }
1332   5                else
1333   5                  mmi_dq_aud_play_with_id(AUD_ID_RFCARD_TWICE_NOT_SAME_RETRY);
1334   5                opt_time = OPT_ONE_TIME;
1335   5              }
1336   4            }
1337   3            else
1338   3              mmi_dq_aud_play_with_id(AUD_ID_ADD_FAIL_RETRY);
1339   3          }
1340   2          else if (status == SYS_STATUS_INPUT_RFID)
1341   2            mmi_dq_sys_door_open_fail(SYS_OPEN_BY_RFID);
1342   2          else
1343   2            mmi_dq_aud_play_with_id(AUD_ID_RFCARD_NOT_EXIST);
1344   2        }
1345   1      
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 23  

1346   1        return;
1347   1      }
*** WARNING C280 IN LINE 1193 OF mmi_src\mmi_ms.c: 'rfid_val': unreferenced local variable
1348          #endif
1349          
1350          /*
1351          parameter: 
1352            none
1353          return :
1354            none
1355          */
1356          void mmi_ms_reset_opt_fun(void)
1357          {
1358   1        SYS_BASE_STATUS status = mmi_dq_ms_get_sys_state();
1359   1      
1360   1        if (status == SYS_STATUS_FM_MODE && STR_ID_RESET == mmi_dq_factory_mode_get_test_project())
1361   1        {
1362   2          mmi_dq_factory_mode_reset_test();
1363   2          return;
1364   2        }
1365   1        else
1366   1        {
1367   2          if (RET_SUCESS == mmi_dq_fs_reset())
1368   2          {
1369   3            mmi_dq_aud_play_with_id(AUD_ID_RESTORE_SUCESS);
1370   3            mmi_dq_wifi_clr_pwd_suc();
1371   3            mmi_dq_wifi_clr_fps_suc();
1372   3            mmi_dq_wifi_clr_rfid_suc();
1373   3          }
1374   2          else
1375   2            mmi_dq_aud_play_with_id(AUD_BASE_ID_FAIL);
1376   2      
1377   2          mmi_dq_sys_add_admin_pwd();
1378   2        }
1379   1      }
1380          
1381          /*
1382          parameter: 
1383            none
1384          return :
1385            none
1386          */
1387          void mmi_ms_wifi_opt_fun(void)
1388          {
1389   1        unsigned char type = mmi_dq_sys_get_wifi_check_type();
1390   1        if (type == 0)
1391   1          mmi_dq_wifi_check_connect();
1392   1        else if (type == 1)
1393   1          mmi_dq_wifi_check_open();
1394   1      }
1395          
1396          #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4257    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     74      21
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
C51 COMPILER V9.59.0.0   MMI_MS                                                            04/07/2021 17:27:36 PAGE 24  

   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
